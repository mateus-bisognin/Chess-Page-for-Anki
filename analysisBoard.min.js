var LichessAnalyse=function(t){"use strict";const e={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createDocumentFragment:function(){return document.createDocumentFragment()},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType},isDocumentFragment:function(t){return 11===t.nodeType}};function n(t,e,n,o,r){return{sel:t,data:e,children:n,text:o,elm:r,key:void 0===e?void 0:e.key}}const o=Array.isArray;function r(t){return"string"==typeof t||"number"==typeof t||t instanceof String||t instanceof Number}function i(t){return void 0===t}function s(t){return void 0!==t}const a=n("",{},[],void 0,void 0);function c(t,e){var n,o;const r=t.key===e.key,i=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(o=e.data)||void 0===o?void 0:o.is);return t.sel===e.sel&&r&&i}function l(){throw new Error("The document fragment is not supported on this platform.")}function d(t,e,n){var o;const r={};for(let i=e;i<=n;++i){const e=null===(o=t[i])||void 0===o?void 0:o.key;void 0!==e&&(r[e]=i)}return r}const u=["create","update","remove","destroy","pre","post"];function h(t,h,p){const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==h?h:e;for(const e of u)for(const n of t){const t=n[e];void 0!==t&&m[e].push(t)}function g(t){const e=t.id?"#"+t.id:"",o=t.getAttribute("class"),r=o?"."+o.split(" ").join("."):"";return n(f.tagName(t).toLowerCase()+e+r,{},[],void 0,t)}function v(t){return n(void 0,{},[],void 0,t)}function b(t,e){return function(){if(0==--e){const e=f.parentNode(t);f.removeChild(e,t)}}}function y(t,e){var n,c,d,u;let h,g=t.data;if(void 0!==g){const e=null===(n=g.hook)||void 0===n?void 0:n.init;s(e)&&(e(t),g=t.data)}const v=t.children,b=t.sel;if("!"===b)i(t.text)&&(t.text=""),t.elm=f.createComment(t.text);else if(void 0!==b){const n=b.indexOf("#"),i=b.indexOf(".",n),l=n>0?n:b.length,d=i>0?i:b.length,u=-1!==n||-1!==i?b.slice(0,Math.min(l,d)):b,p=t.elm=s(g)&&s(h=g.ns)?f.createElementNS(h,u,g):f.createElement(u,g);for(l<d&&p.setAttribute("id",b.slice(l+1,d)),i>0&&p.setAttribute("class",b.slice(d+1).replace(/\./g," ")),h=0;h<m.create.length;++h)m.create[h](a,t);if(o(v))for(h=0;h<v.length;++h){const t=v[h];null!=t&&f.appendChild(p,y(t,e))}else r(t.text)&&f.appendChild(p,f.createTextNode(t.text));const w=t.data.hook;s(w)&&(null===(c=w.create)||void 0===c||c.call(w,a,t),w.insert&&e.push(t))}else if((null===(d=null==p?void 0:p.experimental)||void 0===d?void 0:d.fragments)&&t.children){const n=t.children;for(t.elm=(null!==(u=f.createDocumentFragment)&&void 0!==u?u:l)(),h=0;h<m.create.length;++h)m.create[h](a,t);for(h=0;h<n.length;++h){const o=n[h];null!=o&&f.appendChild(t.elm,y(o,e))}}else t.elm=f.createTextNode(t.text);return t.elm}function w(t,e,n,o,r,i){for(;o<=r;++o){const r=n[o];null!=r&&f.insertBefore(t,y(r,i),e)}}function k(t){var e,n;const o=t.data;if(void 0!==o){null===(n=null===(e=null==o?void 0:o.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<m.destroy.length;++e)m.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&k(n)}}}function C(t,e,n,o){for(var r,i;n<=o;++n){let o,a;const c=e[n];if(null!=c)if(s(c.sel)){k(c),o=m.remove.length+1,a=b(c.elm,o);for(let e=0;e<m.remove.length;++e)m.remove[e](c,a);const t=null===(i=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===i?void 0:i.remove;s(t)?t(c,a):a()}else f.removeChild(t,c.elm)}}function x(t,e,n){var o,r,a,l,u;const h=null===(o=e.data)||void 0===o?void 0:o.hook;null===(r=null==h?void 0:h.prepatch)||void 0===r||r.call(h,t,e);const p=e.elm=t.elm,g=t.children,v=e.children;if(t!==e){if(void 0!==e.data){for(let n=0;n<m.update.length;++n)m.update[n](t,e);null===(l=null===(a=e.data.hook)||void 0===a?void 0:a.update)||void 0===l||l.call(a,t,e)}i(e.text)?s(g)&&s(v)?g!==v&&function(t,e,n,o){let r,s,a,l,u=0,h=0,p=e.length-1,m=e[0],g=e[p],v=n.length-1,b=n[0],k=n[v];for(;u<=p&&h<=v;)null==m?m=e[++u]:null==g?g=e[--p]:null==b?b=n[++h]:null==k?k=n[--v]:c(m,b)?(x(m,b,o),m=e[++u],b=n[++h]):c(g,k)?(x(g,k,o),g=e[--p],k=n[--v]):c(m,k)?(x(m,k,o),f.insertBefore(t,m.elm,f.nextSibling(g.elm)),m=e[++u],k=n[--v]):c(g,b)?(x(g,b,o),f.insertBefore(t,g.elm,m.elm),g=e[--p],b=n[++h]):(void 0===r&&(r=d(e,u,p)),s=r[b.key],i(s)?f.insertBefore(t,y(b,o),m.elm):(a=e[s],a.sel!==b.sel?f.insertBefore(t,y(b,o),m.elm):(x(a,b,o),e[s]=void 0,f.insertBefore(t,a.elm,m.elm))),b=n[++h]);h<=v&&(l=null==n[v+1]?null:n[v+1].elm,w(t,l,n,h,v,o)),u<=p&&C(t,e,u,p)}(p,g,v,n):s(v)?(s(t.text)&&f.setTextContent(p,""),w(p,null,v,0,v.length-1,n)):s(g)?C(p,g,0,g.length-1):s(t.text)&&f.setTextContent(p,""):t.text!==e.text&&(s(g)&&C(p,g,0,g.length-1),f.setTextContent(p,e.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,t,e)}}return function(t,e){let n,o,r;const i=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(!function(t,e){return t.isElement(e)}(f,t)?function(t,e){return t.isDocumentFragment(e)}(f,t)&&(t=v(t)):t=g(t),c(t,e)?x(t,e,i):(o=t.elm,r=f.parentNode(o),y(e,i),null!==r&&(f.insertBefore(r,e.elm,f.nextSibling(o)),C(r,[t],0,0))),n=0;n<i.length;++n)i[n].data.hook.insert(i[n]);for(n=0;n<m.post.length;++n)m.post[n]();return e}}function p(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let o=0;o<e.length;++o){const t=e[o];if("string"==typeof t)continue;const n=t.data;void 0!==n&&p(n,t.children,t.sel)}}function m(t,e,i){let s,a,c,l={};if(void 0!==i?(null!==e&&(l=e),o(i)?s=i:r(i)?a=i.toString():i&&i.sel&&(s=[i])):null!=e&&(o(e)?s=e:r(e)?a=e.toString():e&&e.sel?s=[e]:l=e),void 0!==s)for(c=0;c<s.length;++c)r(s[c])&&(s[c]=n(void 0,void 0,void 0,s[c],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||p(l,s,t),n(t,l,s,a,void 0)}function f(t,e){var n;const o=null===(n=e.data)||void 0===n?void 0:n.ns;t.data.fn=e.data.fn,t.data.args=e.data.args,e.data=t.data,e.children=t.children,e.text=t.text,e.elm=t.elm,o&&p(e.data,e.children,e.sel)}function g(t){const e=t.data;f(e.fn(...e.args),t)}function v(t,e){let n;const o=t.data,r=e.data,i=o.args,s=r.args;if(o.fn===r.fn&&i.length===s.length){for(n=0;n<s.length;++n)if(i[n]!==s[n])return void f(r.fn(...s),e);f(t,e)}else f(r.fn(...s),e)}const b=function(t,e,n,o){return void 0===o&&(o=n,n=e,e=void 0),m(t,{key:e,hook:{init:g,prepatch:v},fn:n,args:o})};function y(t,e){let n;const o=e.elm;let r=t.data.attrs,i=e.data.attrs;if((r||i)&&r!==i){for(n in r=r||{},i=i||{},i){const t=i[n];r[n]!==t&&(!0===t?o.setAttribute(n,""):!1===t?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,t):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,t):o.setAttribute(n,t))}for(n in r)n in i||o.removeAttribute(n)}}const w={create:y,update:y};function k(t,e){let n,o;const r=e.elm;let i=t.data.class,s=e.data.class;if((i||s)&&i!==s){for(o in i=i||{},s=s||{},i)i[o]&&!Object.prototype.hasOwnProperty.call(s,o)&&r.classList.remove(o);for(o in s)n=s[o],n!==i[o]&&r.classList[n?"add":"remove"](o)}}const C={create:k,update:k};function x(t){return{insert:e=>t(e.elm)}}function S(t,e,n,o=!0){return x((r=>r.addEventListener(t,(t=>{const o=e(t);return!1===o&&t.preventDefault(),null==n||n(),o}),{passive:o})))}const M=(t,e,n)=>S(t,e,n,!1);function P(t,e){return S("submit",(e=>(e.preventDefault(),t(e))),e,!1)}function E(t){return{"data-icon":t}}const A={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(T),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(T)};function T(t){const e=t.split("/");return{key:e[0],text:e[1]}}const I=t=>void 0!==t,_=t=>null!=t,N=t=>!t||0===t.length,D=t=>!N(t),q=t=>{let e=t;return function(t){return I(t)&&(e=t),e}},O={Accept:"application/vnd.lichess.v5+json"},R={cache:"no-cache",credentials:"same-origin"},L={"X-Requested-With":"XMLHttpRequest"},F=t=>{if(t.ok)return t;if(429==t.status)throw new Error("Too many requests");if(413==t.status)throw new Error("The uploaded file is too large");throw new Error(`Error ${t.status}`)},B=(t,e={})=>fetch(t,{...R,headers:{...O,...L},...e}).then((t=>F(t).json())),j=(t,e={})=>z(t,e).then((t=>F(t).text())),z=(t,e={})=>fetch(t,{...R,headers:{...L},...e}),G=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e},V=(t,e)=>{const n=new URLSearchParams;for(const r of Object.keys(e))I(e[r])&&n.append(r,e[r]);const o=n.toString();return o?`${t}?${o}`:t},H=t=>j(W(t)),W=t=>`/${t}/note`;function U(t,e,n=!1){let o,r=0;return function(...i){const s=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>e?t.apply(s,i):o=setTimeout((()=>{o=void 0,t.apply(s,i)}),e)}}function K(t){let e=t.text;const n=U((()=>{((t,e)=>{B(W(t),{method:"post",body:G({text:e})})})(t.id,e||"")}),1e3);return{id:t.id,trans:t.trans,text:()=>e,fetch(){H(t.id).then((n=>{e=n||"",t.redraw()}))},post(t){e=t,n()}}}function J(t){const e=t.text();return null==e?m("div.loading",{hook:{insert:t.fetch}}):m("textarea",{attrs:{placeholder:t.trans("typePrivateNotesHere")},hook:{insert(n){const o=$(n.elm);o.val(e).on("change keyup paste",(()=>t.post(o.val())))}}})}function Y(t,e,n){const o=n?m("line.line.patron",{attrs:{title:"Lichess Patron"}}):void 0;return m("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+t}},e&&"BOT"!=e?[o,m("span.utitle",e),t]:[o,t])}let X=!1;const Q=t=>(!1===X&&(X=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===X?""+t:X.format(t));function Z(t){let e,n=!1;const o=()=>{e=void 0,n=!1,t.redraw()};return{loading:()=>n,data:()=>e,reasons:t.reasons,permissions:()=>t.permissions,open:o=>{const r=o.querySelector("a.user-link"),i=o.querySelector("t").innerText,s=r.href.split("/")[4];t.permissions.timeout?(n=!0,(t=>B("/mod/chat-user/"+t))(s).then((o=>{e={...o,text:i},n=!1,t.redraw()}))):e={id:s.toLowerCase(),username:s,text:i},t.redraw()},close:o,timeout(n,r){e&&lichess.pubsub.emit("socket.send","timeout",{userId:e.id,reason:n.key,text:r}),o(),t.redraw()}}}const tt=()=>m("i.mod",{attrs:{"data-icon":""}});function et(t,e){const n=t.data;n.domVersion=1;const o={instance:void 0,loaded:!1,enabled:q(!!n.palantir)},r=["discussion"];t.noteId&&r.push("note"),t.plugin&&r.push(t.plugin.tab.key);const i=lichess.storage.make("chat.tab"),s=i.get();let a;const c={tab:r.find((t=>t===s))||r[0],enabled:t.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,timeout:t.timeout,writeable:t.writeable};r.length>1&&"discussion"===c.tab&&lichess.storage.get("nochat")&&(c.tab=r[1]);const l=t=>!!(t=t.trim())&&(!("You too!"==t&&!n.lines.some((t=>t.u!=n.userId)))&&(t.length>140?(alert("Max length: 140 chars. "+t.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",t),!0))),d=lichess.trans(t.i18n);function u(){(t.permissions.timeout||t.permissions.local)&&(a=Z({reasons:t.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:t.permissions,redraw:e}),t.loadCss("chat.mod"))}u();const h=t.noteId?K({id:t.noteId,text:t.noteText,trans:d,redraw:e}):void 0,p=function(t){let e=t.initialGroup,n=[];return{group:()=>e,said:()=>n,setGroup(o){o!==e&&(e=o,o||(n=[]),t.redraw())},post(o){e&&A[e]&&(n.includes(o.key)||t.post(o.text)&&n.push(o.key))}}}({initialGroup:t.preset,post:l,redraw:e}),m=[["socket.in.message",t=>{n.lines.push(t);const o=n.lines.length;o>200&&(n.lines.splice(0,o-200+50),n.domVersion++),e()}],["socket.in.chat_timeout",t=>{let o=!1;n.lines.forEach((e=>{e.u&&e.u.toLowerCase()==t&&(e.d=!0,o=!0)})),t==n.userId&&(c.timeout=o=!0),o&&(n.domVersion++,e())}],["socket.in.chat_reinstate",t=>{t==n.userId&&(c.timeout=!1,e())}],["chat.writeable",t=>{c.writeable=t,e()}],["chat.permissions",n=>{let o;for(o in n)t.permissions[o]=n[o];u(),e()}],["palantir.toggle",o.enabled]];m.forEach((([t,e])=>lichess.pubsub.on(t,e)));const f=()=>lichess.pubsub.emit("chat.enabled",c.enabled);return f(),{data:n,opts:t,vm:c,allTabs:r,setTab(t){c.tab=t,i.set(t),"discussion"===t&&lichess.requestIdleCallback((()=>$(".mchat__say").each((function(){this.focus()}))),500),e()},moderation:()=>a,note:h,preset:p,post:l,trans:d,plugin:t.plugin,setEnabled(t){c.enabled=t,f(),t?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),e()},redraw:e,palantir:o,destroy:()=>{m.forEach((([t,e])=>lichess.pubsub.off(t,e)))}}}const nt=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,ot=/\n/g,rt=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function it(t){return`<a target="_blank" rel="nofollow noopener noreferrer" href="${t}">${t.replace(/https?:\/\//,"")}</a>`}function st(t,e){return{insert(n){n.elm.innerHTML=e(t),n.data.cachedA=t},postpatch(n,o){n.data.cachedA!==t&&(o.elm.innerHTML=e(t)),o.data.cachedA=t}}}function at(t,e,n){return t.includes("&quot;")?t:`<a target="_blank" rel="noopener nofollow noreferrer" href="${t.startsWith("/")||t.includes("://")?t:"//"+t}"${n?` class="${n}"`:""}>${e||t}</a>`}function ct(t,e=!0){let n=(o=lichess.escapeHtml(t),r=it,o.replace(nt,((t,e,n)=>e+r(n))));var o,r;return e&&(n=n.replace(ot,"<br>")),n}function lt(t,e=!0){return st(t,(t=>ct(t,e)))}const dt=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,ut=/^[a-h][2-7]$/,ht=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function pt(t,e,n){if(e<1||e>200)return t;return'<a class="jump" data-ply="'+(2*e-(n.length>1?0:1))+'">'+t+"</a>"}function mt(t,e,n){return n.match(ut)?t:function(t,e,n){return e+at("/@/"+n,"@"+n)}(0,e,n)}function ft(t,e){const n=lichess.escapeHtml(t),o=n.replace(rt,mt).replace(dt,at);return e&&o===n?o.replace(ht,pt):o}const gt=()=>"1"==lichess.storage.get("chat-spam"),vt=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/","trasderk.blogspot.com"].map((t=>t.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),bt=t=>!!t.match(vt),yt=/follow me|join my team/i,wt=t=>!!t.match(yt),kt=/lichess\.org\/team\//i,Ct=/^\/[wW](?:hisper)?\s/;function xt(t){if(!t.vm.enabled)return[];const e=e=>{const n=e.elm;if(t.data.lines.length>5){(0===n.scrollTop||n.scrollTop>n.scrollHeight-n.clientHeight-100)&&(n.scrollTop=999999,setTimeout((t=>n.scrollTop=999999),300))}},n=!!t.moderation(),o=[m("ol.mchat__messages.chat-v-"+t.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(o){const r=$(o.elm).on("click","a.jump",(t=>{lichess.pubsub.emit("jump",t.target.getAttribute("data-ply"))}));n?r.on("click",".mod",(e=>{var n;return null===(n=t.moderation())||void 0===n?void 0:n.open(e.target.parentNode)})):r.on("click",".flag",(e=>function(t,e){const n=e.querySelector("a.user-link"),o=e.querySelector("t").innerText;n&&confirm(`Report "${o}" to moderators?`)&&((t,e,n)=>{B("/report/flag",{method:"post",body:G({username:e,resource:t,text:n})})})(t.data.resourceId,n.href.split("/")[4],o)}(t,e.target.parentNode))),e(o)},postpatch:(t,n)=>e(n)}},Et(t).map((e=>function(t,e){var n;const o=function(t,e){if(n=t,/(\n|(@|#|\.)\w{2,})/.test(n)){const n=function(t){return(e,n)=>{n.data.lichessChat!==e.data.lichessChat&&(n.elm.innerHTML=ft(n.data.lichessChat,t))}}(e);return m("t",{lichessChat:t,hook:{create:n,update:n}})}var n;return m("t",t)}(e.t,t.opts.parseMoves);if("lichess"===e.u)return m("li.system",o);if(e.c)return m("li",[m("span.color","["+e.c+"]"),o]);const r=b("a",e.u,Y,[e.u,e.title,e.p]),i=null===(n=e.u)||void 0===n?void 0:n.toLowerCase();return m("li",{class:{me:i===t.data.userId,host:i===t.data.hostId}},t.moderation()?[e.u?tt():null,r," ",o]:[t.data.userId&&e.u&&t.data.userId!=e.u?m("i.flag",{attrs:{"data-icon":"",title:"Report"}}):null,r," ",o])}(t,e)))),St(t)],r=function(t){const e=t.group();if(!e)return;const n=A[e],o=t.said();return n&&o.length<2?m("div.mchat__presets",n.map((e=>{const n=o.includes(e.key);return m("span",{class:{disabled:n},attrs:{title:e.text,disabled:n},hook:S("click",(()=>{!n&&t.post(e)}))},e.key)}))):void 0}(t.preset);return r&&o.push(r),o}function St(t){if(!t.vm.writeable)return;if(t.data.loginRequired&&!t.data.userId||t.data.restricted)return m("input.mchat__say",{attrs:{placeholder:t.trans("loginToChat"),disabled:!0}});let e;return e=t.vm.timeout?t.trans("youHaveBeenTimedOut"):t.opts.blind?"Chat":t.trans.noarg(t.vm.placeholderKey),m("input.mchat__say",{attrs:{placeholder:e,autocomplete:"off",maxlength:140,disabled:t.vm.timeout||!t.vm.writeable,"aria-label":"Chat input"},hook:{insert(e){Pt(t,e.elm)}}})}let Mt;const Pt=(t,e)=>{const n=lichess.tempStorage.make("chat.input"),o=n.get();o&&(e.value=o,e.focus(),!t.opts.public&&o.match(Ct)&&e.classList.add("whisper")),e.addEventListener("keydown",(e=>{"Enter"===e.key&&setTimeout((()=>{const o=e.target,r=o.value,i=t.opts.public;""===r?$(".keyboard-move input").each((function(){this.focus()})):(t.opts.kobold||(t=>{if(gt())return;const e=bt(t);e&&j(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(e||wt(t))&&lichess.storage.set("chat-spam","1")})(r),i&&(t=>!!t.match(kt))(r)?alert("Please don't advertise teams in the chat."):t.post(r),o.value="",n.remove(),i||o.classList.remove("whisper"))}))})),e.addEventListener("input",(e=>setTimeout((()=>{const o=e.target,r=o.value;o.removeAttribute("placeholder"),t.opts.public||o.classList.toggle("whisper",!!r.match(Ct)),n.set(r)})))),window.Mousetrap.bind("c",(()=>e.focus()));const r=["touchstart","mousedown"];Mt&&r.forEach((t=>document.body.removeEventListener(t,Mt,{capture:!0}))),Mt=t=>{t.shiftKey||2===t.buttons||2===t.button||e.blur()},e.onfocus=()=>r.forEach((t=>document.body.addEventListener(t,Mt,{passive:!0,capture:!0}))),e.onblur=()=>r.forEach((t=>document.body.removeEventListener(t,Mt,{capture:!0})))};function Et(t){const e=[];let n;return t.data.lines.forEach((o=>{var r,i,s;o.d||n&&(s=o,(i=n).d&&s.d&&i.u===s.u)||o.r&&(o.u||"").toLowerCase()!=t.data.userId||(r=o.t,(bt(r)||wt(r))&&!gt())||e.push(o),n=o})),e}function At(t){const e=t.moderation();return m("section.mchat"+(t.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!e},hook:{destroy:t.destroy}},function(t){if(!t)return;if(t.loading())return[m("div.loading")];const e=t.data();if(!e)return;const n=t.permissions(),o=e.history?m("div.infos.block",[Q(e.games||0)+" games",e.tos?"TOS":void 0].map((t=>t&&m("span",t))).concat([m("a",{attrs:{href:"/@/"+e.username+"?mod"}},"profile")]).concat(n.shadowban?[m("a",{attrs:{href:"/mod/"+e.username+"/communication"}},"coms")]:[])):void 0,r=n.timeout?m("div.timeout.block",[m("strong","Timeout 15 minutes for"),...t.reasons.map((n=>m("a.text",{attrs:{"data-icon":""},hook:S("click",(()=>t.timeout(n,e.text)))},n.name)))]):m("div.timeout.block",[m("strong","Moderation"),m("a.text",{attrs:{"data-icon":""},hook:S("click",(()=>t.timeout(t.reasons[0],e.text)))},"Timeout 15 minutes")]),i=e.history?m("div.history.block",[m("strong","Timeout history"),m("table",m("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},e.history.map((function(t){return m("tr",[m("td.reason",t.reason),m("td.mod",t.mod),m("td",m("time.timeago",{attrs:{datetime:t.date}}))])}))))]):void 0;return[m("div.top",{key:"mod-"+e.id},[m("span.text",{attrs:{"data-icon":""}},[Y(e.username)]),m("a",{attrs:{"data-icon":""},hook:S("click",t.close)})]),m("div.mchat__content.moderation",[m("i.line-text.block",['"',e.text,'"']),o,r,i])]}(e)||function(t){const e=t.vm.tab;return[m("div.mchat__tabs.nb_"+t.allTabs.length,[...t.allTabs.map((n=>function(t,e,n){return m("div.mchat__tab."+e,{class:{"mchat__tab-active":e===n},hook:S("click",(()=>t.setTab(e)))},function(t,e){return"discussion"===e?[m("span",t.data.name),t.opts.alwaysEnabled?void 0:m("input",{attrs:{type:"checkbox",title:t.trans.noarg("toggleTheChat"),checked:t.vm.enabled},hook:S("change",(e=>{t.setEnabled(e.target.checked)}))})]:"note"===e?[m("span",t.trans.noarg("notes"))]:t.plugin&&e===t.plugin.tab.key?[m("span",t.plugin.tab.name)]:[]}(t,e))}(t,n,e))),Tt(t)]),m("div.mchat__content."+e,"note"===e&&t.note?[J(t.note)]:t.plugin&&e===t.plugin.tab.key?[t.plugin.view()]:xt(t))]}(t))}function Tt(t){const e=t.palantir;if(e.enabled())return e.instance?e.instance.render(m):m("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:S("click",(()=>{e.loaded||(e.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{e.instance=window.Palantir.palantir({uid:t.data.userId,redraw:t.redraw}),t.redraw()}))})))}))})}const It={a:"a1",b:"b1",c:"c1",d:"d1",e:"e1",f:"f1",g:"g1",h:"h1",i:"a2",j:"b2",k:"c2",l:"d2",m:"e2",n:"f2",o:"g2",p:"h2",q:"a3",r:"b3",s:"c3",t:"d3",u:"e3",v:"f3",w:"g3",x:"h3",y:"a4",z:"b4",A:"c4",B:"d4",C:"e4",D:"f4",E:"g4",F:"h4",G:"a5",H:"b5",I:"c5",J:"d5",K:"e5",L:"f5",M:"g5",N:"h5",O:"a6",P:"b6",Q:"c6",R:"d6",S:"e6",T:"f6",U:"g6",V:"h6",W:"a7",X:"b7",Y:"c7",Z:"d7",0:"e7",1:"f7",2:"g7",3:"h7",4:"a8",5:"b8",6:"c8",7:"d8",8:"e8",9:"f8","!":"g8","?":"h8"};function $t(t){return"P"===t[0]?t.slice(1):t}function _t(t){return null==t?null:t.match(/.{2}/g)||[]}const Nt={e1a1:"e1c1",e1h1:"e1g1",e8a8:"e8c8",e8h8:"e8g8"},Dt=25,qt=30;const Ot=t=>t.game.status.id<Dt&&!Rt(t),Rt=t=>"import"===t.game.source,Lt=t=>Rt(t)||function(t){return t.game.status.id>=qt}(t)||function(t){return t.game.status.id===Dt}(t)&&(t=>(t=>t.game.turns-(t.game.startedAtTurn||0))(t)>1)(t);function Ft(t,e){return t.player.color===e?t.player:t.opponent.color===e?t.opponent:null}function Bt(t){return t.slice(0,2)}function jt(t){return t.slice(2)}function zt(t){return t.slice(0,-2)}function Gt(t,e){return t.startsWith(e)}function Vt(t){let e="";for(const n in t)e+=t[n].id;return e}function Ht(t,e){const n=t.children[0];return n?e(n):void 0}function Wt(t,e){const n=function(t){return e(t)?t:Ht(t,n)};return n(t)}function Ut(t,e){const n=[t];let o,r=t;for(;o=e(r);)n.push(o),r=o;return n}function Kt(t){return t.children[0]}function Jt(t,e){return t.children.find((t=>t.id===e))}function Yt(t){return t[t.length-1]}function Xt(t,e){let n="";for(const o in t){if(!e(t[o]))break;n+=t[o].id}return n}function Qt(t,e){t.children=t.children.filter((function(t){return t.id!==e}))}function Zt(t){const e={nodes:1,comments:(t.comments||[]).length};return t.children.forEach((function(t){const n=Zt(t);e.nodes+=n.nodes,e.comments+=n.comments})),e}function te(t,e){t.eval=e.eval,e.glyphs&&(t.glyphs=e.glyphs),e.comments&&e.comments.forEach((function(e){t.comments?t.comments.some((function(t){return t.text===e.text}))||t.comments.push(e):t.comments=[e]})),e.children.forEach((function(e){const n=Jt(t,e.id);n?te(n,e):t.children.push(e)}))}function ee(t,e){return e<=0||!!t.children[1]||t.children[0]&&ee(t.children[0],e-1)}function ne(t){return Ut(t,Kt)}function oe(t,e){!function t(n){e(n),n.children.forEach(t)}(t)}function re(t){function e(e){return n(t,e)}function n(t,e){if(""===e)return t;const o=Jt(t,Bt(e));return o?n(o,jt(e)):t}function o(e){return r(t,e)}function r(t,e){if(""===e)return t;const n=Jt(t,Bt(e));return n?r(n,jt(e)):void 0}function i(t,e){const n=Bt(e),o=Jt(t,n);return o?n+i(o,jt(e)):""}function s(t,e){if(""===e)return!0;const n=Bt(e),o=t.children[0];return!(!o||o.id!==n)&&s(o,jt(e))}function a(t,e){if(""===e)return t;const n=Bt(e),o=t.children[0];return o&&o.id===n?a(o,jt(e)):t}function c(e){return Ut(t,(function(t){const n=Bt(e);if(""!==n)return e=jt(e),Jt(t,n)}))}function l(t,e){const n=o(t);if(n)return e(n),n}function d(t,e){const n=e+t.id,r=o(n);return r?(["dests","drops","clock"].forEach((e=>{I(t[e])&&!I(r[e])&&(r[e]=t[e])})),n):l(e,(function(e){e.children.push(t)}))?n:void 0}function u(t,e){return l(e,(function(e){const n=(e.comments||[]).filter((function(e){return e.id!==t}));e.comments=n.length?n:void 0}))}function h(t){return e(zt(t))}return{root:t,lastPly(){var e;return(null===(e=Wt(t,(t=>!t.children.length)))||void 0===e?void 0:e.ply)||t.ply},nodeAtPath:e,getNodeList:c,longestValidPath:e=>i(t,e),updateAt:l,addNode:d,addNodes:function t(e,n){const o=e[0];if(!o)return n;const r=d(o,n);return r?t(e.slice(1),r):void 0},addDests:(t,e)=>l(e,(function(e){e.dests=t})),setShapes:(t,e)=>l(e,(function(e){e.shapes=t})),setCommentAt:function(t,e){return t.text?l(e,(function(e){e.comments=e.comments||[];const n=e.comments.find((function(e){return e.id===t.id}));n?n.text=t.text:e.comments.push(t)})):u(t.id,e)},deleteCommentAt:u,setGlyphsAt:function(t,e){return l(e,(function(e){e.glyphs=t}))},setClockAt:(t,e)=>l(e,(function(e){e.clock=t})),pathIsMainline:function(e){return s(t,e)},pathIsForcedVariation:function(t){return!!c(t).find((t=>t.forceVariation))},lastMainlineNode:e=>a(t,e),pathExists:function(t){return!!o(t)},deleteNodeAt:function(t){Qt(h(t),function(t){return t.slice(-2)}(t))},promoteAt:function(t,e){const n=c(t);for(let o=n.length-2;o>=0;o--){const t=n[o+1],r=n[o];if(r.children[0].id!==t.id){if(Qt(r,t.id),r.children.unshift(t),!e)break}else if(t.forceVariation&&(t.forceVariation=!1,!e))break}},forceVariationAt:(t,e)=>l(t,(function(t){t.forceVariation=e})),getCurrentNodesAfterPly:function(t,e,n){const o=[];for(const r in t){const i=t[r];if(i.ply<=n&&e[r].id!==i.id)break;i.ply>n&&o.push(i)}return o},merge(e){te(t,e)},removeCeval(){oe(t,(function(t){delete t.ceval,delete t.threat}))},removeComputerVariations(){ne(t).forEach((function(t){t.children=t.children.filter((function(t){return!t.comp}))}))},parentNode:h,getParentClock:function(t,e){if(!("parentClock"in t)){const n=e&&h(e);t.parentClock=n?"clock"in n?n.clock:void 0:t.clock}return t.parentClock}}}function ie(t){return t.node.children.length>0}function se(t){const e=t.node.children[0];e&&t.userJumpIfCan(t.path+e.id)}function ae(t){t.userJumpIfCan(zt(t.path))}function ce(t){t.userJumpIfCan(Vt(t.mainline))}function le(t){t.userJump("")}function de(t){const e=t.node.children[1];e&&t.userJump(t.path+e.id)}function ue(t){if(t.onMainline)return;let e,n="";t.nodeList.slice(1,-1).forEach((function(t){n+=t.id,t.children[1]&&(e=n)})),e&&t.userJump(e)}var he=Object.freeze({__proto__:null,canGoForward:ie,next:se,prev:ae,last:ce,first:le,enterVariation:de,exitVariation:ue});function pe(t){pe.close();const e=$('<div id="modal-wrap"><span class="close" role="button" aria-label="Close" data-icon="" tabindex="0"></span></div>'),n=$(`<div id="modal-overlay" class="${t.class}">`);return t.noClickAway||n.on("click",pe.close),$('<a href="#"></a>').appendTo(n),e.appendTo(n),$('<a href="#"></a>').appendTo(n),t.content.clone().removeClass("none").appendTo(e),t.onInsert&&t.onInsert(e),pe.onClose=t.onClose,e.find(".close,.cancel").each((function(){fe(this,pe.close)})),$("body").addClass("overlayed").prepend(n),ge(e),e}function me(t){const e=t.onClose;return m("div#modal-overlay",{...t.onClose&&!t.noClickAway?{hook:S("click",e)}:{}},[m("div#modal-wrap."+t.class,{hook:x((e=>{ge($(e)),t.onInsert&&t.onInsert($(e))}))},[m("span.close",{attrs:{"data-icon":"",role:"button","aria-label":"Close",tabindex:"0"},hook:x((t=>fe(t,e)))}),m("div",t.content)])])}pe.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){pe.onClose&&pe.onClose(),$(this).remove()})),delete pe.onClose},pe.onClose=void 0;const fe=(t,e)=>{t.addEventListener("click",e),t.addEventListener("keydown",(t=>"Enter"!==t.code&&"Space"!==t.code||e()))},ge=t=>{t.on("click",(t=>t.stopPropagation())),ve(t)},ve=t=>{var e,n;const o=t.find('button:not(:disabled), [href], input:not(:disabled):not([type="hidden"]), select:not(:disabled), textarea:not(:disabled), [tabindex="0"]');null===(n=null!==(e=o[1])&&void 0!==e?e:o[0])||void 0===n||n.focus()},be=[{"stroke-width":3.779,d:"m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"},{"stroke-width":4.157,d:"m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"},{"stroke-width":4.535,d:"m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"}];function ye(){return m("div.spinner",{"aria-label":"loading"},[m("svg",{attrs:{viewBox:"-2 -2 54 54"}},[m("g",{attrs:{mask:"url(#mask)",fill:"none"}},be.map((t=>m("path",{attrs:t}))))])])}const we=t=>{const e=window.Mousetrap;if(e&&(e.bind(["left","k"],(()=>{ae(t),t.redraw()})).bind(["shift+left","shift+k"],(()=>{ue(t),t.redraw()})).bind(["right","j"],(()=>{t.fork.proceed()||se(t),t.redraw()})).bind(["shift+right","shift+j"],(()=>{de(t),t.redraw()})).bind(["up","0"],(()=>{t.fork.prev()||le(t),t.redraw()})).bind(["down","$"],(()=>{t.fork.next()||ce(t),t.redraw()})).bind("shift+c",(()=>{t.showComments=!t.showComments,t.autoScroll(),t.redraw()})).bind("shift+i",(()=>{t.treeView.toggle(),t.redraw()})).bind("z",(()=>{t.toggleComputer(),t.redraw()})),!t.embed&&(e.bind("space",(()=>{const e=t.gamebookPlay();if(e)e.onSpace();else{if(t.practice||t.studyPractice)return;t.ceval.enabled()?t.playBestMove():t.toggleCeval()}})),!t.studyPractice&&(e.bind("f",t.flip).bind("?",(()=>{t.keyboardHelp=!t.keyboardHelp,t.redraw()})).bind("l",t.toggleCeval).bind("a",(()=>{t.toggleAutoShapes(!t.showAutoShapes()),t.redraw()})).bind("x",t.toggleThreatMode).bind("e",(()=>{t.toggleExplorer(),t.redraw()})),t.study)))){const n=(t,n)=>{e.bind(t,(()=>{$(n).each((function(){this.dispatchEvent(new Event("mousedown"))}))}))};n("d",".study__buttons .comments"),n("g",".study__buttons .glyphs"),e.bind("p",t.study.goToPrevChapter),e.bind("n",t.study.goToNextChapter)}};function ke(t){return me({class:"keyboard-help",onInsert(e){lichess.loadCssPath("analyse.keyboard"),j(V("/analysis/help",{study:!!t.study})).then((t=>{e.find(".scrollable").html(t)}))},onClose(){t.keyboardHelp=!1,t.redraw()},content:[m("div.scrollable",ye())]})}function Ce(t){!window.LichessSpeech&&t?lichess.loadModule("speech"):window.LichessSpeech&&!t&&(window.LichessSpeech=void 0)}function xe(t){var e;e=e=>e.step(t,!0),window.LichessSpeech&&e(window.LichessSpeech)}const Se="button.button.button-red.button-empty";function Me(t){return function(){return t}}function Pe(t){return m("i",{attrs:E(t)})}function Ee(t){return t.san?(e=t.ply,Math.floor((e-1)/2)+1+(t.ply%2==1?".":"...")+" "+$t(t.san)):"Initial position";var e}function Ae(t,e){return e+" "+(1===e?t:t+"s")}function Te(t){const e=t.split(" ");return(1===e.length?e[0]:e[1]).toLowerCase()}function Ie(){return`${window.location.protocol}//${window.location.host}`}function $e(t,e,n){return m("option",{attrs:{value:t,selected:t===e}},n)}function _e(t,e){t&&e&&(t.scrollTop=e.offsetTop-t.offsetHeight/2+e.offsetHeight/2)}function Ne(t,e){return function(t){let e,n;return function(...o){const r=this,i=()=>{n=void 0,e=t.apply(r,o).finally((()=>{e=void 0,n&&n()}))};e?n=i:i()}}((function(...n){return e.apply(this,n),new Promise((e=>setTimeout(e,t)))}))}function De(t){const e=q(t.initDict),n=q(null),o={};let r={},i=[];function s(){return t.myId===t.ownerId||t.admin&&c()}function a(){return t.myId?e()[t.myId]:void 0}function c(){const t=a();return!!t&&"w"===t.role}const l=function(t,e,n,o,r){const i=q(!1),s=q([]);return{open:i,members:e,spectators:s,toggle(){i(!i())},invite(e){t("invite",Te(e)),n()},redraw:o,trans:r}}(t.send,e,(()=>t.tab("members")),t.redraw,t.trans);function d(e){"members"===t.tab()&&(o[e]?o[e]():o[e]=function(t){let e;const n=()=>{e&&clearTimeout(e),e=setTimeout(t,100)};return n(),n}((()=>{delete o[e],t.redraw()})),t.redraw())}function u(){r={};const n=e();i.forEach((function(t){n[t]&&(r[t]=!0)})),"members"===t.tab()&&t.redraw()}return lichess.pubsub.on("socket.in.crowd",(t=>{const e=t.users||[];l.spectators(e),i=e.map(Te),u()})),{dict:e,confing:n,myId:t.myId,inviteForm:l,update(o){s()&&n(Object.keys(o).find((t=>!e()[t]))||null);const r=a()&&!c(),i=a()&&c();e(o),r&&c()?(lichess.once("study-tour")&&t.startTour(),t.onBecomingContributor(),t.notif.set({text:t.trans.noarg("youAreNowAContributor"),duration:3e3})):i&&!c()&&t.notif.set({text:t.trans.noarg("youAreNowASpectator"),duration:3e3}),u()},setActive:d,isActive:t=>!!o[t],owner:function(){return e()[t.ownerId]},myMember:a,isOwner:s,canContribute:c,max:30,setRole(e,o){d(e),t.send("setRole",{userId:e,role:o}),n(null)},kick(e){t.send("kick",e),n(null)},leave(){t.send("leave")},ordered(){const t=e();return Object.keys(t).map((e=>t[e])).sort(((t,e)=>"r"===t.role&&"w"===e.role?1:"w"===t.role&&"r"===e.role?-1:0))},size:()=>Object.keys(e()).length,isOnline:t=>r[t],hasOnlineContributor(){const t=e();for(const e in t)if(r[e]&&"w"===t[e].role)return!0;return!1}}}function qe(t){const e=t.members,n=e.isOwner();function o(t){const e=t.user;return m("span.user-link.ulpt",{attrs:{"data-href":"/@/"+e.name}},(e.title?e.title+" ":"")+e.name)}function r(n){const o="w"===n.role;return m("span.status",{class:{contrib:o,active:e.isActive(n.user.id),online:e.isOnline(n.user.id)},attrs:{title:t.trans.noarg(o?"contributor":"spectator")}},[Pe(o?"":"")])}function i(t,o){return n&&(o.user.id!==e.myId||t.data.admin)?m("i.act",{attrs:E(""),hook:S("click",(t=>e.confing(e.confing()==o.user.id?null:o.user.id)),t.redraw)}):n||o.user.id!==e.myId?void 0:m("i.act.leave",{attrs:{"data-icon":"",title:t.trans.noarg("leaveTheStudy")},hook:S("click",e.leave,t.redraw)})}function s(n){const o="member-role";return m("m-config",{key:n.user.id+"-config",hook:x((t=>_e($(t).parent(".members")[0],t)))},[m("div.role",[m("div.switch",[m("input.cmn-toggle",{attrs:{id:o,type:"checkbox",checked:"w"===n.role},hook:S("change",(t=>{e.setRole(n.user.id,t.target.checked?"w":"r")}),t.redraw)}),m("label",{attrs:{for:o}})]),m("label",{attrs:{for:o}},t.trans.noarg("contributor"))]),m("div.kick",m("a.button.button-red.button-empty.text",{attrs:E(""),hook:S("click",(t=>e.kick(n.user.id)),t.redraw)},t.trans.noarg("kick")))])}const a=e.ordered();return m("div.study__members",{hook:x((()=>lichess.pubsub.emit("chat.resize")))},[...a.map((n=>{const a=e.confing()===n.user.id;return[m("div",{key:n.user.id,class:{editing:!!a}},[m("div.left",[r(n),o(n)]),i(t,n)]),a?s(n):null]})).reduce(((t,e)=>t.concat(e)),[]),n&&a.length<e.max?m("div.add",{key:"add",hook:S("click",e.inviteForm.toggle,t.redraw)},[m("div.left",[m("span.status",Pe("")),m("div.user-link",t.trans.noarg("addMembers"))])]):null,!e.canContribute()&&t.data.admin?m("form.admin",{key:":admin",hook:M("submit",(()=>(z(`/study/${t.data.id}/admin`,{method:"post"}).then((()=>location.reload())),!1)))},[m("button.button.button-red.button-thin","Enter as admin")]):null])}function Oe(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var Re,Le=function(){function t(){}var e=t.prototype;return e.unwrap=function(t,e){var n=this._chain((function(e){return Re.ok(t?t(e):e)}),(function(t){return e?Re.ok(e(t)):Re.err(t)}));if(n.isErr)throw n.error;return n.value},e.map=function(t,e){return this._chain((function(e){return Re.ok(t(e))}),(function(t){return Re.err(e?e(t):t)}))},e.chain=function(t,e){return this._chain(t,e||function(t){return Re.err(t)})},t}(),Fe=function(t){function e(e){var n;return(n=t.call(this)||this).value=e,n.isOk=!0,n.isErr=!1,n}return Oe(e,t),e.prototype._chain=function(t,e){return t(this.value)},e}(Le),Be=function(t){function e(e){var n;return(n=t.call(this)||this).error=e,n.isOk=!1,n.isErr=!0,n}return Oe(e,t),e.prototype._chain=function(t,e){return e(this.error)},e}(Le);!function(t){t.ok=function(t){return new Fe(t)},t.err=function(t){return new Be(t||new Error)},t.all=function(e){if(Array.isArray(e)){for(var n=[],o=0;o<e.length;o++){var r=e[o];if(r.isErr)return r;n.push(r.value)}return t.ok(n)}for(var i={},s=Object.keys(e),a=0;a<s.length;a++){var c=e[s[a]];if(c.isErr)return c;i[s[a]]=c.value}return t.ok(i)}}(Re||(Re={}));const je=["a","b","c","d","e","f","g","h"],ze=["1","2","3","4","5","6","7","8"],Ge=["white","black"],Ve=["pawn","knight","bishop","rook","queen","king"],He=["a","h"];function We(t){return"role"in t}function Ue(t){return t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24}function Ke(t){return(t=t>>>8&16711935|(16711935&t)<<8)>>>16&65535|(65535&t)<<16}function Je(t){return Ke(t=(t=(t=t>>>1&1431655765|(1431655765&t)<<1)>>>2&858993459|(858993459&t)<<2)>>>4&252645135|(252645135&t)<<4)}class Ye{constructor(t,e){this.lo=t,this.hi=e,this.lo=0|t,this.hi=0|e}static fromSquare(t){return t>=32?new Ye(0,1<<t-32):new Ye(1<<t,0)}static fromRank(t){return new Ye(255,0).shl64(8*t)}static fromFile(t){return new Ye(16843009<<t,16843009<<t)}static empty(){return new Ye(0,0)}static full(){return new Ye(4294967295,4294967295)}static corners(){return new Ye(129,2164260864)}static center(){return new Ye(402653184,24)}static backranks(){return new Ye(255,4278190080)}static backrank(t){return"white"===t?new Ye(255,0):new Ye(0,4278190080)}static lightSquares(){return new Ye(1437226410,1437226410)}static darkSquares(){return new Ye(2857740885,2857740885)}complement(){return new Ye(~this.lo,~this.hi)}xor(t){return new Ye(this.lo^t.lo,this.hi^t.hi)}union(t){return new Ye(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new Ye(this.lo&t.lo,this.hi&t.hi)}diff(t){return new Ye(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?Ye.empty():t>=32?new Ye(this.hi>>>t-32,0):t>0?new Ye(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?Ye.empty():t>=32?new Ye(0,this.lo<<t-32):t>0?new Ye(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new Ye(Ke(this.hi),Ke(this.lo))}rbit64(){return new Ye(Je(this.hi),Je(this.lo))}minus64(t){const e=this.lo-t.lo,n=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new Ye(e,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Ue(this.lo)+Ue(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(t){return 0!=(t>=32?this.hi&1<<t-32:this.lo&1<<t)}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new Ye(this.lo,this.hi|1<<t-32):new Ye(this.lo|1<<t,this.hi)}without(t){return t>=32?new Ye(this.lo,this.hi&~(1<<t-32)):new Ye(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new Ye(this.lo,this.hi^1<<t-32):new Ye(this.lo^1<<t,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new Ye(this.lo&this.lo-1,this.hi):new Ye(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield e}for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield 32+t}}*reversed(){let t=this.lo,e=this.hi;for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield 32+t}for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield e}}}class Xe{constructor(){}static default(){const t=new Xe;return t.reset(),t}static racingKings(){const t=new Xe;return t.occupied=new Ye(65535,0),t.promoted=Ye.empty(),t.white=new Ye(61680,0),t.black=new Ye(3855,0),t.pawn=Ye.empty(),t.knight=new Ye(6168,0),t.bishop=new Ye(9252,0),t.rook=new Ye(16962,0),t.queen=new Ye(129,0),t.king=new Ye(33024,0),t}static horde(){const t=new Xe;return t.occupied=new Ye(4294967295,4294901862),t.promoted=Ye.empty(),t.white=new Ye(4294967295,102),t.black=new Ye(0,4294901760),t.pawn=new Ye(4294967295,16711782),t.knight=new Ye(0,1107296256),t.bishop=new Ye(0,603979776),t.rook=new Ye(0,2164260864),t.queen=new Ye(0,134217728),t.king=new Ye(0,268435456),t}reset(){this.occupied=new Ye(65535,4294901760),this.promoted=Ye.empty(),this.white=new Ye(65535,0),this.black=new Ye(0,4294901760),this.pawn=new Ye(65280,16711680),this.knight=new Ye(66,1107296256),this.bishop=new Ye(36,603979776),this.rook=new Ye(129,2164260864),this.queen=new Ye(8,134217728),this.king=new Ye(16,268435456)}static empty(){const t=new Xe;return t.clear(),t}clear(){this.occupied=Ye.empty(),this.promoted=Ye.empty();for(const t of Ge)this[t]=Ye.empty();for(const t of Ve)this[t]=Ye.empty()}clone(){const t=new Xe;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of Ge)t[e]=this[e];for(const e of Ve)t[e]=this[e];return t}equalsIgnorePromoted(t){return!!this.white.equals(t.white)&&Ve.every((e=>this[e].equals(t[e])))}equals(t){return this.equalsIgnorePromoted(t)&&this.promoted.equals(t.promoted)}getColor(t){return this.white.has(t)?"white":this.black.has(t)?"black":void 0}getRole(t){for(const e of Ve)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;return{color:e,role:this.getRole(t),promoted:this.promoted.has(t)}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const n=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.king.intersect(this[t]).diff(this.promoted).singleSquare()}}class Qe{constructor(){}static empty(){const t=new Qe;for(const e of Ve)t[e]=0;return t}static fromBoard(t,e){const n=new Qe;for(const o of Ve)n[o]=t.pieces(e,o).size();return n}clone(){const t=new Qe;for(const e of Ve)t[e]=this[e];return t}equals(t){return Ve.every((e=>this[e]===t[e]))}add(t){const e=new Qe;for(const n of Ve)e[n]=this[n]+t[n];return e}nonEmpty(){return Ve.some((t=>this[t]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class Ze{constructor(t,e){this.white=t,this.black=e}static empty(){return new Ze(Qe.empty(),Qe.empty())}static fromBoard(t){return new Ze(Qe.fromBoard(t,"white"),Qe.fromBoard(t,"black"))}clone(){return new Ze(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new Ze(this.white.add(t.white),this.black.add(t.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class tn{constructor(t,e){this.white=t,this.black=e}static default(){return new tn(3,3)}clone(){return new tn(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}function en(t){return void 0!==t}function nn(t){return"white"===t?"black":"white"}function on(t){return t>>3}function rn(t){return 7&t}function sn(t){switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function an(t){switch(t){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function cn(t){if(2!==t.length)return;const e=t.charCodeAt(0)-"a".charCodeAt(0),n=t.charCodeAt(1)-"1".charCodeAt(0);return e<0||e>=8||n<0||n>=8?void 0:e+8*n}function ln(t){return je[rn(t)]+ze[on(t)]}function dn(t){if("@"===t[1]&&4===t.length){const e=an(t[0]),n=cn(t.slice(2));if(e&&en(n))return{role:e,to:n}}else if(4===t.length||5===t.length){const e=cn(t.slice(0,2)),n=cn(t.slice(2,4));let o;if(5===t.length&&(o=an(t[4]),!o))return;if(en(e)&&en(n))return{from:e,to:n,promotion:o}}}function un(t,e){return"white"===t?"a"===e?2:6:"a"===e?58:62}var hn;!function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"}(hn||(hn={}));class pn extends Error{}function mn(t){return/^\d{1,4}$/.test(t)?parseInt(t,10):void 0}function fn(t){const e=an(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}}function gn(t){const e=Xe.empty();let n=7,o=0;for(let r=0;r<t.length;r++){const i=t[r];if("/"===i&&8===o)o=0,n--;else{const s=parseInt(i,10);if(s>0)o+=s;else{if(o>=8||n<0)return Re.err(new pn(hn.Board));const s=o+8*n,a=fn(i);if(!a)return Re.err(new pn(hn.Board));"~"===t[r+1]&&(a.promoted=!0,r++),e.set(s,a),o++}}}return 0!==n||8!==o?Re.err(new pn(hn.Board)):Re.ok(e)}function vn(t){if(t.length>64)return Re.err(new pn(hn.Pockets));const e=Ze.empty();for(const n of t){const t=fn(n);if(!t)return Re.err(new pn(hn.Pockets));e[t.color][t.role]++}return Re.ok(e)}function bn(t){const e=t.split("+");if(3===e.length&&""===e[0]){const t=mn(e[1]),n=mn(e[2]);return!en(t)||t>3||!en(n)||n>3?Re.err(new pn(hn.RemainingChecks)):Re.ok(new tn(3-t,3-n))}if(2===e.length){const t=mn(e[0]),n=mn(e[1]);return!en(t)||t>3||!en(n)||n>3?Re.err(new pn(hn.RemainingChecks)):Re.ok(new tn(t,n))}return Re.err(new pn(hn.RemainingChecks))}function yn(t){const e=t.split(" "),n=e.shift();let o,r,i=Re.ok(void 0);if(n.endsWith("]")){const t=n.indexOf("[");if(-1===t)return Re.err(new pn(hn.Fen));o=gn(n.substr(0,t)),i=vn(n.substr(t+1,n.length-1-t-1))}else{const t=function(t,e,n){let o=t.indexOf(e);for(;n-- >0&&-1!==o;)o=t.indexOf(e,o+e.length);return o}(n,"/",7);-1===t?o=gn(n):(o=gn(n.substr(0,t)),i=vn(n.substr(t+1)))}const s=e.shift();if(en(s)&&"w"!==s){if("b"!==s)return Re.err(new pn(hn.Turn));r="black"}else r="white";return o.chain((t=>{const n=e.shift(),o=en(n)?function(t,e){let n=Ye.empty();if("-"===e)return Re.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(e))return Re.err(new pn(hn.Castling));for(const o of e){const e=o.toLowerCase(),r=o===e?"black":"white",i=Ye.backrank(r).intersect(t[r]);let s;s="q"===e?i:"k"===e?i.reversed():Ye.fromSquare(e.charCodeAt(0)-"a".charCodeAt(0)).intersect(i);for(const o of s){if(t.king.has(o)&&!t.promoted.has(o))break;if(t.rook.has(o)){n=n.with(o);break}}}return Re.ok(n)}(t,n):Re.ok(Ye.empty()),s=e.shift();let a;if(en(s)&&"-"!==s&&(a=cn(s),!en(a)))return Re.err(new pn(hn.EpSquare));let c,l=e.shift();en(l)&&l.includes("+")&&(c=bn(l),l=e.shift());const d=en(l)?mn(l):0;if(!en(d))return Re.err(new pn(hn.Halfmoves));const u=e.shift(),h=en(u)?mn(u):1;if(!en(h))return Re.err(new pn(hn.Fullmoves));const p=e.shift();let m=Re.ok(void 0);if(en(p)){if(en(c))return Re.err(new pn(hn.RemainingChecks));m=bn(p)}else en(c)&&(m=c);return e.length>0?Re.err(new pn(hn.Fen)):i.chain((e=>o.chain((n=>m.map((o=>({board:t,pockets:e,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:d,fullmoves:Math.max(1,h)})))))))}))}function wn(t,e){let n=sn(t.role);return"white"===t.color&&(n=n.toUpperCase()),(null==e?void 0:e.promoted)&&t.promoted&&(n+="~"),n}function kn(t,e){let n="",o=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const s=i+8*r,a=t.get(s);a?(o>0&&(n+=o,o=0),n+=wn(a,e)):o++,7===i&&(o>0&&(n+=o,o=0),0!==r&&(n+="/"))}return n}const Cn=lichess.storage;function xn(t,e){const n="analyse."+t,o=!0===e||!1===e;let r;return function(t){return I(t)&&t!=r?(r=t+"",Cn.set(n,t)):I(r)||(r=Cn.get(n),null===r&&(r=e+"")),o?"true"===r:r}}const Sn=(t,e)=>n=>{if(I(n))return Cn.set(t,JSON.stringify(n)),n;const o=JSON.parse(Cn.get(t));return null!==o?o:e()};const Mn=[["normal","normalAnalysis"],["practice","practiceWithComputer"],["conceal","hideNextMoves"],["gamebook","interactiveLesson"]],Pn=(t,e)=>{var n;return null===(n=t.target.querySelector("#chapter-"+e))||void 0===n?void 0:n.value};function En(t,e,n,o){const r={variants:[],open:!1,initial:q(!1),tab:xn("study.form.tab","init"),editor:null,editorFen:q(null),isDefaultName:!0};function i(){r.variants.length||B("/variant",{cache:"default"}).then((function(t){r.variants=t,o.redraw()}))}function s(){r.open=!0,i(),r.initial(!1)}function a(){r.open=!1}return{vm:r,open:s,root:o,openInitial(){s(),r.initial(!0)},close:a,toggle(){r.open?a():s()},submit(e){const i=o.study,s={...e,sticky:i.vm.mode.sticky,initial:r.initial()};var c,l;s.pgn?(c=i.data.id,l=s,B(`/study/${c}/import-pgn?sri=${lichess.sri}`,{method:"POST",body:G(l)})):t("addChapter",s),a(),n()},chapters:e,startTour:()=>function(t){lichess.loadScript("javascripts/study/tour-chapter.js").then((()=>{window.lichess.studyTourChapter({setTab:t})}))}((t=>{r.tab(t),o.redraw()})),multiPgnMax:32,redraw:o.redraw}}function An(t){return m("div.form-actions.single",m("button.button",{attrs:{type:"submit"}},t))}function Tn(t){return"orientation"in t}function In(t,e){const n=e.practice?"practice":I(e.conceal)?"conceal":e.gamebook?"gamebook":"normal";return[m("div.form-split",[m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-orientation"}},t.trans.noarg("orientation")),m("select#chapter-orientation.form-control",["white","black"].map((function(n){return $e(n,e.orientation,t.trans.noarg(n))})))]),m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-mode"}},t.trans.noarg("analysisMode")),m("select#chapter-mode.form-control",Mn.map((e=>$e(e[0],n,t.trans.noarg(e[1])))))])]),m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-description"}},t.trans.noarg("pinnedChapterComment")),m("select#chapter-description.form-control",[["",t.trans.noarg("noPinnedComment")],["1",t.trans.noarg("rightUnderTheBoard")]].map((t=>$e(t[0],e.description?"1":"",t[1]))))]),An(t.trans.noarg("saveChapter"))]}function $n(t,e,n,o,r){const i=q(t),s=En(e,i,n,r),a=function(t,e,n,o){const r=q(null);function i(t){r({id:t.id,name:t.name}),e(t.id).then((t=>{r(t),o()}))}function s(t){const e=r();return!!e&&e.id===t}return{open:i,toggle(t){s(t.id)?r(null):i(t)},current:r,submit(e){const n=r();n&&(t("editChapter",{id:n.id,...e}),r(null))},delete(e){t("deleteChapter",e),r(null)},clearAnnotations(e){t("clearAnnotations",e),r(null)},isEditing:s,trans:n,redraw:o}}(e,o,r.trans,r.redraw);return{newForm:s,editForm:a,list:i,get:t=>i().find((e=>e.id===t)),size:()=>i().length,sort(t){e("sortChapters",t)},firstChapterId:()=>i()[0].id,toggleNewForm(){s.vm.open||i().length<64?s.toggle():alert("You have reached the limit of 64 chapters per study. Please create a new study.")},localPaths:{}}}function _n(t){const e=Nn(t.tags,"result");return e&&"*"!==e}function Nn(t,e){const n=t.find((t=>t[0].toLowerCase()===e));return n&&n[1]}function Dn(t){const e=t.members.canContribute(),n=t.currentChapter();function o(o){const r=t.chapters.list().length,i=o.data.li,s=o.elm;if(i.count!==r?n.id!==t.chapters.firstChapterId()&&_e(s,s.querySelector(".active")):t.vm.loading&&i.loadingId!==t.vm.nextChapterId&&(i.loadingId=t.vm.nextChapterId,_e(s,s.querySelector(".loading"))),i.count=r,e&&r>1&&!i.sortable){const e=function(){i.sortable=window.Sortable.create(s,{draggable:".draggable",handle:"ontouchstart"in window?"span":void 0,onSort(){t.chapters.sort(i.sortable.toArray())}})};window.Sortable?e():lichess.loadScript("javascripts/vendor/Sortable.min.js").then(e)}}return m("div.study__chapters",{hook:{insert(e){e.elm.addEventListener("click",(e=>{const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");if(o)if("act"===n.className){const e=t.chapters.get(o);e&&t.chapters.editForm.toggle(e)}else t.setChapter(o)})),e.data.li={},o(e),lichess.pubsub.emit("chat.resize")},postpatch(t,e){e.data.li=t.data.li,o(e)},destroy:t=>{const e=t.data.li.sortable;e&&e.destroy()}}},t.chapters.list().map(((o,r)=>{var i;const s=t.chapters.editForm.isEditing(o.id),a=t.vm.loading&&o.id===t.vm.nextChapterId,c=!t.vm.loading&&n&&!(null===(i=t.relay)||void 0===i?void 0:i.tourShow.active)&&n.id===o.id;return m("div",{key:o.id,attrs:{"data-id":o.id},class:{active:c,editing:s,loading:a,draggable:e}},[m("span",a?m("span.ddloader"):[""+(r+1)]),m("h3",o.name),o.ongoing?m("ongoing",{attrs:{...E(""),title:"Ongoing"}}):null,!o.ongoing&&o.res?m("res",o.res):null,e?m("i.act",{attrs:E("")}):null])})).concat(t.members.canContribute()?[m("div.add",{hook:S("click",t.chapters.toggleNewForm,t.redraw)},[m("span",Pe("")),m("h3",t.trans.noarg("addNewChapter"))])]:[]))}function qn(t){return Rn(t)?!t.ceval.mate&&Math.abs(t.ceval.cp)<150:null}function On(t,e,n){if(!Rn(t))return null;const o=t.ceval.mate>0?99999:t.ceval.mate<0?-99999:t.ceval.cp;return"white"===n?o>=e:o<=e}function Rn(t){return t.ceval&&t.ceval.depth>=16}function Ln(t,e,n){const o=t.node;if(!o.uci)return null;const r=t.outcome();if(r&&r.winner&&r.winner!==t.bottomColor())return!1;if(r&&r.winner&&r.winner===t.bottomColor())return!0;if((i=t.practice.comment())&&("mistake"===i.verdict||"blunder"===i.verdict))return!1;var i;switch(e.result){case"drawIn":case"equalIn":if(o.threefold)return!0;if(!1===qn(o))return!1;if(n>e.moves)return!1;if(r&&!r.winner)return!0;if(n>=e.moves)return qn(o);break;case"evalIn":if(n>=e.moves)return On(o,e.cp,t.bottomColor());break;case"mateIn":{if(n>e.moves)return!1;const r=function(t,e){if(!Rn(t))return null;if(!t.ceval.mate)return!1;const n=t.ceval.mate*("white"===e?1:-1);return n>0&&n}(o,t.bottomColor());if(null===r)return null;if(!r||r+n>e.moves)return!1;break}case"promotion":return o.uci[4]?On(o,e.cp,t.bottomColor()):null}return null}function Fn(t,e,n){const o=q(t.data.practiceGoal),r=q(0),i=q(null),s=q(""),a=xn("practice-auto-next",!0);function c(){t.showAutoShapes=Me(!0),t.showGauge=Me(!0),t.showComputer=Me(!0),o(t.data.practiceGoal),r(0),i(null);const a=e.chapter;history.replaceState(null,a.name,n.url+"/"+a.id),s("/analysis/standard/"+t.node.fen.replace(/ /g,"_")+"?color="+t.bottomColor())}function l(){return t.study}function d(){const e=l().gamebookPlay();if(e)return void("end"===e.state.feedback&&u());if(!l().data.chapter.practice)return h();if(null!==i())return;r(function(){let e=t.node.ply-t.tree.root.ply;return t.bottomColor()!==t.data.player.color&&e--,Math.ceil(e/2)}());const n=i(Ln(t,o(),r()));n?u():!1===n&&(t.node.fail=!0,lichess.sound.play("practiceFailure"))}function u(){h(),lichess.sound.play("practiceSuccess"),e.chapter.practice&&a()&&setTimeout(l().goToNextChapter,1e3)}function h(){const t=l().currentChapter().id,e=n.completion[t];(void 0===e||r()<e)&&(n.completion[t]=r(),((t,e)=>{B(`/practice/complete/${t}/${e}`,{method:"POST"})})(t,r()))}return lichess.sound.loadOggOrMp3("practiceSuccess",`${lichess.sound.baseUrl}/other/energy3`,!0),lichess.sound.loadOggOrMp3("practiceFailure",`${lichess.sound.baseUrl}/other/failure2`,!0),c(),{onLoad:c,onJump(){!1!==i()||t.nodeList.find((t=>!!t.fail))||i(null),d()},onCeval:d,data:n,goal:o,success:i,nbMoves:r,reset(){t.tree.root.children=[],t.userJump(""),t.practice.reset(),c(),t.practice.resume()},isWhite:t.bottomIsWhite,analysisUrl:s,autoNext:a}}function Bn(t){return"object"==typeof t}function jn(t){return t?"string"==typeof t?t:t.name:"Unknown"}function zn(t,e){if(!t.node.comments)return;const n=t.node,o=t.study,r=o.currentChapter(),i=n.comments;return i.length?m("div",i.map((i=>{const s=i.by,a=Bn(s)&&s.id===t.opts.userId;if(!e&&a)return;const c=a||o.members.isOwner();return m("div.study__comment."+i.id,[c&&o.vm.mode.write?m("a.edit",{attrs:{"data-icon":"",title:"Delete"},hook:S("click",(e=>{confirm("Delete "+jn(s)+"'s comment?")&&o.commentForm.delete(r.id,t.path,i.id)}),t.redraw)}):null,(l=s,l?"string"==typeof l?l:m("span.user-link.ulpt",{attrs:{"data-href":"/@/"+l.id}},l.name):"Unknown"),...n.san?[" on ",m("span.node",Ee(n))]:[],": ",m("div.text",{hook:lt(i.text)})]);var l}))):void 0}function Gn(t,e){return m("div.study__comments",[zn(t,!0),m("div.study__message",e)])}function Vn(t,e){return function(n){return m("button",{hook:S("click",(e=>t.toggleGlyph(n.id)),t.redraw),attrs:{"data-symbol":n.symbol,type:"button"},class:{active:!!e.glyphs&&!!e.glyphs.find((t=>t.id===n.id))}},[n.name])}}function Hn(t){const e=q(null);const n=Ne(500,(e=>{t.study.makeChange("toggleGlyph",t.study.withPosition({id:e}))}));return{root:t,all:e,loadGlyphs:function(){e()||B(`/study/glyphs/${document.documentElement.lang}.json`,{cache:"default"}).then((n=>{e(n),t.redraw()}))},toggleGlyph:n,redraw:t.redraw}}function Wn(t){return m("div.study__glyphs",[m("div.study__message",t)])}function Un(t){return[m("label.form-label",{attrs:{for:"study-"+t.key}},t.name),m(`select#study-${t.key}.form-control`,t.choices.map((function(e){return m("option",{attrs:{value:e[0],selected:t.selected===e[0]}},e[1])})))]}function Kn(t){return m("div.study__topics",[...t.topics.getTopics().map((t=>m("a.topic",{attrs:{href:`/study/topic/${encodeURIComponent(t)}/hot`}},t))),t.members.canContribute()?m("a.manage",{hook:S("click",(()=>t.topics.open(!0)),t.redraw)},t.trans.noarg("manageTopics")):null])}let Jn;function Yn(t,e){return me({class:"study-topics",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg("topics")),m("form",{hook:P((e=>{const n=null==Jn?void 0:Jn.value;n&&t.save(n.map((t=>t.value)))}),t.redraw)},[m("textarea",{hook:x((t=>function(t,e){lichess.loadCssPath("tagify"),lichess.loadScript("vendor/tagify/tagify.min.js").then((()=>{const n=Jn=new window.Tagify(t,{pattern:/.{2,}/,maxTags:30});let o;n.on("input",(t=>{const r=t.detail.value.trim();r.length<2||(n.settings.whitelist.length=0,o&&o.abort(),o=new AbortController,n.loading(!0).dropdown.hide.call(n),B(V("/study/topic/autocomplete",{term:r,user:e}),{signal:o.signal}).then((t=>{n.settings.whitelist.splice(0,t.length,...t),n.loading(!1).dropdown.show.call(n,r)})))})),$(".tagify__input").each((function(){this.focus()}))}))}(t,e)))},t.getTopics().join(", ").replace(/[<>]/g,"")),m("button.button",{type:"submit"},t.trans.noarg("save"))])]})}function Xn(t){const e=t.get();return e?m("div.notif."+e.class,e.text):void 0}function Qn(t){const e={sync:void 0,promise:t.then((t=>(e.sync=t,t)))};return e}function Zn(t){switch(t){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return t}}const to=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class eo{constructor(t,e){this.send=t,this.opts=e,this.engineNameDeferred=function(){const t={};return t.promise=new Promise(((e,n)=>{t.resolve=e,t.reject=n})),t}(),this.engineName=Qn(this.engineNameDeferred.promise),this.options=new Map([["Threads",1],["Hash",16],["MultiPV",1],["UCI_Variant","chess"]]),this.expectedPvs=1}init(){this.send("uci"),this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true")}setOption(t,e){this.options.get(t)!==e&&(this.send(`setoption name ${t} value ${e}`),this.options.set(t,e))}received(t){if(t.startsWith("id name "))this.engineNameDeferred.resolve(t.substring("id name ".length));else if(t.startsWith("bestmove "))return this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,void this.swapWork();if(!this.work||this.work.stopRequested)return;const e=t.match(to);if(!e)return;const n=parseInt(e[1]),o=parseInt(e[2]),r="mate"===e[3],i=parseInt(e[4]),s=e[5],a=parseInt(e[6]),c=parseInt(e[7]),l=e[8].split(" ");if(r&&!i)return;if(this.expectedPvs<o&&(this.expectedPvs=o),n<6)return;const d=this.work.threatMode?0:1,u=this.work.ply%2===d?-i:i;if(s&&1===o)return;const h={moves:l,cp:r?void 0:u,mate:r?u:void 0,depth:n};1===o?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:n,knps:a/c,nodes:a,cp:r?void 0:u,mate:r?u:void 0,pvs:[h],millis:c}:this.currentEval&&(this.currentEval.pvs.push(h),this.currentEval.depth=Math.min(this.currentEval.depth,n)),o===this.expectedPvs&&this.currentEval&&(this.work.emit(this.currentEval),n>=this.work.maxDepth&&c>8e3&&a>4e3*Math.exp(.3*this.work.maxDepth)&&this.stop())}swapWork(){this.stop(),this.work||(this.work=this.nextWork,this.nextWork=void 0,this.work&&(this.currentEval=void 0,this.expectedPvs=1,this.setOption("UCI_Variant","antichess"===this.opts.variant?"giveaway":Zn(this.opts.variant)),this.setOption("Threads",this.opts.threads?this.opts.threads():1),this.setOption("Hash",this.opts.hashSize?this.opts.hashSize():16),this.setOption("MultiPV",this.work.multiPv),this.send(["position fen",this.work.initialFen,"moves",...this.work.moves].join(" ")),this.send(this.work.maxDepth>=99?"go depth 245":"go movetime 90000")))}start(t){this.nextWork=t,this.swapWork()}stop(){this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,this.send("stop"))}isComputing(){return!!this.work&&!this.work.stopRequested}}class no{constructor(t,e){this.protocolOpts=t,this.opts=e,this.isComputing=()=>!!this.protocol.sync&&this.protocol.sync.isComputing(),this.engineName=()=>{var t;return null===(t=this.protocol.sync)||void 0===t?void 0:t.engineName.sync},this.protocol=Qn(this.boot())}stop(){return this.protocol.promise.then((t=>t.stop()))}start(t){return this.protocol.promise.then((e=>e.start(t)))}}class oo extends no{boot(){this.worker=new Worker(lichess.assetUrl(this.opts.url,{sameDomain:!0}));const t=new eo(this.send.bind(this),this.protocolOpts);return this.worker.addEventListener("message",(e=>{t.received(e.data)}),!0),t.init(),Promise.resolve(t)}destroy(){this.worker.terminate()}send(t){this.worker.postMessage(t)}}class ro extends no{async boot(){let t=ro.protocols[this.opts.module];if(!t){const e=this.opts.version,n=this.opts.cache;let o;if(n){const t=this.opts.baseUrl+"stockfish.wasm";if(n)try{const[r,i]=await n.get(t,e);r&&(o=i)}catch(Be){console.log("ceval: idb cache load failed:",Be)}o||(o=await new Promise(((n,o)=>{const r=new XMLHttpRequest;r.open("GET",lichess.assetUrl(t,{version:e}),!0),r.responseType="arraybuffer",r.onerror=t=>o(t),r.onprogress=t=>{var e,n;return null===(n=(e=this.opts).downloadProgress)||void 0===n?void 0:n.call(e,t.loaded)},r.onload=t=>{var e,o;null===(o=(e=this.opts).downloadProgress)||void 0===o||o.call(e,0),n(r.response)},r.send()})));try{await n.set(t,e,o)}catch(Be){console.log("ceval: idb cache store failed:",Be)}}await lichess.loadScript(this.opts.baseUrl+"stockfish.js",{version:e});const r=await window[this.opts.module]({wasmBinary:o,locateFile:t=>lichess.assetUrl(this.opts.baseUrl+t,{version:e,sameDomain:t.endsWith(".worker.js")}),wasmMemory:this.opts.wasmMemory});ro.sf[this.opts.module]=r,t=new eo(this.send.bind(this),this.protocolOpts),r.addMessageListener(t.received.bind(t)),t.init(),ro.protocols[this.opts.module]=t}return t}destroy(){var t;null===(t=this.protocol.sync)||void 0===t||t.stop()}send(t){var e;null===(e=ro.sf[this.opts.module])||void 0===e||e.postMessage(t)}}function io(t){return 2/(1+Math.exp(-.004*t))-1}function so(t){return void 0!==t.mate?(n=t.mate,io(100*(21-Math.min(10,Math.abs(n)))*(n>0?1:-1))):(e=t.cp,io(Math.min(Math.max(-1e3,e),1e3)));var e,n}function ao(t,e){return function(t,e){return"white"===t?e:-e}(t,so(e))}function co(t,e,n){return(ao(t,e)-ao(t,n))/2}function lo(t,e){return t.depth>e.depth||t.depth===e.depth&&t.nodes>e.nodes}function uo(t){return((t=Math.max(Math.min(Math.round(t/10)/10,99),-99))>0?"+":"")+t.toFixed(1)}function ho(t,e){return!!e.startsWith("O-O")||"crazyhouse"!==t&&(!!e.includes("x")||(e.toLowerCase()===e||"threeCheck"===t&&e.includes("+")))}function po(t){return new Promise(((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)}))}function mo(t,e){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var e=function(){return indexedDB.databases().finally(t)};o=setInterval(e,100),e()})).finally((function(){return clearInterval(o)})):Promise.resolve()).then((()=>{const n=indexedDB.open(t);return n.onupgradeneeded=()=>n.result.createObjectStore(e),po(n)}));var o;return(t,o)=>n.then((n=>o(n.transaction(e,t).objectStore(e))))}let fo;function go(){return fo||(fo=mo("keyval-store","keyval")),fo}function vo(t,e=go()){return e("readonly",(e=>po(e.get(t))))}function bo(t,e,n=go()){return n("readwrite",(n=>(n.put(e,t),po(n.transaction))))}ro.protocols={},ro.sf={};class yo{constructor(t){this.store=mo(`${t}--db`,`${t}--store`)}async get(t,e){if(await vo(`${t}--version`,this.store)!==e)return[!1,void 0];return[!0,await vo(`${t}--data`,this.store)]}async set(t,e,n){await vo(`${t}--version`,this.store)!==e&&(await function(t,e=go()){return e("readwrite",(e=>(e.delete(t),po(e.transaction))))}(`${t}--version`,this.store),await bo(`${t}--data`,n,this.store),await bo(`${t}--version`,e,this.store))}}function wo(t,e){let n=Ye.empty();for(const o of e){const e=t+o;0<=e&&e<64&&Math.abs(rn(t)-rn(e))<=2&&(n=n.with(e))}return n}function ko(t){const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e}const Co=ko((t=>wo(t,[-9,-8,-7,-1,1,7,8,9]))),xo=ko((t=>wo(t,[-17,-15,-10,-6,6,10,15,17]))),So={white:ko((t=>wo(t,[7,9]))),black:ko((t=>wo(t,[-7,-9])))};function Mo(t){return Co[t]}function Po(t){return xo[t]}function Eo(t,e){return So[t][e]}const Ao=ko((t=>Ye.fromFile(rn(t)).without(t))),To=ko((t=>Ye.fromRank(on(t)).without(t))),Io=ko((t=>{const e=new Ye(134480385,2151686160),n=8*(on(t)-rn(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)})),$o=ko((t=>{const e=new Ye(270549120,16909320),n=8*(on(t)+rn(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}));function _o(t,e,n){let o=n.intersect(e),r=o.bswap64();return o=o.minus64(t),r=r.minus64(t.bswap64()),o.xor(r.bswap64()).intersect(e)}function No(t,e){const n=Ye.fromSquare(t);return _o(n,Io[t],e).xor(_o(n,$o[t],e))}function Do(t,e){return function(t,e){return _o(Ye.fromSquare(t),Ao[t],e)}(t,e).xor(function(t,e){const n=To[t];let o=e.intersect(n),r=o.rbit64();return o=o.minus64(Ye.fromSquare(t)),r=r.minus64(Ye.fromSquare(63-t)),o.xor(r.rbit64()).intersect(n)}(t,e))}function qo(t,e){return No(t,e).xor(Do(t,e))}function Oo(t,e){const n=Ye.fromSquare(e);return To[t].intersects(n)?To[t].with(t):$o[t].intersects(n)?$o[t].with(t):Io[t].intersects(n)?Io[t].with(t):Ao[t].intersects(n)?Ao[t].with(t):Ye.empty()}function Ro(t,e){return Oo(t,e).intersect(Ye.full().shl64(t).xor(Ye.full().shl64(e))).withoutFirst()}var Lo;!function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"}(Lo||(Lo={}));class Fo extends Error{}function Bo(t,e){return"white"===t?"a"===e?3:5:"a"===e?59:61}class jo{constructor(){}static default(){const t=new jo;return t.unmovedRooks=Ye.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new Ye(14,0),h:new Ye(96,0)},black:{a:new Ye(0,234881024),h:new Ye(0,1610612736)}},t}static empty(){const t=new jo;return t.unmovedRooks=Ye.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:Ye.empty(),h:Ye.empty()},black:{a:Ye.empty(),h:Ye.empty()}},t}clone(){const t=new jo;return t.unmovedRooks=this.unmovedRooks,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,n,o){const r=un(t,e),i=Bo(t,e);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[t][e]=o,this.path[t][e]=Ro(o,i).with(i).union(Ro(n,r).with(r)).without(n).without(o)}static fromSetup(t){const e=jo.empty(),n=t.unmovedRooks.intersect(t.board.rook);for(const o of Ge){const r=Ye.backrank(o),i=t.board.kingOf(o);if(!en(i)||!r.has(i))continue;const s=n.intersect(t.board[o]).intersect(r),a=s.first();en(a)&&a<i&&e.add(o,"a",i,a);const c=s.last();en(c)&&i<c&&e.add(o,"h",i,c)}return e}discardRook(t){if(this.unmovedRooks.has(t)){this.unmovedRooks=this.unmovedRooks.without(t);for(const e of Ge)for(const n of He)this.rook[e][n]===t&&(this.rook[e][n]=void 0)}}discardSide(t){this.unmovedRooks=this.unmovedRooks.diff(Ye.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class zo extends class{constructor(t){this.rules=t}kingAttackers(t,e,n){return function(t,e,n,o){return n[e].intersect(Do(t,o).intersect(n.rooksAndQueens()).union(No(t,o).intersect(n.bishopsAndQueens())).union(Po(t).intersect(n.knight)).union(Mo(t).intersect(n.king)).union(Eo(nn(e),t).intersect(n.pawn)))}(t,e,this.board,n)}dropDests(t){return Ye.empty()}playCaptureAt(t,e){this.halfmoves=0,"rook"===e.role&&this.castles.discardRook(t),this.pockets&&this.pockets[nn(e.color)][e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!en(e))return{king:e,blockers:Ye.empty(),checkers:Ye.empty(),variantEnd:t,mustCapture:!1};const n=Do(e,Ye.empty()).intersect(this.board.rooksAndQueens()).union(No(e,Ye.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[nn(this.turn)]);let o=Ye.empty();for(const r of n){const t=Ro(e,r).intersect(this.board.occupied);t.moreThanOne()||(o=o.union(t))}return{king:e,blockers:o,checkers:this.kingAttackers(e,nn(this.turn),this.board.occupied),variantEnd:t,mustCapture:!1}}clone(){var t,e;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(t=this.pockets)||void 0===t?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(t){var e,n;return this.rules===t.rules&&(this.pockets?this.board.equals(t.board):this.board.equalsIgnorePromoted(t.board))&&(t.pockets&&(null===(e=this.pockets)||void 0===e?void 0:e.equals(t.pockets))||!this.pockets&&!t.pockets)&&this.turn===t.turn&&this.castles.unmovedRooks.equals(t.castles.unmovedRooks)&&this.legalEpSquare()===t.legalEpSquare()&&(t.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(t.remainingChecks))||!this.remainingChecks&&!t.remainingChecks)}toSetup(){var t,e;return{board:this.board.clone(),pockets:null===(t=this.pockets)||void 0===t?void 0:t.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Ge.every((t=>this.hasInsufficientMaterial(t)))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(We(t))return!(!this.pockets||this.pockets[this.turn][t.role]<=0)&&(("pawn"!==t.role||!Ye.backranks().has(t.to))&&this.dropDests(e).has(t.to));{if("pawn"===t.promotion)return!1;if("king"===t.promotion&&"antichess"!==this.rules)return!1;if(!!t.promotion!==(this.board.pawn.has(t.from)&&Ye.backranks().has(t.to)))return!1;const n=this.dests(t.from,e);return n.has(t.to)||n.has(this.normalizeMove(t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return en(t)&&this.kingAttackers(t,nn(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return!!(t?t.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(t))}isCheckmate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:nn(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const n of this.board[this.turn])e.set(n,this.dests(n,t));return e}castlingSide(t){if(We(t))return;const e=t.to-t.from;return(2===Math.abs(e)||this.board[this.turn].has(t.to))&&this.board.king.has(t.from)?e>0?"h":"a":void 0}normalizeMove(t){const e=this.castlingSide(t);if(!e)return t;const n=this.castles.rook[this.turn][e];return{from:t.from,to:en(n)?n:t.to}}play(t){const e=this.turn,n=this.epSquare,o=this.castlingSide(t);if(this.epSquare=void 0,this.halfmoves+=1,"black"===e&&(this.fullmoves+=1),this.turn=nn(e),We(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,"pawn"===t.role&&(this.halfmoves=0);else{const r=this.board.take(t.from);if(!r)return;let i;if("pawn"===r.role){this.halfmoves=0,t.to===n&&(i=this.board.take(t.to+("white"===e?-8:8)));const o=t.from-t.to;16===Math.abs(o)&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(r.role=t.promotion,r.promoted=!0)}else if("rook"===r.role)this.castles.discardRook(t.from);else if("king"===r.role){if(o){const t=this.castles.rook[e][o];if(en(t)){const n=this.board.take(t);this.board.set(un(e,o),r),n&&this.board.set(Bo(e,o),n)}}this.castles.discardSide(e)}if(!o){const e=this.board.set(t.to,r)||i;e&&this.playCaptureAt(t.to,e)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[e]=Math.max(this.remainingChecks[e]-1,0))}legalEpSquare(t){if(!en(this.epSquare))return;t=t||this.ctx();const e=this.board.pieces(this.turn,"pawn").intersect(Eo(nn(this.turn),this.epSquare));for(const n of e)if(this.dests(n,t).has(this.epSquare))return this.epSquare}}{constructor(t){super(t||"chess")}static default(){const t=new this;return t.board=Xe.default(),t.pockets=void 0,t.turn="white",t.castles=jo.default(),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t,e){const n=new this;return n.board=t.board.clone(),n.pockets=void 0,n.turn=t.turn,n.castles=jo.fromSetup(t),n.epSquare=n.validEpSquare(t.epSquare),n.remainingChecks=void 0,n.halfmoves=t.halfmoves,n.fullmoves=t.fullmoves,n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){if(this.board.occupied.isEmpty())return Re.err(new Fo(Lo.Empty));if(2!==this.board.king.size())return Re.err(new Fo(Lo.Kings));if(!en(this.board.kingOf(this.turn)))return Re.err(new Fo(Lo.Kings));const e=this.board.kingOf(nn(this.turn));return en(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?Re.err(new Fo(Lo.OppositeCheck)):Ye.backranks().intersects(this.board.pawn)?Re.err(new Fo(Lo.PawnsOnBackrank)):(null==t?void 0:t.ignoreImpossibleCheck)?Re.ok(void 0):this.validateCheckers():Re.err(new Fo(Lo.Kings))}validateCheckers(){const t=this.board.kingOf(this.turn);if(en(t)){const e=this.kingAttackers(t,nn(this.turn),this.board.occupied);if(e.size()>2||2===e.size()&&Oo(e.first(),e.last()).has(t))return Re.err(new Fo(Lo.ImpossibleCheck));if(en(this.epSquare))for(const n of e)if(Oo(n,this.epSquare).has(t))return Re.err(new Fo(Lo.ImpossibleCheck))}return Re.ok(void 0)}validEpSquare(t){if(!en(t))return;const e="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(on(t)!==e)return;if(this.board.occupied.has(t+n))return;const o=t-n;return this.board.pawn.has(o)&&this.board[nn(this.turn)].has(o)?t:void 0}castlingDest(t,e){if(!en(e.king)||e.checkers.nonEmpty())return Ye.empty();const n=this.castles.rook[this.turn][t];if(!en(n))return Ye.empty();if(this.castles.path[this.turn][t].intersects(this.board.occupied))return Ye.empty();const o=un(this.turn,t),r=Ro(e.king,o),i=this.board.occupied.without(e.king);for(const c of r)if(this.kingAttackers(c,nn(this.turn),i).nonEmpty())return Ye.empty();const s=Bo(this.turn,t),a=this.board.occupied.toggle(e.king).toggle(n).toggle(s);return this.kingAttackers(o,nn(this.turn),a).nonEmpty()?Ye.empty():Ye.fromSquare(n)}canCaptureEp(t,e){if(!en(this.epSquare))return!1;if(!Eo(this.turn,t).has(this.epSquare))return!1;if(!en(e.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(t).toggle(this.epSquare).toggle(n);return!this.kingAttackers(e.king,nn(this.turn),o).intersects(o)}pseudoDests(t,e){if(e.variantEnd)return Ye.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return Ye.empty();let o=function(t,e,n){switch(t.role){case"pawn":return Eo(t.color,e);case"knight":return Po(e);case"bishop":return No(e,n);case"rook":return Do(e,n);case"queen":return qo(e,n);case"king":return Mo(e)}}(n,t,this.board.occupied);if("pawn"===n.role){let e=this.board[nn(this.turn)];en(this.epSquare)&&(e=e.with(this.epSquare)),o=o.intersect(e);const n="white"===this.turn?8:-8,r=t+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const e=r+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}return o}return o=o.diff(this.board[this.turn]),t===e.king?o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e)):o}dests(t,e){if((e=e||this.ctx()).variantEnd)return Ye.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return Ye.empty();let o,r;if("pawn"===n.role){o=Eo(this.turn,t).intersect(this.board[nn(this.turn)]);const n="white"===this.turn?8:-8,i=t+n;if(0<=i&&i<64&&!this.board.occupied.has(i)){o=o.with(i);const e=i+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}if(en(this.epSquare)&&this.canCaptureEp(t,e)){const t=this.epSquare-n;(e.checkers.isEmpty()||e.checkers.singleSquare()===t)&&(r=Ye.fromSquare(this.epSquare))}}else o="bishop"===n.role?No(t,this.board.occupied):"knight"===n.role?Po(t):"rook"===n.role?Do(t,this.board.occupied):"queen"===n.role?qo(t,this.board.occupied):Mo(t);if(o=o.diff(this.board[this.turn]),en(e.king)){if("king"===n.role){const n=this.board.occupied.without(t);for(const t of o)this.kingAttackers(t,nn(this.turn),n).nonEmpty()&&(o=o.without(t));return o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e))}if(e.checkers.nonEmpty()){const t=e.checkers.singleSquare();if(!en(t))return Ye.empty();o=o.intersect(Ro(t,e.king).with(t))}e.blockers.has(t)&&(o=o.intersect(Oo(t,e.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){if(this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[t].intersects(this.board.knight))return this.board[t].size()<=2&&this.board[nn(t)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[t].intersects(this.board.bishop)){return(!this.board.bishop.intersects(Ye.darkSquares())||!this.board.bishop.intersects(Ye.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}}class Go extends zo{constructor(){super("crazyhouse")}static default(){const t=super.default();return t.pockets=Ze.empty(),t}static fromSetup(t,e){return super.fromSetup(t,e).map((e=>(e.pockets=t.pockets?t.pockets.clone():Ze.empty(),e)))}validate(t){return super.validate(t).chain((t=>this.pockets&&(this.pockets.white.king>0||this.pockets.black.king>0)?Re.err(new Fo(Lo.Kings)):(this.pockets?this.pockets.count():0)+this.board.occupied.size()>64?Re.err(new Fo(Lo.Variant)):Re.ok(void 0)))}clone(){return super.clone()}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.count()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.white.pawn<=0&&this.pockets.black.pawn<=0&&this.pockets.white.rook<=0&&this.pockets.black.rook<=0&&this.pockets.white.queen<=0&&this.pockets.black.queen<=0:super.hasInsufficientMaterial(t)}dropDests(t){var e,n;const o=this.board.occupied.complement().intersect((null===(e=this.pockets)||void 0===e?void 0:e[this.turn].hasNonPawns())?Ye.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?Ye.backranks().complement():Ye.empty());if(en((t=t||this.ctx()).king)&&t.checkers.nonEmpty()){const e=t.checkers.singleSquare();return en(e)?o.intersect(Ro(e,t.king)):Ye.empty()}return o}}class Vo extends zo{constructor(){super("atomic")}static default(){return super.default()}static fromSetup(t,e){return super.fromSetup(t,e)}clone(){return super.clone()}validate(t){if(this.board.occupied.isEmpty())return Re.err(new Fo(Lo.Empty));if(this.board.king.size()>2)return Re.err(new Fo(Lo.Kings));const e=this.board.kingOf(nn(this.turn));return en(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?Re.err(new Fo(Lo.OppositeCheck)):Ye.backranks().intersects(this.board.pawn)?Re.err(new Fo(Lo.PawnsOnBackrank)):Re.ok(void 0):Re.err(new Fo(Lo.Kings))}kingAttackers(t,e,n){const o=this.board.pieces(e,"king");return o.isEmpty()||Mo(t).intersects(o)?Ye.empty():super.kingAttackers(t,e,n)}playCaptureAt(t,e){super.playCaptureAt(t,e),this.board.take(t);for(const n of Mo(t).intersect(this.board.occupied).diff(this.board.pawn)){const t=this.board.take(n);t&&"rook"===t.role&&this.castles.discardRook(n),t&&"king"===t.role&&this.castles.discardSide(t.color)}}hasInsufficientMaterial(t){if(this.board.pieces(nn(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[nn(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(Ye.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Ye.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(Ye.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Ye.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(!!this.board.knight.union(this.board.bishop).union(this.board.rook).isSingleSquare()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(t,e){e=e||this.ctx();let n=Ye.empty();for(const o of this.pseudoDests(t,e)){const e=this.clone();e.play({from:t,to:o});const r=e.board.kingOf(this.turn);!en(r)||en(e.board.kingOf(e.turn))&&!e.kingAttackers(r,e.turn,e.board.occupied).isEmpty()||(n=n.with(o))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const e of Ge)if(this.board.pieces(e,"king").isEmpty())return{winner:nn(e)}}}class Ho extends zo{constructor(){super("antichess")}static default(){const t=super.default();return t.castles=jo.empty(),t}static fromSetup(t,e){return super.fromSetup(t,e).map((t=>(t.castles=jo.empty(),t)))}clone(){return super.clone()}validate(t){return this.board.occupied.isEmpty()?Re.err(new Fo(Lo.Empty)):Ye.backranks().intersects(this.board.pawn)?Re.err(new Fo(Lo.PawnsOnBackrank)):Re.ok(void 0)}kingAttackers(t,e,n){return Ye.empty()}ctx(){const t=super.ctx(),e=this.board[nn(this.turn)];for(const n of this.board[this.turn])if(this.pseudoDests(n,t).intersects(e)){t.mustCapture=!0;break}return t}dests(t,e){e=e||this.ctx();const n=this.pseudoDests(t,e);return e.mustCapture?n.intersect(this.board[nn(this.turn)]):n}hasInsufficientMaterial(t){if(this.board.occupied.equals(this.board.bishop)){const e=this.board[t].intersects(Ye.lightSquares()),n=this.board[t].intersects(Ye.darkSquares()),o=this.board[nn(t)].isDisjoint(Ye.lightSquares()),r=this.board[nn(t)].isDisjoint(Ye.darkSquares());return e&&o||n&&r}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if((t=t||this.ctx()).variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Wo extends zo{constructor(){super("kingofthehill")}static default(){return super.default()}static fromSetup(t,e){return super.fromSetup(t,e)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(Ye.center())}variantOutcome(t){for(const e of Ge)if(this.board.pieces(e,"king").intersects(Ye.center()))return{winner:e}}}class Uo extends zo{constructor(){super("3check")}static default(){const t=super.default();return t.remainingChecks=tn.default(),t}static fromSetup(t,e){return super.fromSetup(t,e).map((e=>(e.remainingChecks=t.remainingChecks?t.remainingChecks.clone():tn.default(),e)))}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks)for(const e of Ge)if(this.remainingChecks[e]<=0)return{winner:e}}}class Ko extends zo{constructor(){super("racingkings")}static default(){const t=new this;return t.board=Xe.racingKings(),t.pockets=void 0,t.turn="white",t.castles=jo.empty(),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t,e){return super.fromSetup(t,e).map((t=>(t.castles=jo.empty(),t)))}validate(t){return this.isCheck()||this.board.pawn.nonEmpty()?Re.err(new Fo(Lo.Variant)):super.validate(t)}clone(){return super.clone()}dests(t,e){if(t===(e=e||this.ctx()).king)return super.dests(t,e);let n=Ye.empty();for(const o of super.dests(t,e)){const e={from:t,to:o},r=this.clone();r.play(e),r.isCheck()||(n=n.with(o))}return n}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=Ye.fromRank(7),e=this.board.king.intersect(t);if(e.isEmpty())return!1;if("white"===this.turn||e.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(en(n)){const e=this.board.occupied.without(n);for(const o of Mo(n).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",e).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const e=Ye.fromRank(7),n=this.board.pieces("black","king").intersects(e),o=this.board.pieces("white","king").intersects(e);return n&&!o?{winner:"black"}:o&&!n?{winner:"white"}:{winner:void 0}}}class Jo extends zo{constructor(){super("horde")}static default(){const t=new this;return t.board=Xe.horde(),t.pockets=void 0,t.turn="white",t.castles=jo.default(),t.castles.discardSide("white"),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t,e){return super.fromSetup(t,e)}validate(t){if(this.board.occupied.isEmpty())return Re.err(new Fo(Lo.Empty));if(!this.board.king.isSingleSquare())return Re.err(new Fo(Lo.Kings));if(!this.board.king.diff(this.board.promoted).isSingleSquare())return Re.err(new Fo(Lo.Kings));const e=this.board.kingOf(nn(this.turn));if(en(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return Re.err(new Fo(Lo.OppositeCheck));for(const n of Ge)if(this.board.pieces(n,"pawn").intersects(Ye.backrank(nn(n))))return Re.err(new Fo(Lo.PawnsOnBackrank));return(null==t?void 0:t.ignoreImpossibleCheck)?Re.ok(void 0):this.validateCheckers()}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}function Yo(t,e,n){switch(t){case"chess":return zo.fromSetup(e,n);case"antichess":return Ho.fromSetup(e,n);case"atomic":return Vo.fromSetup(e,n);case"horde":return Jo.fromSetup(e,n);case"racingkings":return Ko.fromSetup(e,n);case"kingofthehill":return Wo.fromSetup(e,n);case"3check":return Uo.fromSetup(e,n);case"crazyhouse":return Go.fromSetup(e,n)}}function Xo(t,e){return new WebAssembly.Memory({shared:!0,initial:t,maximum:e})}function Qo(){return lichess.tempStorage.get("ceval.enabled-after")===(lichess.storage.get("ceval.disable")||"1")}function Zo(t){var e;const n=e=>t.storageKeyPrefix?`${t.storageKeyPrefix}.${e}`:e,o=xn("ceval.enable-nnue",!(null===(e=navigator.connection)||void 0===e?void 0:e.saveData)),r=t.initialFen?yn(t.initialFen).unwrap():void 0,i=Zn(t.variant.key),s=!r||Yo(i,r).isOk,a=(!r||Ge.every((t=>{const e=r.board,n=e[t],o=Math.max(e.queen.intersect(n).size()-1,0)+Math.max(e.rook.intersect(n).size()-2,0)+Math.max(e.knight.intersect(n).size()-2,0)+Math.max(e.bishop.intersect(n).intersect(Ye.lightSquares()).size()-1,0)+Math.max(e.bishop.intersect(n).intersect(Ye.darkSquares()).size()-1,0);return e.pawn.intersect(n).size()+o<=8})))&&"chess"==i;let c="asmjs",l=!1,d=!1;const u=Uint8Array.from([0,97,115,109,1,0,0,0]);if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.validate&&WebAssembly.validate(u)){c="wasm";const t=function(t,e){if("object"!=typeof Atomics)return;if("function"!=typeof SharedArrayBuffer)return;const n=Xo(t,e);if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n,"*")}catch(Be){return}return n}}(8,16);if(t){c="hce";const e=Uint8Array.from([0,97,115,109,1,0,0,0,1,12,2,96,2,123,123,1,123,96,1,123,1,123,3,3,2,0,1,7,9,2,1,97,0,0,1,98,0,1,10,19,2,9,0,32,0,32,1,253,186,1,11,7,0,32,0,253,253,1,11]);d=WebAssembly.validate(e),d&&a&&o()&&(c="nnue");try{t.grow(8),l=!0}catch(Be){}}}const h=a?2:1,p=Math.min(Math.max((navigator.hardwareConcurrency||1)-1,1),l?32:h),m=xn(n("ceval.threads"),Math.min(Math.ceil((navigator.hardwareConcurrency||1)/4),p)),f="hce"==c||"nnue"==c?2:.5,g=Math.min(1024*(navigator.deviceMemory||f)/8,l?1024:16),v=xn(n("ceval.hash-size"),16),b=xn(n("ceval.multipv"),t.multiPvDefault||1),y=xn("ceval.infinite",!1);let w=null;const k=q(!0),C=q(t.possible&&s&&k()&&Qo()),x=q(0);let S=!1,M=!1;const P=q(null),E=q(null),A=q(!1),T={variant:t.variant.key,threads:("hce"==c||"nnue"==c)&&(()=>Math.min(parseInt(m()),p)),hashSize:("hce"==c||"nnue"==c)&&(()=>Math.min(parseInt(v()),g))};let I,$=null;const _=Ne(200,((e,n)=>{O(e.pvs,n.ply%2==(n.threatMode?1:0)?"white":"black"),w=e,t.emit(e,n),e.fen!==$&&Qo()&&($=e.fen,lichess.storage.fire("ceval.fen",e.fen))})),N=()=>w?w.depth:0,D=()=>A()||y()?99:function(t,e,n){switch(t){case"asmjs":return 18;case"wasm":return 20;default:return 22+Math.min(Math.max(e-n,0),6)}}(c,T.threads?T.threads():1,parseInt(b())),O=(t,e)=>t.sort((function(t,n){return ao(e,n)-ao(e,t)})),R=(e,n,o)=>{if(!C()||!t.possible||!Qo())return;const r=D(),i=n[n.length-1],s=o?i.threat:i.ceval;if(s&&s.depth>=r)return void(M={path:e,steps:n,threatMode:o});const d={initialFen:n[0].fen,moves:[],currentFen:i.fen,path:e,ply:i.ply,maxDepth:r,multiPv:parseInt(b()),threatMode:o,emit(t){C()&&_(t,d)},stopRequested:!1};if(o){const t=i.ply%2==1?"w":"b",e=i.fen.replace(/ (w|b) /," "+t+" ");d.currentFen=e,d.initialFen=e}else for(let a=1;a<n.length;a++){const e=n[a];ho(t.variant.key,e.san)?(d.moves=[],d.initialFen=e.fen):d.moves.push(e.uci)}lichess.storage.fire("ceval.disable"),lichess.tempStorage.set("ceval.enabled-after",lichess.storage.get("ceval.disable")),I||(I="nnue"==c?new ro(T,{baseUrl:"vendor/stockfish-nnue.wasm/",module:"Stockfish",downloadProgress:Ne(200,(e=>{x(e),t.redraw()})),version:"b6939d",wasmMemory:Xo(2048,l?32768:2048),cache:new yo("ceval-wasm-cache")}):"hce"==c?new ro(T,{baseUrl:a?"vendor/stockfish.wasm/":"vendor/stockfish-mv.wasm/",module:a?"Stockfish":"StockfishMv",version:"a022fa",wasmMemory:Xo(1024,l?32768:1088)}):new oo(T,{url:"wasm"==c?"vendor/stockfish.js/stockfish.wasm.js":"vendor/stockfish.js/stockfish.js"})),I.start(d),S=!0,M={path:e,steps:n,threatMode:o}};function L(){C()&&S&&(null==I||I.stop(),S=!1)}return{technology:c,start:(t,e,n)=>{A(!1),R(t,e,!!n)},stop:L,allowed:k,possible:t.possible,enabled:C,downloadProgress:x,multiPv:b,threads:"hce"==c||"nnue"==c?m:void 0,hashSize:"hce"==c||"nnue"==c?v:void 0,maxThreads:p,maxHashSize:g,infinite:y,supportsNnue:d,enableNnue:o,hovering:P,setHovering(e,n){P(n?{fen:e,uci:n}:null),t.setAutoShapes()},pvBoard:E,setPvBoard(e){E(e),t.redraw()},toggle(){if(t.possible&&k())if(L(),C()||document.hidden)lichess.tempStorage.set("ceval.enabled-after",""),C(!1);else{const t=lichess.storage.get("ceval.disable")||"1";t&&lichess.tempStorage.set("ceval.enabled-after",t),C(!0)}},curDepth:N,effectiveMaxDepth:D,variant:t.variant,isDeeper:A,goDeeper:function(){A(!0),M&&(y()?w&&t.emit(w,M):(L(),R(M.path,M.steps,M.threatMode)))},canGoDeeper:()=>N()<99&&!A()&&(!y()&&!(null==I?void 0:I.isComputing())||(()=>{var t;return!!M&&!!(null===(t=M.steps[M.steps.length-1].ceval)||void 0===t?void 0:t.cloud)})()),isComputing:()=>!!S&&!!(null==I?void 0:I.isComputing()),engineName:()=>null==I?void 0:I.engineName(),destroy:()=>null==I?void 0:I.destroy(),redraw:t.redraw,analysable:s}}function tr(t,e){var n;const o=function(t,e){let n="";if(We(e))"pawn"!==e.role&&(n=sn(e.role).toUpperCase()),n+="@"+ln(e.to);else{const o=t.board.getRole(e.from);if(!o)return"--";if("king"!==o||!t.board[t.turn].has(e.to)&&2!==Math.abs(e.to-e.from)){const r=t.board.occupied.has(e.to)||"pawn"===o&&rn(e.from)!==rn(e.to);if("pawn"!==o){let r;if(n=sn(o).toUpperCase(),r="king"===o?Mo(e.to).intersect(t.board.king):"queen"===o?qo(e.to,t.board.occupied).intersect(t.board.queen):"rook"===o?Do(e.to,t.board.occupied).intersect(t.board.rook):"bishop"===o?No(e.to,t.board.occupied).intersect(t.board.bishop):Po(e.to).intersect(t.board.knight),r=r.intersect(t.board[t.turn]).without(e.from),r.nonEmpty()){const o=t.ctx();for(const n of r)t.dests(n,o).has(e.to)||(r=r.without(n));if(r.nonEmpty()){let t=!1,o=r.intersects(Ye.fromRank(on(e.from)));r.intersects(Ye.fromFile(rn(e.from)))?t=!0:o=!0,o&&(n+=je[rn(e.from)]),t&&(n+=ze[on(e.from)])}}}else r&&(n=je[rn(e.from)]);r&&(n+="x"),n+=ln(e.to),e.promotion&&(n+="="+sn(e.promotion).toUpperCase())}else n=e.to>e.from?"O-O":"O-O-O"}return n}(t,e);return t.play(e),(null===(n=t.outcome())||void 0===n?void 0:n.winner)?o+"#":t.isCheck()?o+"+":o}let er=0;const nr=[...Array(8).keys()].map((t=>m(3===t?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(t+1)}%`}})));function or(t,e){const n=t.getCeval(),o=t.trans;if(!e.client){if(!n.analysable)return["Engine cannot analyze this position"];const r=n.downloadProgress()/1024/1024;return[e.server&&t.nextNodeBest()?o.noarg("usingServerAnalysis"):o.noarg("loadingEngine")+(r>=1?` (${r.toFixed(1)} MiB)`:"")]}const r=e.client.depth||0,i=e.client.cloud?[o("depthX",r),m("span.cloud",{attrs:{title:o.noarg("cloudAnalysis")}},"Cloud")]:[o("depthX",r+"/"+Math.max(r,e.client.maxDepth))];return n.canGoDeeper()?i.push(m("a.deeper",{attrs:{title:o.noarg("goDeeper"),"data-icon":""},hook:{insert:t=>t.elm.addEventListener("click",(()=>{n.goDeeper(),n.redraw()}))}})):!e.client.cloud&&e.client.knps&&i.push(", "+Math.round(e.client.knps)+"k nodes/s"),i}function rr(t,e){if(!e)return t.trans.noarg("loadingEngine");let n=t.trans("depthX",(e.depth||0)+"/"+e.maxDepth);return e.knps&&(n+=", "+Math.round(e.knps)+"k nodes/s"),n}function ir(t){return t.disableThreatMode&&t.disableThreatMode()?null:m("a.show-threat",{class:{active:t.threatMode(),hidden:!!t.getNode().check},attrs:{"data-icon":"",title:t.trans.noarg("showThreat")+" (x)"},hook:{insert:e=>e.elm.addEventListener("click",t.toggleThreatMode)}})}function sr(t){return[m("span",{attrs:{title:t.engineName()||""}},"nnue"==t.technology?"Stockfish 14+":"hce"==t.technology?"Stockfish 11+":"Stockfish 10+"),"nnue"==t.technology?m("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly with SIMD (efficiently updatable neural network, using 4x smaller net by Sopel97)"}},"NNUE"):"hce"==t.technology?m("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly (classical hand crafted evaluation)"}},"HCE"):"wasm"==t.technology?m("span.technology",{attrs:{title:"Single-threaded WebAssembly fallback (slow)"}},"WASM"):m("span.technology",{attrs:{title:"Single-threaded JavaScript fallback (very slow)"}},"ASMJS")]}function ar(t){const e=t.server,n=t.client;return e?n&&(n.nodes>4e6||void 0!==n.mate&&(void 0===e.mate||Math.abs(n.mate)<Math.abs(e.mate)))?n:e:n}function cr(t){if(t.ongoing||!t.showEvalGauge())return;const e=ar(t.currentEvals());let n;return e?(n=ao("white",e),er=n):n=er,m("div.eval-gauge",{class:{empty:null===n,reverse:"black"===t.getOrientation()}},[m("div.black",{attrs:{style:`height: ${100-50*(n+1)}%`}}),...nr])}function lr(t){const e=t.getCeval(),n=t.trans;if(!e.allowed()||!e.possible||!t.showComputer())return;const o=e.enabled(),r=t.currentEvals(),i=t.threatMode(),s=i&&t.getNode().threat,a=s||ar(r);let c,l;a&&void 0!==a.cp?(c=uo(a.cp),l=r.client?r.client.cloud?100:Math.min(100,Math.round(100*r.client.depth/r.client.maxDepth)):0):a&&I(a.mate)?(c="#"+a.mate,l=100):t.outcome()?(c="-",l=0):(c=m(o?"i.ddloader":"i"),l=0),i&&(l=s?Math.min(100,Math.round(100*s.depth/s.maxDepth)):0);const d=o?m("div.bar",m("span",{class:{threat:i},attrs:{style:`width: ${l}%`},hook:{postpatch:(t,e)=>{if(t.data.percent>l||!!t.data.threatMode!=i){const t=e.elm,n=t.parentNode;n.removeChild(t),n.appendChild(t)}e.data.percent=l,e.data.threatMode=i}}})):null,u=o?[m("pearl",[c]),m("div.engine",[...i?[n.noarg("showThreat")]:sr(e),m("span.info",t.outcome()?[n.noarg("gameOver")]:i?[rr(t,s)]:or(t,r))])]:[c?m("pearl",[c]):null,m("help",[...sr(e),m("br"),e.analysable?n.noarg("inLocalBrowser"):"Engine cannot analyse this game"])],h=t.mandatoryCeval&&t.mandatoryCeval()?null:m("div.switch",{attrs:{title:n.noarg("toggleLocalEvaluation")+" (L)"}},[m("input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle",{attrs:{type:"checkbox",checked:o,disabled:!e.analysable},hook:{insert:e=>e.elm.addEventListener("change",t.toggleCeval)}}),m("label",{attrs:{for:"analyse-toggle-ceval"}})]);return m("div.ceval"+(o?".enabled":""),{class:{computing:l<100&&e.isComputing()}},[d,...u,ir(t),h])}function dr(t){return t.getAttribute("data-fen")}function ur(t){return hr(t).filter(_).map((t=>t.split("|")[1]))}function hr(t){const e=[];return $(t.target).closest("div.pv").children().filter("span.pv-san").each((function(){e.push($(this).attr("data-board"))})),e}function pr(t,e){lichess.requestIdleCallback((()=>e.setHovering(dr(t),$(t).find("div.pv:hover").attr("data-uci")||void 0)),500)}function mr(t){const e=t.getCeval();if(!e.allowed()||!e.possible||!e.enabled())return;const n=parseInt(e.multiPv()),o=t.getNode(),r=yn(o.fen).unwrap();let i,s,a,c=!1;t.threatMode()&&o.threat?(i=o.threat.pvs,c=!0):i=o.ceval?o.ceval.pvs:[],c&&(r.turn=nn(r.turn),"white"==r.turn&&(r.fullmoves+=1));const l=Yo(Zn(e.variant.key),r);return m("div.pv_box",{attrs:{"data-fen":o.fen},hook:{insert:n=>{const o=n.elm;o.addEventListener("mouseover",(e=>{const n=t.getCeval();n.setHovering(dr(o),function(t){return $(t.target).closest("div.pv").attr("data-uci")||void 0}(e));const r=e.target.dataset.board;if(r){a=Number(e.target.dataset.moveIndex),s=hr(e);const[t,o]=r.split("|");n.setPvBoard({fen:t,uci:o})}})),o.addEventListener("wheel",(e=>{if(e.preventDefault(),null!=a&&null!=s){e.deltaY<0&&a>0?a-=1:e.deltaY>0&&a<s.length-1&&(a+=1);const n=s[a];if(n){const[e,o]=n.split("|");t.getCeval().setPvBoard({fen:e,uci:o})}}})),o.addEventListener("mouseout",(()=>t.getCeval().setHovering(dr(o))));for(const e of["touchstart","mousedown"])o.addEventListener(e,(e=>{const n=ur(e);n.length>(null!=a?a:0)&&!t.threatMode()&&(t.playUciList(n.slice(0,(null!=a?a:0)+1)),e.preventDefault())}));o.addEventListener("mouseleave",(()=>{t.getCeval().setPvBoard(null),a=null})),pr(o,e)},postpatch:(t,n)=>pr(n.elm,e)}},[...[...Array(n).keys()].map((t=>function(t,e,n,o){const r={},i=[fr()];n&&(t||(r.attrs={"data-uci":n.moves[0]}),e>1&&i.push(m("strong",I(n.mate)?"#"+n.mate:uo(n.cp))),o&&i.push(...function(t,e){const n=[];let o=kn(t.board);for(let r=0;r<e.length;r++){let i;"white"===t.turn?i=`${t.fullmoves}.`:0===r&&(i=`${t.fullmoves}...`),i&&n.push(m("span",{key:i},i));const s=e[r],a=tr(t,dn(s)),c=kn(t.board);if("--"===a)break;o+="|"+s,n.push(m("span.pv-san",{key:o,attrs:{"data-move-index":r,"data-board":`${c}|${s}`}},a))}return n}(o.clone(),n.moves.slice(0,16))));return m("div.pv.pv--nowrap",r,i)}(c,n,i[t],l.isOk?l.value:void 0))),gr(t)])}function fr(){return m("span.pv-wrap-toggle",{hook:{insert:t=>{const e=t.elm;for(const n of["touchstart","mousedown"])e.addEventListener(n,(t=>{t.stopPropagation(),t.preventDefault(),$(e).closest(".pv").toggleClass("pv--nowrap")}))}}})}function gr(t){const e=t.getCeval().pvBoard();if(!e)return;const{fen:n,uci:o}=e,r={fen:n,lastMove:"@"===o[1]?[o.slice(2)]:[o.slice(0,2),o.slice(2,4)],orientation:t.getOrientation(),coordinates:!1,viewOnly:!0,drawable:{enabled:!1,visible:!1}},i=m("div.cg-wrap.is2d",{hook:{insert:t=>t.elm._cg=window.Chessground(t.elm,r),update:t=>t.elm._cg.set(r),destroy:t=>t.elm._cg.destroy()}});return m("div.pv-board",m("div.pv-board-square",i))}lichess.storage.make("ceval.disable").listen((()=>{const t=document.getElementById("analyse-toggle-ceval");(null==t?void 0:t.checked)&&t.click()}));const vr=t=>m("glyph",{attrs:{title:t.name}},t.symbol),br=t=>m("eval",t.replace("-","−"));function yr(t,e){return(t=>Math.floor((t-1)/2)+1)(t)+(e?t%2==1?".":"...":"")}function wr(t,e){return m("index",yr(t,e))}function kr(t,e){var n;const o=ar({client:e.ceval,server:e.eval}),r=[m("san",$t(e.san))];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>r.push(vr(t)))),(null===(n=e.shapes)||void 0===n?void 0:n.length)&&r.push(m("shapes")),o&&t.showEval&&(I(o.cp)?r.push(br(uo(o.cp))):I(o.mate)&&r.push(br("#"+o.mate))),r}function Cr(t,e){if(e.san)return[wr(e.ply,t.withDots),...kr(t,e)]}function xr(t){const e=Cr({withDots:!0,showEval:!1},t.currentNode());return m("div.ply-wrap",m("label.ply",[m("input",{attrs:{type:"checkbox"},hook:S("change",(e=>{t.withPly(e.target.checked)}),t.redraw)}),...e?t.trans.vdom("startAtX",m("strong",e)):[t.trans.noarg("startAtInitialPosition")]]))}function Sr(t,e){return m("input",{key:t,attrs:{spellcheck:!1,value:t},hook:x((t=>{t.onblur=function(){e(t.value,t)},t.onkeydown=function(e){"Enter"===e.key&&t.blur()}}))})}function Mr(t){return m("span",t)}let Pr;function Er(t){return m("div",function(t,e,n,o){let r=[];if("standard"!==t.setup.variant.key&&r.push(["Variant",Mr(t.setup.variant.name)]),r=r.concat(t.tags.map((t=>[t[0],e?Sr(t[1],e(t[0])):Mr(t[1])]))),e){const i=t.tags.map((t=>t[0]));r.push([m("select",{hook:{insert:t=>{const e=t.elm;Pr=e.value,e.addEventListener("change",(t=>{Pr=e.value,$(e).parents("tr").find("input").each((function(){this.focus()}))}))},postpatch:(t,e)=>{Pr=e.elm.value}}},[m("option",o.noarg("newTag")),...n.map((t=>{if(!i.includes(t))return $e(t,"",t)}))]),Sr("",((t,n)=>{Pr&&(e(Pr)(t),n.value="")}))])}return m("table.study__tags.slist",m("tbody",r.map((function(t){return m("tr",{key:""+t[0]},[m("th",[t[0]]),m("td",[t[1]])])}))))}(t.tags.getChapter(),t.vm.mode.write&&t.tags.submit,t.tags.types,t.trans))}function Ar(t){const e=t.tags.getChapter(),n=e.tags.map((t=>t[1])).join(","),o=e.id+t.data.name+e.name+t.data.likes+n+t.vm.mode.write;return b("div."+e.id,Er,[t,o])}function Tr(t){const e=t.root.data.analysis;return t.root.showComputer()?e?m("div.study__server-eval.ready."+e.id,{hook:x((e=>{t.lastPly(!1),lichess.requestIdleCallback((()=>lichess.loadScript("javascripts/chart/acpl.js").then((()=>{lichess.advantageChart(t.root.data,t.root.trans,e),t.chartEl(e)}))),800)}))},[m("div.study__message",ye())]):t.requested()?m("div.study__server-eval.requested.padded",ye()):function(t){const e=t.root;return m("div.study__message",e.mainline.length<5?m("p",e.trans.noarg("theChapterIsTooShortToBeAnalysed")):e.study.members.canContribute()?[m("p",[e.trans.noarg("getAFullComputerAnalysis"),m("br"),e.trans.noarg("makeSureTheChapterIsComplete")]),m("a.button.text",{attrs:{"data-icon":"",disabled:e.mainline.length<5},hook:S("click",t.request,e.redraw)},e.trans.noarg("requestAComputerAnalysis"))]:[e.trans.noarg("onlyContributorsCanRequestAnalysis")])}(t):m("div.study__server-eval.disabled.padded","You disabled computer analysis.")}const Ir=["white","black"],$r=["a","b","c","d","e","f","g","h"],_r=["1","2","3","4","5","6","7","8"],Nr=[..._r].reverse(),Dr=Array.prototype.concat(...$r.map((t=>_r.map((e=>t+e))))),qr=t=>Dr[8*t[0]+t[1]],Or=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],Rr=Dr.map(Or);const Lr=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Fr=t=>"white"===t?"black":"white",Br=(t,e)=>{const n=t[0]-e[0],o=t[1]-e[1];return n*n+o*o},jr=(t,e)=>t.role===e.role&&t.color===e.color,zr=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],Gr=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},Vr=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},Hr=(t,e)=>{t.style.visibility=e?"visible":"hidden"},Wr=t=>{var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0},Ur=t=>2===t.buttons||2===t.button,Kr=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function Jr(t,e,n){const o=Or(t);return e||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function Yr(t,e,n){return{orig:t,piece:{color:n,role:e,scale:.8},brush:"green"}}function Xr(t,e,n,o){if("Current Position"===e)return[];const r=dn(e),i=ln(r.to);if(We(r))return[{orig:i,brush:n},Yr(i,r.role,t)];const s=[{orig:ln(r.from),dest:i,brush:n,modifiers:o}];return r.promotion&&s.push(Yr(i,r.promotion,t)),s}const Qr={"?!":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#56b4e9;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.81934" d="m 37.734375,21.947266 c -3.714341,0 -7.128696,0.463992 -10.242187,1.392578 -3.113493,0.928585 -6.009037,2.130656 -8.685547,3.605468 l 4.34375,8.765626 c 2.348774,-1.201699 4.643283,-2.157093 6.882812,-2.867188 2.239529,-0.710095 4.504676,-1.064453 6.798828,-1.064453 2.294152,0 4.069851,0.463993 5.326172,1.392578 1.310944,0.873963 1.966797,2.185668 1.966797,3.933594 0,1.747925 -0.546219,3.276946 -1.638672,4.58789 -1.037831,1.256322 -2.786121,2.757934 -5.24414,4.50586 -2.785757,2.021038 -4.751362,3.961188 -5.898438,5.818359 -1.147076,1.857171 -1.720703,4.149726 -1.720703,6.88086 v 2.951171 h 10.568359 v -2.376953 c 0,-1.147076 0.137043,-2.10247 0.410156,-2.867187 0.327737,-0.764718 0.928772,-1.557613 1.802735,-2.376953 0.873963,-0.81934 2.103443,-1.802143 3.6875,-2.949219 2.130284,-1.584057 3.905982,-3.058262 5.326172,-4.423828 1.420189,-1.42019 2.485218,-2.951164 3.195312,-4.589844 0.710095,-1.63868 1.064453,-3.576877 1.064453,-5.816406 0,-4.205946 -1.583838,-7.675117 -4.751953,-10.40625 -3.113492,-2.731134 -7.510649,-4.095703 -13.191406,-4.095703 z m 24.744141,0.818359 2.048828,39.083984 h 9.75 L 76.324219,22.765625 Z M 35.357422,68.730469 c -1.966416,0 -3.63248,0.51881 -4.998047,1.55664 -1.365567,0.983208 -2.046875,2.731498 -2.046875,5.244141 0,2.403397 0.681308,4.151687 2.046875,5.244141 1.365567,1.03783 3.031631,1.55664 4.998047,1.55664 1.911793,0 3.550449,-0.51881 4.916016,-1.55664 1.365566,-1.092454 2.048828,-2.840744 2.048828,-5.244141 0,-2.512643 -0.683262,-4.260933 -2.048828,-5.244141 -1.365567,-1.03783 -3.004223,-1.55664 -4.916016,-1.55664 z m 34.003906,0 c -1.966416,0 -3.63248,0.51881 -4.998047,1.55664 -1.365566,0.983208 -2.048828,2.731498 -2.048828,5.244141 0,2.403397 0.683262,4.151687 2.048828,5.244141 1.365567,1.03783 3.031631,1.55664 4.998047,1.55664 1.911793,0 3.550449,-0.51881 4.916016,-1.55664 1.365566,-1.092454 2.046875,-2.840744 2.046875,-5.244141 0,-2.512643 -0.681309,-4.260933 -2.046875,-5.244141 -1.365567,-1.03783 -3.004223,-1.55664 -4.916016,-1.55664 z" />\n</g>\n',"?":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#e69f00;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.932208" d="m 40.435856,60.851495 q 0,-4.661041 1.957637,-7.830548 1.957637,-3.169507 6.711897,-6.618677 4.194937,-2.983065 5.966132,-5.127144 1.864416,-2.237299 1.864416,-5.220365 0,-2.983065 -2.237299,-4.474598 -2.144079,-1.584754 -6.059353,-1.584754 -3.915273,0 -7.737326,1.21187 -3.822053,1.211871 -7.830548,3.262729 L 28.13071,24.495382 q 4.567819,-2.516962 9.881405,-4.101716 5.313586,-1.584753 11.6526,-1.584753 9.694964,0 15.008549,4.66104 5.406807,4.66104 5.406807,11.839042 0,3.822053 -1.21187,6.618677 -1.211871,2.796624 -3.635612,5.220365 -2.423741,2.33052 -6.059352,5.033923 -2.703403,1.957637 -4.194936,3.355949 -1.491533,1.398312 -2.050858,2.703403 -0.466104,1.305091 -0.466104,3.262728 v 2.703403 H 40.435856 Z m -1.491533,18.923822 q 0,-4.288156 2.33052,-5.966131 2.33052,-1.771195 5.686469,-1.771195 3.262728,0 5.593248,1.771195 2.33052,1.677975 2.33052,5.966131 0,4.101716 -2.33052,5.966132 -2.33052,1.771195 -5.593248,1.771195 -3.355949,0 -5.686469,-1.771195 -2.33052,-1.864416 -2.33052,-5.966132 z" />\n</g>\n',"??":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.810558" d="m 31.799294,22.220598 c -3.67453,-10e-7 -7.050841,0.460303 -10.130961,1.378935 -3.08012,0.918633 -5.945403,2.106934 -8.593226,3.565938 l 4.297618,8.67363 c 2.3236,-1.188818 4.592722,-2.135794 6.808247,-2.838277 2.215525,-0.702483 4.45828,-1.053299 6.727842,-1.053299 2.269562,0 4.025646,0.460305 5.268502,1.378937 1.296893,0.864596 1.945788,2.160375 1.945788,3.889565 0,1.72919 -0.541416,3.241939 -1.62216,4.538831 -1.026707,1.242856 -2.756423,2.729237 -5.188097,4.458428 -2.755898,1.999376 -4.700572,3.917682 -5.835354,5.754947 -1.13478,1.837266 -1.702564,4.106388 -1.702564,6.808248 v 2.918681 h 10.4566 v -2.34982 c 0,-1.134781 0.135856,-2.081756 0.406042,-2.838277 0.324222,-0.756521 0.918373,-1.539262 1.782969,-2.349819 0.864595,-0.810559 2.079262,-1.783901 3.646342,-2.918683 2.10745,-1.567078 3.863533,-3.025082 5.268501,-4.376012 1.404967,-1.404967 2.459422,-2.919725 3.161905,-4.540841 0.702483,-1.621116 1.053298,-3.539423 1.053298,-5.754948 0,-4.160865 -1.567492,-7.591921 -4.70165,-10.29378 -3.080121,-2.70186 -7.429774,-4.052384 -13.049642,-4.052384 z m 38.66449,0 c -3.67453,-10e-7 -7.05285,0.460303 -10.132971,1.378935 -3.08012,0.918633 -5.943393,2.106934 -8.591215,3.565938 l 4.295608,8.67363 c 2.323599,-1.188818 4.592721,-2.135794 6.808246,-2.838277 2.215526,-0.702483 4.458281,-1.053299 6.727842,-1.053299 2.269563,0 4.025647,0.460305 5.268502,1.378937 1.296893,0.864596 1.945788,2.160375 1.945788,3.889565 0,1.72919 -0.539406,3.241939 -1.62015,4.538831 -1.026707,1.242856 -2.756423,2.729237 -5.188097,4.458428 -2.755897,1.999376 -4.700572,3.917682 -5.835353,5.754947 -1.134782,1.837266 -1.702564,4.106388 -1.702564,6.808248 v 2.918681 h 10.456599 v -2.34982 c 0,-1.134781 0.133846,-2.081756 0.404032,-2.838277 0.324223,-0.756521 0.918374,-1.539262 1.782969,-2.349819 0.864596,-0.810559 2.081273,-1.783901 3.648352,-2.918683 2.107451,-1.567078 3.863534,-3.025082 5.268502,-4.376012 1.404966,-1.404967 2.45942,-2.919725 3.161904,-4.540841 0.702483,-1.621116 1.053299,-3.539423 1.053299,-5.754948 0,-4.160865 -1.567493,-7.591921 -4.701651,-10.29378 -3.08012,-2.70186 -7.429774,-4.052384 -13.049642,-4.052384 z M 29.449473,68.50341 c -1.945339,0 -3.593943,0.513038 -4.944873,1.539744 -1.350931,0.97267 -2.026192,2.702386 -2.026192,5.188098 0,2.377636 0.675261,4.107352 2.026192,5.188097 1.35093,1.026707 2.999534,1.539745 4.944873,1.539745 1.891302,0 3.51153,-0.513038 4.86246,-1.539745 1.35093,-1.080745 2.026192,-2.810461 2.026192,-5.188097 0,-2.485712 -0.675262,-4.215428 -2.026192,-5.188098 -1.35093,-1.026706 -2.971158,-1.539744 -4.86246,-1.539744 z m 38.662481,0 c -1.945339,0 -3.591933,0.513038 -4.942864,1.539744 -1.35093,0.97267 -2.026192,2.702386 -2.026192,5.188098 0,2.377636 0.675262,4.107352 2.026192,5.188097 1.350931,1.026707 2.997525,1.539745 4.942864,1.539745 1.891302,0 3.513539,-0.513038 4.864469,-1.539745 1.350931,-1.080745 2.026192,-2.810461 2.026192,-5.188097 0,-2.485712 -0.675261,-4.215428 -2.026192,-5.188098 -1.35093,-1.026706 -2.973167,-1.539744 -4.864469,-1.539744 z" />\n</g>\n'};class Zr{constructor(t,e,n,o){this.root=t,this.chapterId=e,this.trans=n,this.redraw=o,this.makeState=()=>{const t=this.root.node,e=(t.comments||[])[0],n={init:""===this.root.path,comment:e?e.text:void 0,showHint:!1},o=zt(this.root.path),r=this.root.tree.nodeAtPath(o);this.root.onMainline&&!t.children[0]||!this.root.onMainline&&!this.root.tree.pathIsMainline(o)?n.feedback="end":this.isMyMove()?(n.feedback="play",n.hint=(t.gamebook||{}).hint):this.root.onMainline?n.feedback="good":(n.feedback="bad",n.comment||(n.comment=r.children[0].gamebook.deviation)),this.state=n,n.comment||("good"===n.feedback?setTimeout(this.next,this.root.path?1e3:300):"bad"===n.feedback&&setTimeout(this.retry,800))},this.isMyMove=()=>this.root.turnColor()===this.root.data.orientation,this.movableColor=()=>["play","good"].includes(this.state.feedback)?this.root.data.orientation:void 0,this.retry=()=>{let t=this.root.path;for(;t&&!this.root.tree.pathIsMainline(t);)t=zt(t);this.root.userJump(t),this.redraw()},this.next=()=>{if(!this.isMyMove()){const t=this.root.node.children[0];t&&this.root.userJump(this.root.path+t.id)}this.redraw()},this.onSpace=()=>{switch(this.state.feedback){case"bad":this.retry();break;case"end":this.root.study.goToNextChapter();break;default:this.next()}},this.onPremoveSet=()=>{this.next()},this.hint=()=>{this.state.hint&&(this.state.showHint=!this.state.showHint)},this.solution=()=>{this.root.chessground.setShapes(Xr(this.root.turnColor(),this.root.node.children[0].uci,"green"))},this.canJumpTo=t=>Gt(this.root.path,t),this.onJump=()=>{this.makeState(),setTimeout((()=>this.root.withCg((t=>t.playPremove()))),100)},this.onShapeChange=t=>{const e=this.root.node;e.gamebook&&e.gamebook.shapes&&!t.length&&(e.shapes=e.gamebook.shapes.slice(0),this.root.jump(this.root.path))},oe(t.tree.root,(t=>{t.gamebook=t.gamebook||{},t.shapes&&(t.gamebook.shapes=t.shapes.slice(0))})),this.makeState()}}class ti{constructor(t,e,n){this.text=t,this.doSave=e,this.redraw=n,this.edit=!1}save(t){this.text=t,this.doSave(t),this.redraw()}set(t){this.text=t||void 0}}function ei(t){return(t?"Chapter":"Study")+" pinned comment"}function ni(t,e){const n=e?t.chapterDesc:t.studyDesc,o=t.members.canContribute()&&!t.gamebookPlay();if(n.edit)return function(t,e,n){return m("div.study-desc-form",[m("div.title",[ei(n),m("button.button.button-empty.button-red",{attrs:{"data-icon":"",title:"Close"},hook:S("click",(()=>{t.edit=!1}),t.redraw)})]),m("form.form3",[m("div.form-group",[m("textarea#form-control.desc-text."+e,{hook:x((e=>{e.value="-"===t.text?"":t.text||"",e.oninput=()=>{t.save(e.value.trim())},e.focus()}))})])])])}(n,e?t.data.chapter.id:t.data.id,e);const r="-"===n.text;return!n.text||r&&!o?void 0:m(`div.study-desc${e?".chapter-desc":""}${r?".empty":""}`,[o&&!r?m("div.contrib",[m("span",ei(e)),r?null:m("a",{attrs:{"data-icon":"",title:"Edit"},hook:S("click",(t=>{n.edit=!0}),n.redraw)}),m("a",{attrs:{"data-icon":"",title:"Delete"},hook:S("click",(()=>{confirm("Delete permanent description?")&&n.save("")}))})]):null,r?m("a.text.button",{hook:S("click",(t=>{n.edit=!0}),n.redraw)},ei(e)):m("div.text",{hook:lt(n.text)})])}class oi{constructor(t,e,n,o,r,i){this.id=t,this.data=e,this.send=n,this.redraw=o,this.members=r,this.log=[],this.cooldown=!1,this.setSync=t=>{this.send("relaySync",t),this.redraw()},this.loading=()=>{var t;return!this.cooldown&&(null===(t=this.data.sync)||void 0===t?void 0:t.ongoing)},this.applyChapterRelay=(t,e)=>{this.clockInterval&&clearInterval(this.clockInterval),e&&(t.relay=this.convertDate(e),_n(t)||(this.clockInterval=setInterval(this.redraw,1e3)))},this.roundById=t=>this.data.rounds.find((e=>e.id==t)),this.currentRound=()=>this.roundById(this.id),this.tourPath=()=>`/broadcast/${this.data.tour.slug}/${this.data.tour.id}`,this.roundPath=t=>{const e=t||this.currentRound();return e&&`/broadcast/${this.data.tour.slug}/${e.slug}/${e.id}`},this.convertDate=t=>(void 0===t.secondsSinceLastMove||t.lastMoveAt||(t.lastMoveAt=Date.now()-1e3*t.secondsSinceLastMove),t),this.socketHandlers={relayData:t=>{var e;t.sync&&(t.sync.log=(null===(e=this.data.sync)||void 0===e?void 0:e.log)||[]),this.data=t,this.redraw()},relaySync:t=>{var e;this.data.sync={...t,log:(null===(e=this.data.sync)||void 0===e?void 0:e.log)||t.log},this.redraw()},relayLog:t=>{this.data.sync&&(this.data.sync.log.push(t),this.data.sync.log=this.data.sync.log.slice(-20),this.cooldown=!0,setTimeout((()=>{this.cooldown=!1,this.redraw()}),4500),this.redraw(),t.error&&console.warn(`relay synchronisation error: ${t.error}`))}},this.socketHandler=(t,e)=>{const n=this.socketHandlers[t];return!(!n||e.id!==this.id)&&(n(e),!0)},this.applyChapterRelay(i,i.relay),this.tourShow={active:(location.pathname.match(/\//g)||[]).length<5,disable:()=>{this.tourShow.active=!1}}}}class ri{constructor(t,e,n){this.studyId=t,this.redraw=e,this.trans=n,this.loading=!1,this.page=1,this.playing=!1,this.addNode=(t,e)=>{const n=this.pager&&this.pager.currentPageResults.find((e=>e.id==t.chapterId));n&&n.playing&&(n.fen=e.fen,n.lastMove=e.uci,this.redraw())},this.reload=t=>{this.pager&&!t&&(this.loading=!0,this.redraw()),((t,e,n)=>B(`/study/${t}/multi-board?page=${e}&playing=${n}`))(this.studyId,this.page,this.playing).then((t=>{this.pager=t,t.nbPages<this.page&&(t.nbPages?this.setPage(t.nbPages):this.page=1),this.loading=!1,this.redraw()}))},this.reloadEventually=U(this.reload,1e3),this.setPage=t=>{this.page!=t&&(this.page=t,this.reload())},this.nextPage=()=>this.setPage(this.page+1),this.prevPage=()=>this.setPage(this.page-1),this.lastPage=()=>{this.pager&&this.setPage(this.pager.nbPages)},this.setPlaying=t=>{this.playing=t,this.reload()}}}function ii(t,e){const n=e.chapters.list().map((t=>t.id)).join("");return m("div.study__multiboard",{class:{loading:t.loading,nopager:!t.pager},hook:{insert(e){t.reload(!0),e.data.chapterIds=n},postpatch(e,o){e.data.chapterIds!==n&&t.reloadEventually(),o.data.chapterIds=n}}},t.pager?function(t,e){const n=e.multiBoard;return[m("div.top",[ai(t,n),si(n)]),m("div.now-playing",t.currentPageResults.map(li(e)))]}(t.pager,e):[ye()])}function si(t){return m("label.playing",[m("input",{attrs:{type:"checkbox"},hook:S("change",(e=>{t.setPlaying(e.target.checked)}))}),t.trans.noarg("playing")])}function ai(t,e){const n=e.page,o=Math.min(t.nbResults,(n-1)*t.maxPerPage+1),r=Math.min(t.nbResults,n*t.maxPerPage);return m("div.pager",[ci(e.trans.noarg("first"),"",(()=>e.setPage(1)),n>1,e),ci(e.trans.noarg("previous"),"",e.prevPage,n>1,e),m("span.page",`${o}-${r} / ${t.nbResults}`),ci(e.trans.noarg("next"),"",e.nextPage,n<t.nbPages,e),ci(e.trans.noarg("last"),"",e.lastPage,n<t.nbPages,e)])}function ci(t,e,n,o,r){return m("button.fbt",{attrs:{"data-icon":e,disabled:!o,title:t},hook:S("mousedown",n,r.redraw)})}function li(t){return e=>{var n;const o=e.players?[di(e.players[Fr(e.orientation)]),ui(e),di(e.players[e.orientation])]:[m("div.name",e.name),ui(e)];return m("a."+e.id,{attrs:{title:e.name},class:{active:!t.multiBoard.loading&&t.vm.chapterId==e.id&&!(null===(n=t.relay)||void 0===n?void 0:n.tourShow.active)},hook:S("mousedown",(n=>t.setChapter(e.id)))},o)}}function di(t){return m("span.player",[t.title?`${t.title} ${t.name}`:t.name,t.rating&&m("span",""+t.rating)])}function ui(t){return m("span.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${t.fen},${t.orientation},${t.lastMove}`},hook:{insert(e){lichess.miniBoard.init(e.elm),e.data.fen=t.fen},postpatch(e,n){if(e.data.fen!==t.fen){const e=t.lastMove;(o=n.elm,r="chessground",o[(t=>`lichess-${t}`)(r)]).set({fen:t.fen,lastMove:[e[0]+e[1],e[2]+e[3]]})}var o,r;n.data.fen=t.fen}}})}function hi(t,e,n,o,r){const i=e.socket.send,s=e.redraw,a=(()=>{const n=t.chapter.id!==t.position.chapterId,i=t.features.sticky&&!e.initialPath&&!n&&!o;return{loading:!1,tab:q(r||t.chapters.length>1?"chapters":"members"),toolTab:q("tags"),chapterId:i?t.position.chapterId:t.chapter.id,mode:{sticky:i,write:!0},behind:0,updatedAt:Date.now()-1e3*t.secondsSinceUpdate,gamebookOverride:void 0}})(),c=function(t){let e,n;return{set(o){clearTimeout(n),e=o,n=setTimeout((function(){e=void 0,t()}),o.duration)},get:()=>e}}(s),l=()=>function(t){var e;(null===(e=t.study)||void 0===e?void 0:e.data.chapter.gamebook)||lichess.loadScript("javascripts/study/tour.js").then((()=>{window.lichess.studyTour({userId:t.opts.userId,isContrib:t.study.members.canContribute(),isOwner:t.study.members.isOwner(),setTab:e=>{t.study.vm.tab(e),t.redraw()}})}))}(e),d=De({initDict:t.members,myId:o?void 0:e.opts.userId,ownerId:t.ownerId,send:i,tab:a.tab,startTour:l,notif:c,onBecomingContributor(){a.mode.write=!0},admin:t.admin,redraw:s,trans:e.trans}),u=$n(t.chapters,i,(()=>a.tab("chapters")),(e=>((t,e)=>B(`/study/${t}/${e}/meta`))(t.id,e)),e),h=()=>u.get(a.chapterId),p=()=>e.opts.userId===t.chapter.ownerId,m=new ri(t.id,s,e.trans),f=r?new oi(t.id,r,i,s,d,t.chapter):void 0,g=function(t,e,n,o,r){const i=Date.now();function s(){const t=e();return"scratch"===t.from&&!!t.isNew&&Date.now()-i<9e3}const a=q(!1);return{open:a,openIfNew(){s()&&a(!0)},save(e,n){t(e,n),a(!1)},getData:e,isNew:s,trans:n,redraw:o,relay:r}}(((n,o)=>{i("editStudy",n),!o||"standard"!==t.chapter.setup.variant.key||1!==e.mainline.length||t.chapter.setup.fromFen||f||u.newForm.openInitial()}),(()=>t),e.trans,s,f);function v(){return a.mode.write&&!E()}function b(...t){return v()?(i(...t),!0):a.mode.sticky=!1}const y=function(t){const e=q(null),n=q(!1),o=Ne(500,(n=>{const o=e();o&&t.study.makeChange("setComment",{ch:o.chapterId,path:o.path,text:n})}));return{root:t,current:e,opening:n,submit:function(t){e()&&o(t)},start:function(o,r,i){n(!0),e({chapterId:o,path:r,node:i}),t.userJump(r)},onSetPath(t,n,o){const r=e();!r||n===r.path&&t===r.chapterId&&r.node===o||(r.chapterId=t,r.path=n,r.node=o)},redraw:t.redraw,delete(e,n,o){t.study.makeChange("deleteComment",{ch:e,path:n,id:o})}}}(e),w=Hn(e),k=function(t,e,n){const o=Ne(500,(function(n,o){t.study.makeChange("setTag",{chapterId:e().id,name:n,value:o.substr(0,140)})}));return{submit:t=>e=>o(t,e),getChapter:e,types:n}}(e,(()=>t.chapter),n),C=new ti(t.description,U((e=>{t.description=e,i("descStudy",e)}),500),s),x=new ti(t.chapter.description,U((e=>{t.chapter.description=e,i("descChapter",{id:a.chapterId,desc:e})}),500),s),S=function(t,e){const n=q(!1),o=q(!1),r=q(null);function i(t){t.getSelectedPoints().forEach((t=>t.select(!1)))}return lichess.pubsub.on("analysis.change",((e,n,s)=>{if(!lichess.advantageChart||o()===s)return;const a=o(void 0===s?o():s),c=r(),l=c&&c.highcharts;if(l)if(!1===a)i(l);else{const e=l.series[0].data[a-1-t.tree.root.ply];I(e)?e.select():i(l)}else o(!1)})),{root:t,reset(){n(!1),o(!1)},chapterId:e,onMergeAnalysisData(){lichess.advantageChart&&lichess.advantageChart.update(t.data)},request(){t.socket.send("requestAnalysis",e()),n(!0)},requested:n,lastPly:o,chartEl:r}}(e,(()=>a.chapterId)),M=function(t,e,n,o){const r=q(!1);return{open:r,getTopics:e,save(e){t(e),r(!1)},trans:n,redraw:o}}((t=>i("setTopics",t)),(()=>t.topics||[]),e.trans,s);function P(t){return{...t,ch:a.chapterId}}function E(){return t.chapter.gamebook&&"analyse"!==a.gamebookOverride&&("play"===a.gamebookOverride||!d.canContribute())}function A(){if(e.embed)return;const n=d.canContribute();a.mode.write=a.mode.write&&n,lichess.pubsub.emit("chat.writeable",t.features.chat),lichess.pubsub.emit("chat.permissions",{local:n}),lichess.pubsub.emit("palantir.toggle",t.features.chat&&!!d.myMember());const o=!(E()||!t.chapter.features.computer&&!t.chapter.practice);o||e.getCeval().enabled(!1),e.getCeval().allowed(o),t.chapter.features.explorer||e.explorer.disable(),e.explorer.allowed(t.chapter.features.explorer)}function T(n){const o=n.study,r=e.path,i=t.chapter.id===o.chapter.id;a.mode.sticky=a.mode.sticky&&o.features.sticky||!t.features.sticky&&o.features.sticky,a.mode.sticky&&(a.behind=0),t.position=o.position,t.name=o.name,t.visibility=o.visibility,t.features=o.features,t.settings=o.settings,t.chapter=o.chapter,t.likes=o.likes,t.liked=o.liked,t.description=o.description,x.set(t.chapter.description),C.set(t.description),document.title=t.name,d.dict(o.members),u.list(o.chapters),e.flipped=!1;const c=!a.mode.write&&i;let l;e.reloadData(n.analysis,c),a.gamebookOverride=void 0,A(),a.loading=!1,L(),f&&f.applyChapterRelay(t.chapter,o.chapter.relay),a.mode.sticky?(a.chapterId=t.position.chapterId,l=a.justSetChapterId===a.chapterId&&u.localPaths[a.chapterId]||t.position.path):l=i?r:t.chapter.relay?t.chapter.relay.path:u.localPaths[a.chapterId]||"",e.userJump(e.tree.longestValidPath(l)),a.justSetChapterId=void 0,!t.chapter.practice&&e.practice&&e.togglePractice(),t.chapter.practice&&e.restartPractice(),O&&O.onLoad(),S.reset(),y.onSetPath(t.chapter.id,e.path,e.node),s(),e.startCeval()}a.mode.sticky&&!E()?e.userJump(t.position.path):t.chapter.relay&&!e.initialPath&&e.userJump(t.chapter.relay.path),A();const $=Ne(700,(()=>(a.loading=!0,((t,e,n)=>{let o="/"+t+"/"+e;return n&&(o+="/"+n),B(o)})(O?"practice/load":"study",t.id,a.mode.sticky?void 0:a.chapterId).then(T,lichess.reload)))),_=Ne(300,(e=>{a.mode.sticky&&e!==t.position.path&&b("setPath",P({path:e}))}));d.canContribute()&&g.openIfNew();const N=()=>e.node,D=function(t,e,n,o,r,i){const s=q(!1);return{studyId:t.id,chapter:e,isPrivate:()=>"private"===t.visibility,currentNode:n,withPly:s,relay:o,cloneable:t.features.cloneable,redraw:r,trans:i}}(t,h,N,f,s,e.trans),O=o&&Fn(e,t,o);let R;function L(){if(!E())return R=void 0;R&&R.chapterId===a.chapterId||(R=new Zr(e,a.chapterId,e.trans,s),a.mode.sticky=!1)}function F(t){return t.p.chapterId!==a.chapterId&&(a.mode.sticky&&t.s&&$(),!0)}function j(t){t&&d.setActive(t.u),a.updatedAt=Date.now()}function z(t){return{...t,ch:a.chapterId,path:e.path}}L();const G=U((()=>i("like",{liked:t.liked})),1e3);function V(t,e){const n=t===a.chapterId&&!e;(null==f?void 0:f.tourShow.active)&&(f.tourShow.disable(),n&&s()),n||(a.mode.sticky&&b("setChapter",t)||(a.mode.sticky=!1,a.behind||(a.behind=1),a.chapterId=t,$()),a.loading=!0,a.nextChapterId=t,a.justSetChapterId=t,s())}const[H,W]=[-1,1].map((t=>()=>{const e=u.list(),n=e.findIndex((t=>t.id===a.chapterId));return n<0?void 0:e[n+t]})),K={path(n){const o=n.p,r=n.w;return j(r),a.mode.sticky?o.chapterId===t.position.chapterId&&e.tree.pathExists(o.path)?(t.position.path=o.path,void(r&&r.s===lichess.sri||(e.userJump(o.path),s()))):$():(a.behind++,s())},addNode(n){const o=n.p,r=n.n,i=n.w,c=n.s;if(j(i),("multiBoard"==a.toolTab()||f&&f.tourShow.active)&&m.addNode(n.p,n.n),c&&!a.mode.sticky&&a.behind++,F(n))return void(c&&!a.mode.sticky&&s());if(c&&i&&i.s===lichess.sri)return void(t.position.path=o.path+r.id);f&&f.applyChapterRelay(t.chapter,n.relay);const l=e.tree.addNode(r,o.path);if(!l)return $();e.tree.addDests(n.d,l),c&&(t.position.path=l),(c&&a.mode.sticky||o.path===e.path&&o.path===Vt(e.mainline))&&e.jump(l),s()},deleteNode(t){const n=t.p,o=t.w;if(j(o),!(F(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return $();e.tree.deleteNodeAt(n.path),a.mode.sticky&&e.jump(e.path),s()}},promote(t){const n=t.p,o=t.w;if(j(o),!(F(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return $();e.tree.promoteAt(n.path,t.toMainline),a.mode.sticky&&e.jump(e.path),s()}},reload:$,changeChapter(e){j(e.w),a.mode.sticky||a.behind++,t.position=e.p,a.mode.sticky?$():s()},updateChapter(t){j(t.w),$()},descChapter(e){j(e.w),e.w&&e.w.s===lichess.sri||(t.chapter.id===e.chapterId&&(t.chapter.description=e.desc,x.set(e.desc)),s())},descStudy(e){j(e.w),e.w&&e.w.s===lichess.sri||(t.description=e.desc,C.set(e.desc),s())},setTopics(e){j(e.w),t.topics=e.topics,s()},addChapter(e){j(e.w),e.s&&!a.mode.sticky&&a.behind++,e.s?t.position=e.p:e.w&&e.w.s===lichess.sri&&(a.mode.write=!0,a.chapterId=e.p.chapterId),$()},members(t){d.update(t),A(),s()},chapters(t){u.list(t),h()||(a.chapterId=t[0].id,a.mode.sticky||$()),s()},shapes(t){const n=t.p,o=t.w;if(j(o),t.p.chapterId===a.chapterId){if(o&&o.s===lichess.sri)return s();e.tree.setShapes(t.s,e.path),e.path===n.path&&e.withCg((e=>e.setShapes(t.s))),s()}},validationError(t){alert(t.error)},setComment(t){const n=t.p;j(t.w),F(t)||(e.tree.setCommentAt(t.c,n.path),s())},setTags(e){j(e.w),e.chapterId===a.chapterId&&(t.chapter.tags=e.tags,s())},deleteComment(t){const n=t.p;j(t.w),F(t)||(e.tree.deleteCommentAt(t.id,n.path),s())},glyphs(t){const n=t.p;j(t.w),F(t)||(e.tree.setGlyphsAt(t.g,n.path),e.path===n.path&&e.setAutoShapes(),s())},clock(t){const n=t.p;j(t.w),F(t)||(e.tree.setClockAt(t.c,n.path),s())},forceVariation(t){const n=t.p;j(t.w),F(t)||(e.tree.forceVariationAt(n.path,t.force),s())},conceal(e){F(e)||(t.chapter.conceal=e.ply,s())},liking(e){t.likes=e.l.likes,e.w&&e.w.s===lichess.sri&&(t.liked=e.l.me),s()},error(t){alert(t)}};return{data:t,form:g,members:d,chapters:u,notif:c,commentForm:y,glyphForm:w,serverEval:S,share:D,tags:k,studyDesc:C,chapterDesc:x,topics:M,vm:a,relay:f,multiBoard:m,isUpdatedRecently:()=>Date.now()-a.updatedAt<3e5,toggleLike(){t.liked=!t.liked,s(),G()},position:()=>t.position,currentChapter:h,isChapterOwner:p,canJumpTo:n=>R?R.canJumpTo(n):void 0===t.chapter.conceal||p()||Gt(e.path,n)||e.tree.lastMainlineNode(n).ply<=t.chapter.conceal,onJump(){R?R.onJump():u.localPaths[a.chapterId]=e.path,O&&O.onJump()},withPosition:z,setPath(t,e){_(t),y.onSetPath(a.chapterId,t,e)},deleteNode(t){b("deleteNode",P({path:t,jumpTo:e.path}))},promote(t,e){b("promote",P({toMainline:e,path:t}))},forceVariation(t,e){b("forceVariation",P({force:e,path:t}))},setChapter:V,toggleSticky(){a.mode.sticky=!a.mode.sticky&&t.features.sticky,$()},toggleWrite(){a.mode.write=!a.mode.write&&d.canContribute(),$()},isWriting:v,makeChange:b,startTour:l,userJump:e.userJump,currentNode:N,practice:O,gamebookPlay:()=>R,prevChapter:H,nextChapter:W,goToPrevChapter(){const t=H();t&&V(t.id)},goToNextChapter(){const t=W();t&&V(t.id)},setGamebookOverride(t){a.gamebookOverride=t,L(),A(),e.userJump(e.path),t||$()},mutateCgConfig:function(t){t.drawable.onChange=t=>{a.mode.write&&(e.tree.setShapes(t,e.path),b("shapes",P({path:e.path,shapes:t}))),R&&R.onShapeChange(t)}},explorerGame(t,e){b("explorerGame",z({gameId:t,insert:e}))},onPremoveSet(){R&&R.onPremoveSet()},looksNew(){const t=u.list();return 1==t.length&&"Chapter 1"==t[0].name&&!h().ongoing},redraw:s,trans:e.trans,socketHandler:(t,e)=>{const n=K[t];return n?(n(e),!0):!!f&&f.socketHandler(t,e)}}}class pi{constructor(t){this.ctrl=t}move(){return ie(this.ctrl)?(se(this.ctrl),this.ctrl.redraw(),!0):(this.stop(),this.ctrl.redraw(),!1)}evalToCp(t){return t.eval?t.eval.mate?t.eval.mate>0?990:-990:t.eval.cp:t.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const t=this.ctrl.data.game.moveCentis;if(!t)return 1500;return 10*t[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const t=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const e=this.evalToCp(this.ctrl.node),n=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(e-n)*t))}return this.delay}return 1500}schedule(){this.timeout=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(t){this.delay=t,this.stop(),this.schedule()}stop(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}toggle(t){this.active(t)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(t))}active(t){return!(t&&t!==this.delay||!this.timeout)}}function mi(t,e,n){const o="abset-"+t.id;return m("div.setting."+o,t.title?{attrs:{title:e.noarg(t.title)}}:{},[m("label",{attrs:{for:o}},e.noarg(t.name)),m("div.switch",[m("input#"+o+".cmn-toggle",{attrs:{type:"checkbox",checked:t.checked,disabled:!!t.disabled},hook:S("change",(e=>t.change(e.target.checked)),n)}),m("label",{attrs:{for:o}})])])}function fi(t,e,n){return(n?"/embed/":"/")+(t.game?t.game.id:t)+(e?"/"+e:"")}function gi(t,e){return fi(t)+"/continue/"+e}const vi=t=>`${Math.floor((t.ply+1)/2)}${t.ply%2==1?". ":"... "}`;function bi(t,e){if(0===t.children.length)return"";let n="";const o=t.children[0];(e||o.ply%2==1)&&(n+=vi(o)),n+=$t(o.san);for(let i=1;i<t.children.length;i++){const e=t.children[i];n+=` (${vi(e)}${$t(e.san)}`;const o=bi(e,!1);o&&(n+=" "+o),n+=")"}const r=bi(o,t.children.length>1);return r&&(n+=" "+r),n}function yi(t){const e=t.data.game;let n=bi(t.tree.root,!0);const o=[];return"standard"!==e.variant.key&&o.push(["Variant",e.variant.name]),e.initialFen&&"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"!==e.initialFen&&o.push(["FEN",e.initialFen]),o.length&&(n=o.map((function(t){return"["+t[0]+' "'+t[1]+'"]'})).join("\n")+"\n\n"+n),n}function wi(t){if(!t[0])return[];if(t[0].san||(t=t.slice(1)),!t[0])return[];const e=[];return t[0].ply%2==0&&e.push(m("index",Math.floor((t[0].ply+1)/2)+"...")),t.forEach((t=>{0!==t.ply&&(t.ply%2==1&&e.push(m("index",(t.ply+1)/2+".")),e.push(m("san",$t(t.san))))})),e}const ki=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],Ci={name:"realtimeReplay",delay:"realtime"},xi={name:"byCPL",delay:"cpl"};function Si(t,e){const n=t.data.game;if("import"===n.source&&n.importedBy&&n.importedBy===e)return m("form.delete",{attrs:{method:"post",action:"/"+n.id+"/delete"},hook:M("submit",(e=>confirm(t.trans.noarg("deleteThisImportedGame"))))},[m("button.button.text.thin",{attrs:{type:"submit","data-icon":""}},t.trans.noarg("delete"))])}function Mi(t){const e=t.data;return m("div.autoplay",[...ki,..."correspondence"===e.game.speed||N(e.game.moveCentis)?[]:[Ci],...e.analysis?[xi]:[]].map((e=>m("a.button.button-empty",{hook:S("click",(()=>t.togglePlay(e.delay)),t.redraw)},t.trans.noarg(e.name)))))}function Pi(t,e){return{insert:n=>{const o=n.elm;o.value=""+t(),o.addEventListener("input",(t=>e(parseInt(o.value)))),o.addEventListener("mouseout",(t=>o.blur()))}}}function Ei(t,e){return m("input",{attrs:{type:"hidden",name:t,value:e}})}function Ai(t){return t.study&&t.embed&&!t.ongoing?m("a.button.button-empty",{attrs:{href:"/study/"+t.study.data.id+"#"+t.study.currentChapter().id,target:"_blank",rel:"noopener","data-icon":""}},t.trans.noarg("openStudy")):t.study||t.ongoing||t.embed?void 0:m("form",{attrs:{method:"post",action:"/study/as"},hook:S("submit",(e=>{const n=e.target.querySelector("input[name=pgn]");n&&(n.value=yi(t))}))},[t.synthetic?Ei("pgn",""):Ei("gameId",t.data.game.id),Ei("orientation",t.chessground.state.orientation),Ei("variant",t.data.game.variant.key),Ei("fen",t.tree.root.fen),m("button.button.button-empty",{attrs:{type:"submit","data-icon":""}},t.trans.noarg("toStudy"))])}class Ti{constructor(){this.open=!1,this.toggle=()=>{this.open=!this.open}}}function Ii(t){const e=t.data,n=t.trans.noarg,o=!t.ongoing&&!t.embed&&"standard"===e.game.variant.key,r=t.getCeval(),i=t.mandatoryCeval(),s=[m("div.action-menu__tools",[m("a.button.button-empty",{hook:S("click",t.flip),attrs:E("")},n("flipBoard")),t.ongoing?null:m("a.button.button-empty",{attrs:{href:e.userAnalysis?"/editor?"+new URLSearchParams({fen:t.node.fen,variant:e.game.variant.key}):"/"+e.game.id+"/edit?fen="+t.node.fen,"data-icon":"",...t.embed?{target:"_blank",rel:"noopener nofollow"}:{rel:"nofollow"}}},n("boardEditor")),o?m("a.button.button-empty",{hook:S("click",(t=>pe({content:$(".continue-with.g_"+e.game.id)}))),attrs:E("")},n("continueFromHere")):null,Ai(t)])],a="Browser does not support this option",c=r&&r.possible&&r.allowed()?[m("h2",n("computerAnalysis"))].concat([$i({name:"enable",title:(i?"Required by practice mode":"Stockfish")+" (Hotkey: z)",id:"all",checked:t.showComputer(),disabled:i,change:t.toggleComputer},t)]).concat(t.showComputer()?[$i({name:"bestMoveArrow",title:"Hotkey: a",id:"shapes",checked:t.showAutoShapes(),change:t.toggleAutoShapes},t),$i({name:"evaluationGauge",id:"gauge",checked:t.showGauge(),change:t.toggleGauge},t),$i({name:"Annotations on board",title:"Display analysis symbols on the board",id:"move-annotation",checked:t.showMoveAnnotation(),change:t.toggleMoveAnnotation},t),$i({name:"infiniteAnalysis",title:"removesTheDepthLimit",id:"infinite",checked:r.infinite(),change:t.cevalSetInfinite},t),$i({name:"Use NNUE",title:r.supportsNnue?"Downloads 6 MB neural network evaluation file (page reload required after change)":a,id:"enable-nnue",checked:r.supportsNnue&&r.enableNnue(),change:r.enableNnue,disabled:!r.supportsNnue},t),(l="analyse-multipv",m("div.setting",[m("label",{attrs:{for:l}},n("multipleLines")),m("input#"+l,{attrs:{type:"range",min:0,max:5,step:1},hook:Pi((()=>parseInt(r.multiPv())),t.cevalSetMultiPv)}),m("div.range_value",r.multiPv()+" / 5")])),(e=>m("div.setting",[m("label",{attrs:{for:e}},n("cpus")),m("input#"+e,{attrs:{type:"range",min:1,max:r.maxThreads,step:1,disabled:!r.threads,...r.threads?null:{title:a}},hook:Pi((()=>r.threads?parseInt(r.threads()):1),t.cevalSetThreads)}),m("div.range_value",`${r.threads?r.threads():1} / ${r.maxThreads}`)]))("analyse-threads"),(e=>{return m("div.setting",[m("label",{attrs:{for:e}},n("memory")),m("input#"+e,{attrs:{type:"range",min:4,max:Math.floor(Math.log2(r.maxHashSize)),step:1,disabled:!r.hashSize,...r.hashSize?null:{title:a}},hook:Pi((()=>Math.floor(Math.log2(r.hashSize?parseInt(r.hashSize()):16))),(e=>t.cevalSetHashSize(Math.pow(2,e))))}),m("div.range_value",(o=r.hashSize?parseInt(r.hashSize()):16,o<1e3?o+"MB":Math.round(o/1024)+"GB"))]);var o})("analyse-memory")]:[]):[];var l;const d=[$i({name:n("inlineNotation"),title:"Shift+I",id:"inline",checked:t.treeView.inline(),change(e){t.treeView.set(e),t.actionMenu.toggle()}},t)];return m("div.action-menu",s.concat(d).concat(c).concat(t.mainline.length>4?[m("h2",n("replayMode")),Mi(t)]:[]).concat([Si(t,t.opts.userId),o?m("div.continue-with.none.g_"+e.game.id,[m("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#ai":gi(e,"ai")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithTheMachine")),m("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#friend":gi(e,"friend")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithAFriend"))]):null]))}function $i(t,e){return mi(t,e.trans,e.redraw)}function _i(t){const e={};return t&&(e[t]=!0),m("move.empty",{class:e},"...")}function Ni(t,e,n){const o=e.children,r=o[0];if(!r)return;const i=n.noConceal?null:n.conceal||t.concealOf(!0)(n.parentPath+r.id,r);if("hide"!==i){if(n.isMainline){const e=r.ply%2==1,s=Ri(t,r,i,!0).filter(vs);if(!o[1]&&N(s)&&!r.forceVariation)return(e?[wr(r.ply,!1)]:[]).concat(Oi(t,r,{parentPath:n.parentPath,isMainline:!0,conceal:i})||[]);const a=r.forceVariation?void 0:Ni(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,conceal:i}),c={parentPath:n.parentPath,isMainline:!r.forceVariation,conceal:i};return(e?[wr(r.ply,!1)]:[]).concat(r.forceVariation?[]:[qi(t,r,c),e?_i(c.conceal):null]).concat([m("interrupt",s.concat(Di(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:c.isMainline,conceal:i,noConceal:!i})))]).concat(e&&a?[wr(r.ply,!1),_i(c.conceal)]:[]).concat(a||[])}return o[1]?function(t,e,n){if(!e[1]||e[2])return;if(ee(e[1],6))return;return Oi(t,e[0],{parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,inline:e[1]})}(t,o,n)||[Di(t,o,n)]:Oi(t,r,n)}}function Di(t,e,n){return m("lines",{class:{single:!e[1]}},e.map((e=>ms(t,e)||m("line",Oi(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,noConceal:n.noConceal,truncate:e.comp&&!Gt(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function qi(t,e,n){return n.isMainline?function(t,e,n){const o=n.parentPath+e.id,r=ls(t,e,o);n.conceal&&(r[n.conceal]=!0);return m("move",{attrs:{p:o},class:r},kr(t,e))}(t,e,n):function(t,e,n){const o=n.withIndex||e.ply%2==1,r=n.parentPath+e.id,i=[o?wr(e.ply,!0):null,$t(e.san)],s=ls(t,e,r);n.conceal&&(s[n.conceal]=!0);e.glyphs&&e.glyphs.forEach((t=>i.push(vr(t))));return m("move",{attrs:{p:r},class:s},i)}(t,e,n)}function Oi(t,e,n){const o=n.parentPath+e.id;return 0===n.truncate?[m("move",{attrs:{p:o}},[m("index","[...]")])]:[qi(t,e,n)].concat(us(t,e)).concat(n.inline?function(t,e,n){return m("inline",Oi(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,truncate:n.truncate}))}(t,n.inline,n):null).concat(Ni(t,e,{parentPath:o,isMainline:n.isMainline,noConceal:n.noConceal,truncate:n.truncate?n.truncate-1:void 0})||[])}function Ri(t,e,n,o){if(!t.ctrl.showComments||N(e.comments))return[];const r=o?e.ply%2==0?".black ":".white ":"";return e.comments.map((o=>{if("lichess"===o.by&&!t.showComputer)return;let i="comment"+r;o.text.startsWith("Inaccuracy.")?i+=".inaccuracy":o.text.startsWith("Mistake.")?i+=".mistake":o.text.startsWith("Blunder.")&&(i+=".blunder"),n&&(i+="."+n);const s=e.comments[1]?`<span class="by">${jn(o.by)}</span>`:"";return m(i,{hook:st(hs(o.text,400,t),(t=>s+ct(t)))})}))}const Li=function(){return function(){return null}};function Fi(t){return m("select.selector",{hook:S("change",(t=>{location.href="/practice/"+t.target.value}))},[m("option",{attrs:{disabled:!0,selected:!0}},"Practice list"),...t.structure.map((t=>m("optgroup",{attrs:{label:t.name}},t.studies.map((e=>$e(t.id+"/"+e.slug+"/"+e.id,"",e.name))))))])}function Bi(t,e){const n=t.goal();switch(n.result){case"mate":return"Checkmate the opponent";case"mateIn":return"Checkmate the opponent in "+Ae("move",e);case"drawIn":return"Hold the draw for "+Ae("more move",e);case"equalIn":return"Equalize in "+Ae("move",e);case"evalIn":return t.isWhite()===n.cp>=0?"Get a winning position in "+Ae("move",e):"Defend for "+Ae("move",e);case"promotion":return"Safely promote your pawn";default:return}}function ji(t){const e=t.currentChapter(),n=t.practice.data;return m("div.practice__side",[m("div.practice__side__title",[m("i."+n.study.id),m("div.text",[m("h1",n.study.name),m("em",n.study.desc)])]),m("div.practice__side__chapters",{hook:M("click",(e=>{e.preventDefault();const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");return o&&t.setChapter(o,!0),!1}))},t.chapters.list().map((function(o){const r=t.vm.loading&&o.id===t.vm.nextChapterId,i=!t.vm.loading&&e&&e.id===o.id,s=n.completion[o.id]>=0?"done":"ongoing";return[m("a.ps__chapter",{key:o.id,attrs:{href:n.url+"/"+o.id,"data-id":o.id},class:{active:i,loading:r}},[m("span.status."+s,{attrs:{"data-icon":(r||i)&&"ongoing"===s?"":""}}),m("h3",o.name)])]})).reduce(((t,e)=>t.concat(e)),[])),m("div.finally",[m("a.back",{attrs:{"data-icon":"",href:"/practice",title:"More practice"}}),b("select.selector",Fi,[n])])])}function zi(t){const e=t.study,n=e.gamebookPlay();if(!n)return;const o="play"===n.state.feedback;return m("div.gamebook-buttons",[t.path?m("button.fbt.text.back",{attrs:{"data-icon":"",type:"button"},hook:S("click",(()=>t.userJump("")),n.redraw)},t.trans.noarg("back")):null,o?m("button.fbt.text.solution",{attrs:{"data-icon":"",type:"button"},hook:S("click",n.solution,n.redraw)},t.trans.noarg("viewTheSolution")):void 0,Gi(e)])}function Gi(t){if(t.data.chapter.gamebook){const e=t.vm.gamebookOverride;if(t.members.canContribute())return m("button.fbt.text.preview",{class:{active:"play"===e},attrs:{"data-icon":"",type:"button"},hook:S("click",(()=>{t.setGamebookOverride("play"===e?void 0:"play")}),t.redraw)},"Preview");{const n="analyse"===e,o=t.gamebookPlay();if(n||o&&"end"===o.state.feedback)return m("a.fbt.text.preview",{class:{active:n},attrs:E(""),hook:S("click",(()=>{t.setGamebookOverride(n?void 0:"analyse")}),t.redraw)},t.trans.noarg("analysis"))}}}function Vi(t){return m("div.relay-tour__text__schedule",[m("h2","Schedule"),m("table.slist.slist-invert",m("tbody",t.data.rounds.map((e=>m("tr",[m("th",m("a.link",{attrs:{href:t.roundPath(e)}},e.name)),m("td",e.startsAt?lichess.dateFormat()(new Date(e.startsAt)):void 0),m("td",Hi(e)||(e.startsAt?lichess.timeago(e.startsAt):void 0))])))))])}const Hi=t=>t.ongoing?m("ongoing",{attrs:{...E(""),title:"Ongoing"}}):t.finished?m("finished",{attrs:{...E(""),title:"Finished"}}):null;function Wi(t){return m("span."+t.tab,{attrs:{title:t.hint},class:{active:t.tab===t.ctrl.vm.toolTab()},hook:S("mousedown",(()=>{t.onClick&&t.onClick(),t.ctrl.vm.toolTab(t.tab)}),t.ctrl.redraw)},[t.count?m("count.data-count",{attrs:{"data-count":t.count}}):null,t.icon])}function Ui(t){const e=t.study,n=e.members.canContribute(),o=e.data.features.sticky&&(n||e.vm.behind&&e.isUpdatedRecently()),r=t.trans.noarg;return m("div.study__buttons",[m("div.left-buttons.tabs-horiz",[o?m("a.mode.sync",{attrs:{title:r("allSyncMembersRemainOnTheSamePosition")},class:{on:e.vm.mode.sticky},hook:S("click",e.toggleSticky)},[e.vm.behind?m("span.behind",""+e.vm.behind):m("i.is"),"SYNC"]):null,e.members.canContribute()?m("a.mode.write",{attrs:{title:r("shareChanges")},class:{on:e.vm.mode.write},hook:S("click",e.toggleWrite)},[m("i.is"),"REC"]):null,Wi({ctrl:e,tab:"tags",hint:r("pgnTags"),icon:Pe("")}),Wi({ctrl:e,tab:"comments",hint:r("commentThisPosition"),icon:Pe(""),onClick(){e.commentForm.start(e.vm.chapterId,t.path,t.node)},count:(t.node.comments||[]).length}),n?Wi({ctrl:e,tab:"glyphs",hint:r("annotateWithGlyphs"),icon:m("i.glyph-icon"),count:(t.node.glyphs||[]).length}):null,Wi({ctrl:e,tab:"serverEval",hint:r("computerAnalysis"),icon:Pe(""),count:t.data.analysis&&"✓"}),Wi({ctrl:e,tab:"multiBoard",hint:"Multiboard",icon:Pe("")}),Wi({ctrl:e,tab:"share",hint:r("shareAndExport"),icon:Pe("")}),e.relay?null:m("span.help",{attrs:{title:"Need help? Get the tour!","data-icon":""},hook:S("click",e.startTour)})]),m("div.right",[Gi(e)])])}function Ki(t){var e;const n=t.data,o=null===(e=t.relay)||void 0===e?void 0:e.data.tour.credit,r=`${n.name}: ${t.currentChapter().name}`;return m("div.study__metadata",[m("h2",[m("span.name",{attrs:{title:r}},[r,o?m("span.credit",{hook:lt(o,!1)}):void 0]),m("span.liking.text",{class:{liked:n.liked},attrs:{"data-icon":n.liked?"":"",title:t.trans.noarg(n.liked?"unlike":"like")},hook:S("click",t.toggleLike)},""+n.likes)]),Kn(t),Ar(t)])}function Ji(t){var e;const n=t.vm.tab(),o=null===(e=t.relay)||void 0===e?void 0:e.tourShow,r=(e,r)=>m("span."+e,{class:{active:!(null==o?void 0:o.active)&&n===e},hook:S("mousedown",(()=>{null==o||o.disable(),t.vm.tab(e)}),t.redraw)},r),i=o&&m("span.relay-tour.text",{class:{active:o.active},hook:S("mousedown",(()=>{o.active=!0}),t.redraw),attrs:{"data-icon":""}},"Broadcast"),s=m("div.tabs-horiz",[i,o&&t.looksNew()&&!t.members.canContribute()?null:r("chapters",t.trans.plural(t.relay?"nbGames":"nbChapters",t.chapters.size())),!i||t.members.canContribute()||t.data.admin?r("members",t.trans.plural("nbMembers",t.members.size())):null,t.members.isOwner()?m("span.more",{hook:S("click",(()=>t.form.open(!t.form.open())),t.redraw)},[Pe("")]):null]),a=(null==o?void 0:o.active)?function(t){const e=t.members.canContribute(),n=t.relay;return m("div.study__relay__rounds",n.data.rounds.map((o=>m("div",{key:o.id,class:{active:t.data.id==o.id}},[m("a.link",{attrs:{href:n.roundPath(o)}},o.name),Hi(o),e?m("a.act",{attrs:{...E(""),href:`/broadcast/round/${o.id}/edit`}}):null]))).concat(e?[m("div.add",m("a.text",{attrs:{href:`/broadcast/${n.data.tour.id}/new`,"data-icon":""}},t.trans.noarg("addRound")))]:[]))}(t):("members"===n?qe:Dn)(t);return m("div.study__side",[s,a])}function Yi(t){return t.chapters.newForm.vm.open?function(t){const e=t.root.trans,n=t.vm.tab(),o=function(e,o,r){return m("span."+e,{class:{active:n===e},attrs:{title:r},hook:S("click",(()=>t.vm.tab(e)),t.root.redraw)},o)},r="game"===n||"pgn"===n,i=t.root.study.data.chapter,s=i.practice?"practice":I(i.conceal)?"conceal":i.gamebook?"gamebook":"normal",a=e.noarg;return me({class:"chapter-new",onClose(){t.close(),t.redraw()},noClickAway:!0,content:["edit"===n?null:m("h2",[a("newChapter"),m("i.help",{attrs:{"data-icon":""},hook:S("click",t.startTour)})]),m("form.form3",{hook:P((e=>{t.submit({name:Pn(e,"name"),game:Pn(e,"game"),variant:Pn(e,"variant"),pgn:Pn(e,"pgn"),orientation:Pn(e,"orientation"),mode:Pn(e,"mode"),fen:Pn(e,"fen")||("edit"===t.vm.tab()?t.vm.editorFen():null),isDefaultName:t.vm.isDefaultName})}),t.redraw)},[m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-name"}},a("name")),m("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:x((n=>{n.value||(n.value=e("chapterX",t.vm.initial()?1:t.chapters().length+1),n.onchange=function(){t.vm.isDefaultName=!1},n.select(),n.focus())}))})]),m("div.tabs-horiz",[o("init",a("empty"),a("startFromInitialPosition")),o("edit",a("editor"),a("startFromCustomPosition")),o("game","URL",a("loadAGameByUrl")),o("fen","FEN",a("loadAPositionFromFen")),o("pgn","PGN",a("loadAGameFromPgn"))]),"edit"===n?m("div.board-editor-wrap",{hook:{insert(e){Promise.all([lichess.loadModule("editor"),B("/editor.json")]).then((([n,o])=>{o.fen=t.root.node.fen,o.embed=!0,o.options={inlineCastling:!0,orientation:i.setup.orientation,onChange:t.vm.editorFen},t.vm.editor=window.LichessEditor(e.elm,o),t.vm.editorFen(t.vm.editor.getFen())}))},destroy:e=>{t.vm.editor=null}}},[ye()]):null,"game"===n?m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-game"}},e("loadAGameFromXOrY","lichess.org","chessgames.com")),m("textarea#chapter-game.form-control",{attrs:{placeholder:a("urlOfTheGame")},hook:x((t=>{t.addEventListener("change",(()=>t.reportValidity())),t.addEventListener("input",(e=>{const n=t.value.trim().split("\n").every((t=>t.trim().match(new RegExp(`^((.*${location.host}/\\w{8,12}.*)|\\w{8}|\\w{12}|(.*chessgames\\.com/.*[?&]gid=\\d+.*)|)$`))));t.setCustomValidity(n?"":"Invalid game ID(s) or URL(s)")}))}))})]):null,"fen"===n?m("div.form-group",[m("input#chapter-fen.form-control",{attrs:{value:t.root.node.fen,placeholder:a("loadAPositionFromFen")},hook:x((t=>{t.addEventListener("change",(()=>t.reportValidity())),t.addEventListener("input",(e=>t.setCustomValidity(yn(t.value.trim()).isOk?"":"Invalid FEN")))}))})]):null,"pgn"===n?m("div.form-groupabel",[m("textarea#chapter-pgn.form-control",{attrs:{placeholder:e.plural("pasteYourPgnTextHereUpToNbGames",t.multiPgnMax)}}),window.FileReader?m("input#chapter-pgn-file.form-control",{attrs:{type:"file",accept:".pgn"},hook:S("change",(t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=function(){document.getElementById("chapter-pgn").value=n.result},n.readAsText(e)}))}):null]):null,m("div.form-split",[m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-variant"}},a("Variant")),m("select#chapter-variant.form-control",{attrs:{disabled:r}},r?[m("option",a("automatic"))]:t.vm.variants.map((t=>$e(t.key,i.setup.variant.key,t.name))))]),m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-orientation"}},a("orientation")),m("select#chapter-orientation.form-control",{hook:S("change",(e=>{t.vm.editor&&t.vm.editor.setOrientation(e.target.value)}))},[..."pgn"===n?["automatic"]:[],"white","black"].map((t=>$e(t,i.setup.orientation,a(t)))))])]),m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-mode"}},a("analysisMode")),m("select#chapter-mode.form-control",Mn.map((t=>$e(t[0],s,a(t[1])))))]),An(a("createChapter"))])]})}(t.chapters.newForm):t.chapters.editForm.current()?function(t){const e=t.current();return e?me({class:"edit-"+e.id,onClose(){t.current(null),t.redraw()},content:[m("h2",t.trans.noarg("editChapter")),m("form.form3",{hook:P((e=>{t.submit({name:Pn(e,"name"),mode:Pn(e,"mode"),orientation:Pn(e,"orientation"),description:Pn(e,"description")})}),t.redraw)},[m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-name"}},t.trans.noarg("name")),m("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:x((t=>{t.value||(t.value=e.name,t.select(),t.focus())}))})]),...Tn(e)?In(t,e):[ye()]]),m("div.destructive",[m(Se,{hook:S("click",(n=>{confirm(t.trans.noarg("clearAllCommentsInThisChapter"))&&t.clearAnnotations(e.id)}),t.redraw),attrs:{type:"button"}},t.trans.noarg("clearAnnotations")),m(Se,{hook:S("click",(n=>{confirm(t.trans.noarg("deleteThisChapter"))&&t.delete(e.id)}),t.redraw),attrs:{type:"button"}},t.trans.noarg("deleteChapter"))])]}):void 0}(t.chapters.editForm):t.members.inviteForm.open()?function(t){const e=t.spectators().filter((e=>!t.members()[Te(e)])).sort();return me({class:"study__invite",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg("inviteToTheStudy")),m("p.info",{attrs:{"data-icon":""}},t.trans.noarg("pleaseOnlyInvitePeopleYouKnow")),m("div.input-wrapper",[m("input",{attrs:{placeholder:t.trans.noarg("searchByUsername")},hook:x((e=>lichess.userComplete().then((n=>{n({input:e,tag:"span",onSelect(n){e.value="",t.invite(n.name),t.redraw()}}),e.focus()}))))})]),e.length?m("div.users",e.map((function(e){return m("span.button.button-metal",{key:e,hook:S("click",(n=>t.invite(e)))},e)}))):void 0]})}(t.members.inviteForm):t.topics.open()?Yn(t.topics,t.members.myId):t.form.open()?function(t){const e=t.getData(),n=t.isNew(),o=function(t,o){const r=t.elm;o||r.value||(r.value=e.name,n&&r.select(),r.focus())},r=[["nobody",t.trans.noarg("nobody")],["owner",t.trans.noarg("onlyMe")],["contributor",t.trans.noarg("contributors")],["member",t.trans.noarg("members")],["everyone",t.trans.noarg("everyone")]];return me({class:"study-edit",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg(t.relay?"configureLiveBroadcast":n?"createStudy":"editStudy")),m("form.form3",{hook:P((e=>{const o=t=>{const n=e.target.querySelector("#study-"+t);if(n)return n.value;throw`Missing form input: ${t}`};t.save({name:o("name"),visibility:o("visibility"),computer:o("computer"),explorer:o("explorer"),cloneable:o("cloneable"),chat:o("chat"),sticky:o("sticky"),description:o("description")},n)}),t.redraw)},[m("div.form-group"+(t.relay?".none":""),[m("label.form-label",{attrs:{for:"study-name"}},t.trans.noarg("name")),m("input#study-name.form-control",{attrs:{minlength:3,maxlength:100},hook:{insert:t=>o(t,!1),postpatch:(t,e)=>o(e,!0)}})]),m("div.form-split",[m("div.form-group.form-half",Un({key:"visibility",name:t.trans.noarg("visibility"),choices:[["public",t.trans.noarg("public")],["unlisted",t.trans.noarg("unlisted")],["private",t.trans.noarg("inviteOnly")]],selected:e.visibility})),m("div.form-group.form-half",Un({key:"cloneable",name:t.trans.noarg("allowCloning"),choices:r,selected:e.settings.cloneable}))]),m("div.form-split",[m("div.form-group.form-half",Un({key:"computer",name:t.trans.noarg("computerAnalysis"),choices:r.map((e=>[e[0],t.trans.noarg(e[1])])),selected:e.settings.computer})),m("div.form-group.form-half",Un({key:"explorer",name:t.trans.noarg("openingExplorer"),choices:r,selected:e.settings.explorer}))]),m("div.form-split",[m("div.form-group.form-half",Un({key:"chat",name:t.trans.noarg("chat"),choices:r,selected:e.settings.chat})),m("div.form-group.form-half",Un({key:"sticky",name:t.trans.noarg("enableSync"),choices:[["true",t.trans.noarg("yesKeepEveryoneOnTheSamePosition")],["false",t.trans.noarg("noLetPeopleBrowseFreely")]],selected:""+e.settings.sticky}))]),m("div.form-group.form-half",Un({key:"description",name:t.trans.noarg("pinnedStudyComment"),choices:[["false",t.trans.noarg("noPinnedComment")],["true",t.trans.noarg("rightUnderTheBoard")]],selected:""+e.settings.description})),m("div.form-actions"+(t.relay?"":".single"),[...t.relay?[m("a.text",{attrs:{"data-icon":"",href:`/broadcast/${t.relay.data.tour.id}/edit`}},"Tournament settings"),m("a.text",{attrs:{"data-icon":"",href:`/broadcast/round/${e.id}/edit`}},"Round settings")]:[],m("button.button",{attrs:{type:"submit"}},t.trans.noarg(n?"start":"save"))])]),m("div.destructive",[n?null:m("form",{attrs:{action:"/study/"+e.id+"/clear-chat",method:"post"},hook:M("submit",(e=>confirm(t.trans.noarg("deleteTheStudyChatHistory"))))},[m(Se,t.trans.noarg("clearChat"))]),m("form",{attrs:{action:"/study/"+e.id+"/delete",method:"post"},hook:M("submit",(o=>{var r;return n||(null===(r=prompt(t.trans("confirmDeleteStudy",e.name)))||void 0===r?void 0:r.trim())===e.name.trim()}))},[m(Se,t.trans.noarg(n?"cancel":"deleteStudy"))])])]})}(t.form):void 0}function Xi(t){if(t.embed)return[];if(t.studyPractice)return function(t){if(t.vm.loading)return[m("div.feedback",ye())];const e=t.practice,n=t.gamebookPlay(),o=t.data.chapter.description;if(n)return o?[m("div.feedback.ongoing",[m("div.comment",{hook:lt(o)})])]:[];if(!t.data.chapter.practice)return[ni(t,!0)];switch(e.success()){case!0:return[m("a.feedback.win",t.nextChapter()?{hook:S("click",t.goToNextChapter)}:{attrs:{href:"/practice"}},[m("span","Success!"),t.nextChapter()?"Go to next exercise":"Back to practice menu"])];case!1:return[m("a.feedback.fail",{hook:S("click",e.reset,t.redraw)},[m("span",[Bi(e,e.goal().moves)]),m("strong","Click to retry")])];default:return[m("div.feedback.ongoing",[m("div.goal",[Bi(e,e.goal().moves-e.nbMoves())]),o?m("div.comment",{hook:lt(o)}):null]),mi({name:"Load next exercise immediately",id:"autoNext",checked:e.autoNext(),change:e.autoNext},t.trans,t.redraw)]}}(t.study);const e=t.study,n=e.vm.toolTab();if(e.gamebookPlay())return[zi(t),ni(e,!0),ni(e,!1),Ki(e)];let o;switch(n){case"tags":o=Ki(e);break;case"comments":o=e.vm.mode.write?function(t){const e=t.study,n=e.commentForm,o=n.current();if(!o)return Gn(t,"Select a move to comment");const r=(t,e)=>{const r=t.elm,i=o.chapterId+o.path;if((null==e?void 0:e.data.path)!==i){const t=(o.node.comments||[]).find((function(t){return Bn(t.by)&&t.by.id&&t.by.id===n.root.opts.userId}));r.value=t?t.text:""}t.data.path=i,n.opening()&&(requestAnimationFrame((()=>r.focus())),n.opening(!1))};return m("div.study__comments",{hook:x((()=>t.enableWiki(!0)))},[zn(t,!e.members.canContribute()),m("form.form3",[m("textarea#comment-text.form-control",{hook:{insert(t){r(t);const e=t.elm;e.oninput=()=>setTimeout((()=>n.submit(e.value)),50);const o=lichess.storage.make("study.comment.height");e.onmouseup=()=>o.set(""+e.offsetHeight),e.style.height=parseInt(o.get()||"80")+"px"},postpatch:(t,e)=>r(e,t)}})]),m("div.analyse__wiki.study__wiki")])}(t):Gn(t,e.members.canContribute()?"Press REC to comment moves":"Only the study members can comment on moves");break;case"glyphs":o=t.path?e.vm.mode.write?function(t){const e=t.all(),n=t.root.node;return m("div.study__glyphs"+(e?"":".empty"),{hook:{insert:t.loadGlyphs}},e?[m("div.move",e.move.map(Vn(t,n))),m("div.position",e.position.map(Vn(t,n))),m("div.observation",e.observation.map(Vn(t,n)))]:[m("div.study__message",ye())])}(e.glyphForm):Wn("Press REC to annotate moves"):Wn("Select a move to annotate");break;case"serverEval":o=Tr(e.serverEval);break;case"share":o=function(t){const e=t.studyId,n=t.chapter(),o=t.isPrivate(),r=e=>t.withPly()?`${e}#${t.currentNode().ply}`:e;return m("div.study__share",[m("div.downloads",[t.cloneable?m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/clone`}},t.trans.noarg("cloneStudy")):null,t.relay&&m("a.button.text",{attrs:{"data-icon":"",href:`/api/broadcast/${t.relay.data.tour.id}.pgn`,download:!0}},t.trans.noarg("downloadAllRounds")),m("a.button.text",{attrs:{"data-icon":"",href:t.relay?`${t.relay.roundPath()}.pgn`:`/study/${e}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadAllGames":"studyPgn")),m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/${n.id}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadGame":"chapterPgn")),m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/${n.id}.gif`,download:!0}},"GIF")]),m("form.form3",[...(t.relay?[["broadcastUrl",t.relay.tourPath()],["currentRoundUrl",t.relay.roundPath()],["currentGameUrl",`${t.relay.roundPath()}/${n.id}`]]:[["studyUrl",r(`/study/${e}`),!0],["currentChapterUrl",r(`/study/${e}/${n.id}`),!0]]).map((([e,n,r])=>m("div.form-group",[m("label.form-label",t.trans.noarg(e)),m("input.form-control.autoselect",{attrs:{readonly:!0,value:`${Ie()}${n}`}}),...r?[xr(t),o?null:m("p.form-help.text",{attrs:{"data-icon":""}},t.trans.noarg("youCanPasteThisInTheForumToEmbed"))]:[]]))),m("div.form-group",[m("label.form-label",t.trans.noarg("embedInYourWebsite")),m("input.form-control.autoselect",{attrs:{readonly:!0,disabled:o,value:o?t.trans.noarg("onlyPublicStudiesCanBeEmbedded"):`<iframe width=600 height=371 src="${Ie()}${r(`/study/embed/${e}/${n.id}`)}" frameborder=0></iframe>`}})].concat(o?[]:[xr(t),m("a.form-help.text",{attrs:{href:"/developers#embed-study",target:"_blank",rel:"noopener","data-icon":""}},t.trans.noarg("readMoreAboutEmbedding"))])),m("div.form-group",[m("label.form-label","FEN"),m("input.form-control.autoselect",{attrs:{readonly:!0,value:t.currentNode().fen}})])])])}(e.share);break;case"multiBoard":o=ii(e.multiBoard,e)}return[Xn(e.notif),ni(e,!0),ni(e,!1),Ui(t),o]}function Qi(t,e){const n=t.offsetWidth+4,o=t.offsetHeight+4,r=window.innerWidth,i=window.innerHeight;t.style.left=r-e.x<n?r-n+"px":t.style.left=e.x+"px",t.style.top=i-e.y<o?i-o+"px":t.style.top=e.y+"px"}function Zi(t,e,n){return m("a",{attrs:{"data-icon":t},hook:S("click",n)},e)}function ts(t,e){const n=t.root,o=n.tree.nodeAtPath(t.path),r=n.tree.pathIsMainline(t.path)&&!n.tree.pathIsForcedVariation(t.path),i=n.trans.noarg;return m("div#analyse-cm.visible",{hook:{...x((t=>{t.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),Qi(t,e)})),postpatch:(t,n)=>Qi(n.elm,e)}},[m("p.title",Ee(o)),r?null:Zi("",i("promoteVariation"),(()=>n.promote(t.path,!1))),r?null:Zi("",i("makeMainLine"),(()=>n.promote(t.path,!0))),Zi("",i("deleteFromHere"),(()=>n.deleteNode(t.path)))].concat(n.study?function(t,e,n){return t.vm.mode.write?[m("a",{attrs:E(""),hook:S("click",(()=>{t.vm.toolTab("comments"),t.commentForm.start(t.currentChapter().id,e,n)}))},t.trans.noarg("commentThisMove")),m("a.glyph-icon",{hook:S("click",(()=>{t.vm.toolTab("glyphs"),t.userJump(e)}))},t.trans.noarg("annotateWithGlyphs"))]:[]}(n.study,t.path,o):[]).concat([r?Zi("",i("forceVariation"),(()=>n.forceVariation(t.path,!0))):null]))}function es(t,e){let n=function(t){let e=t;return"touches"in t&&t.touches.length>0&&(e=t.touches[0]),e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:e.clientX||e.clientY?{x:e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:e.clientY+document.body.scrollTop+document.documentElement.scrollTop}:null}(t);if(null===n){if(e.root.contextMenuPath)return;n={x:0,y:0}}const o=$("#analyse-cm")[0]||$('<div id="analyse-cm">').appendTo($("body"))[0];e.root.contextMenuPath=e.path,document.addEventListener("click",(function t(n){2!==n.button&&(e.root.contextMenuPath=void 0,document.removeEventListener("click",t,!1),$("#analyse-cm").removeClass("visible"),e.root.redraw())}),!1),o.innerHTML="",ud(o,ts(e,n))}function ns(t,e,n){const o=e.children,r=o[0];if(r)return n.isMainline?o[1]||r.forceVariation?os(t,o,n)||[...r.forceVariation?[]:[ss(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}),...us(t,r)],m("interrupt",rs(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:!0})),...r.forceVariation?[]:ns(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,withIndex:!0})||[]]:is(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}):o[1]?os(t,o,n)||[rs(t,o,n)]:is(t,r,n)}function os(t,e,n){if(e[1]&&!e[2]&&!e[0].forceVariation&&!ee(e[1],6))return is(t,e[0],{parentPath:n.parentPath,isMainline:n.isMainline,inline:e[1]})}function rs(t,e,n){return m("lines",e.map((e=>ms(t,e)||m("line",is(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,truncate:e.comp&&!Gt(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function is(t,e,n){const o=n.parentPath+e.id,r=us(t,e);return 0===n.truncate?[m("move",{attrs:{p:o}},"[...]")]:[ss(t,e,n)].concat(r).concat(n.inline?function(t,e,n){const o=ms(t,e);return o?m("interrupt",m("lines",o)):m("inline",is(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1}))}(t,n.inline,n):null).concat(ns(t,e,{parentPath:o,isMainline:n.isMainline,truncate:n.truncate?n.truncate-1:void 0,withIndex:!!r[0]})||[])}function ss(t,e,n){const o=n.parentPath+e.id,r=[n.withIndex||1&e.ply?wr(e.ply,!0):null,$t(e.san)];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>r.push(vr(t)))),m("move",{attrs:{p:o},class:ls(t,e,o)},r)}let as="init";function cs(t,e){return!t.treeView.inline()&&("string"==typeof as&&("init"==as&&(window.addEventListener("resize",(()=>{as="rec"})),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame((()=>{as="rec"}))),as=!!getComputedStyle(document.body).getPropertyValue("--col1")),!as)||e?function(t,e){const n=t.tree.root,o={ctrl:t,truncateComments:!t.embed,concealOf:e||Li,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:t.showComputer(),currentPath:ds(t)},r=Ri(o,n,!1,!1);return m("div.tview2.tview2-column",{hook:ps(t)},[N(r)?null:m("interrupt",r),1&n.ply?wr(n.ply,!1):null,1&n.ply?_i():null].concat(Ni(o,n,{parentPath:"",isMainline:!0})||[]))}(t,e):function(t){const e={ctrl:t,truncateComments:!1,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:!!t.study||t.showComputer(),currentPath:ds(t)};return m("div.tview2.tview2-inline",{hook:ps(t)},[...us(e,t.tree.root),...ns(e,t.tree.root,{parentPath:"",isMainline:!0})||[]])}(t)}function ls(t,e,n){const o=t.showGlyphs&&e.glyphs?e.glyphs.map((t=>t.id)):[];return{active:n===t.ctrl.path,"context-menu":n===t.ctrl.contextMenuPath,current:n===t.currentPath,nongame:!t.currentPath&&!!t.ctrl.gamePath&&Gt(n,t.ctrl.gamePath)&&n!==t.ctrl.gamePath,inaccuracy:o.includes(6),mistake:o.includes(2),blunder:o.includes(4)}}function ds(t){let e;return!t.synthetic&&Ot(t.data)&&t.initialPath||t.retro&&(e=t.retro.current())&&e.prev.path||t.study&&t.study.data.chapter.relay&&t.study.data.chapter.relay.path}function us(t,e){return!t.ctrl.showComments||N(e.comments)?[]:e.comments.map((n=>{if("lichess"===n.by&&!t.showComputer)return;const o=e.comments[1]?`<span class="by">${jn(n.by)}</span>`:"";return m("comment",{hook:st(hs(n.text,300,t),(t=>o+ct(t)))})})).filter(vs)}function hs(t,e,n){return n.truncateComments&&t.length>e?t.slice(0,e-10)+" [...]":t}function ps(t){return{insert:e=>{const n=e.elm;""!==t.path&&gs(t,n);const o=e=>{const n=fs(e);return null!==n&&es(e,{path:n,root:t}),t.redraw(),!1};n.oncontextmenu=o,function(t,e,n){let o;t.addEventListener("touchstart",(t=>{o=setTimeout((()=>{e(t),n&&n()}),610)})),t.addEventListener("touchmove",(()=>{clearTimeout(o)})),t.addEventListener("touchcancel",(()=>{clearTimeout(o)})),t.addEventListener("touchend",(()=>{clearTimeout(o)}))}(n,o,t.redraw),n.addEventListener("mousedown",(e=>{if(I(e.button)&&0!==e.button)return;const n=fs(e);n&&t.userJump(n),t.redraw()}))},postpatch:(e,n)=>{t.autoScrollRequested&&(gs(t,n.elm),t.autoScrollRequested=!1)}}}function ms(t,e){return e.comp&&t.ctrl.retro&&t.ctrl.retro.hideComputerLine(e)?m("line",t.ctrl.trans.noarg("learnFromThisMistake")):void 0}function fs(t){return t.target.getAttribute("p")||t.target.parentNode.getAttribute("p")}const gs=Ne(200,((t,e)=>{const n=e.parentNode;if(!n)return;const o=e.querySelector(".active");n.scrollTop=o?o.offsetTop-n.offsetHeight/2+o.offsetHeight:t.path?99999:0})),vs=t=>!!t;function bs(t){const e={fen:t.fen,nodes:1e3*t.knodes,depth:t.depth,pvs:t.pvs.map((t=>{const e={moves:t.moves.split(" ")};return I(t.cp)?e.cp=t.cp:e.mate=t.mate,e})),cloud:!0};return I(e.pvs[0].cp)?e.cp=e.pvs[0].cp:e.mate=e.pvs[0].mate,e.cloud=!0,e}function ys(t){let e={};const n=q(!1);return lichess.pubsub.on("socket.in.crowd",(t=>n(t.nb>2&&t.nb<99999))),{onCeval:Ne(500,(()=>{const n=t.getNode(),o=n.ceval,r=e[n.fen];o&&!o.cloud&&n.fen in e&&(!r||r.depth<o.depth)&&function(t){return t.nodes>5e5&&(t.depth>=20||t.nodes>3e6)}(o)&&t.canPut()&&t.send("evalPut",function(t,e){const n={fen:e.fen,knodes:Math.round(e.nodes/1e3),depth:e.depth,pvs:e.pvs.map((t=>({cp:t.cp,mate:t.mate,moves:t.moves.slice(0,10).join(" ")})))};return"standard"!==t&&(n.variant=t),n}(t.variant,o))})),fetch(o,r){const i=t.getNode();if(i.ceval&&i.ceval.cloud||!t.canGet())return;const s=e[i.fen];if(s)return t.receive(bs(s),o);if(i.fen in e)return;e[i.fen]=void 0;const a={fen:i.fen,path:o};"standard"!==t.variant&&(a.variant=t.variant),r>1&&(a.mpv=r),n()&&(a.up=!0),t.send("evalGet",a)},onCloudEval(n){e[n.fen]=n,t.receive(bs(n),n.path)},clear(){e={}}}}function ws(t,e,n){const o=`/${e.game.id}${e.player.id}/forecasts`;let r=t.steps||[];const i=q(!1);function s(t){return t.map((t=>t.ply+":"+t.uci)).join(",")}function a(t,e){return t.length>=e.length&&s(t).startsWith(s(e))}function c(t){return r.filter((e=>a(e,[t])))}function l(e){return t.onMyTurn?(e.length%2!=1?e.slice(0,-1):e).slice(0,30):(e.length%2!=0?e.slice(0,-1):e).slice(0,30)}function d(){r=r.filter((function(t,e){return 0===r.filter((function(n,o){return e!==o&&a(n,t)})).length})),r=r.filter((function(e,n){return 0===r.filter((function(o,r){return n<r&&function(e,n){for(let o=0,r=Math.min(e.length,n.length);o<r;o++)if(e[o].uci!==n[o].uci)return t.onMyTurn?0!==o&&o%2==0:o%2==1;return!0}(o,e)})).length}))}function u(){i(!0),n(),history.replaceState(null,"","#last"),lichess.reload()}function h(e){if(!function(e){return e.length>=(t.onMyTurn?1:2)}(e=l(e)))return!1;return!r.filter((t=>a(t,e))).length}function p(){t.onMyTurn||(i(!0),n(),B(o,{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?u():(i(!1),r=t.steps||[]),n()})))}return d(),{addNodes(t){h(t=l(t))&&(r.push(t),d(),p())},isCandidate:h,removeIndex(t){r=r.filter(((e,n)=>n!==t)),p()},list:()=>r,truncate:l,loading:i,onMyTurn:!!t.onMyTurn,findStartingWithNode:c,playAndSave:function(e){t.onMyTurn&&(i(!0),n(),B(`${o}/${e.uci}`,{method:"POST",body:JSON.stringify(c(e).filter(D).map((t=>t.slice(1)))),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?u():(i(!1),r=t.steps||[]),n()})))},reloadToLastPly:u}}const ks=t=>{const e=t.target;return parseInt(e.parentNode.getAttribute("data-it")||e.getAttribute("data-it")||"")};function Cs(t,e){if(t.embed||t.retro)return;const n=t.fork.state();if(!n.displayed)return;const o=e&&t.onMainline;return m("div.analyse__fork",{hook:x((e=>{e.addEventListener("click",(e=>{t.fork.proceed(ks(e)),t.redraw()})),e.addEventListener("mouseover",(e=>t.fork.highlight(ks(e)))),e.addEventListener("mouseout",(()=>t.fork.highlight()))}))},n.node.children.map(((r,i)=>{if(!(o&&e(!0)(t.path+r.id,r)))return m("move",{class:{selected:i===n.selected},attrs:{"data-it":i}},Cr({withDots:!0,showEval:t.showComputer(),showGlyphs:t.showComputer()},r))})))}function xs(t){return!!t.children.find((t=>!!t.comp))}function Ss(t){return t.split(" ").slice(0,4).join(" ")}async function Ms(t,e){const n=t.config,o=n.byDb(),r=new URL(`/${t.db}`,t.endpoint),i=r.searchParams;if(i.set("variant",t.variant||"standard"),i.set("fen",t.rootFen),i.set("play",t.play.join(",")),"masters"===t.db?(o.since()&&i.set("since",o.since().split("-")[0]),o.until()&&i.set("until",o.until().split("-")[0])):(o.since()&&i.set("since",o.since()),o.until()&&i.set("until",o.until()),i.set("speeds",n.speed().join(","))),"lichess"===t.db&&i.set("ratings",n.rating().join(",")),"player"===t.db){const t=n.playerName.value();if(!t)return Ps(new Error("Missing player name"));i.set("player",t),i.set("color",n.color()),i.set("modes",n.mode().join(","))}let s;t.withGames||(i.set("topGames","0"),i.set("recentGames","0"));try{if(s=await fetch(r.href,{cache:"default",headers:{},credentials:"omit"}),!s.ok)throw new Error(`Status ${s.status}`)}catch(c){return Ps(c)}return(a=n=>{const o=n;o.isOpening=!0,o.fen=t.fen,e(o)},t=>{const e=t.body.getReader(),n=/\r?\n/,o=new TextDecoder;let r="";const i=()=>e.read().then((({done:t,value:e})=>{r+=o.decode(e||new Uint8Array,{stream:!t});const s=r.split(n);t||(r=s.pop());for(const n of s)n&&a(JSON.parse(n));return t?Promise.resolve(!0):i()}));return{cancel:()=>e.cancel(),end:Qn(i())}})(s);var a}const Ps=t=>({cancel(){},end:Qn(Promise.resolve(t))});async function Es(t,e,n){const o="fromPosition"===e||"chess960"===e?"standard":e,r=await B(V(`${t}/${o}`,{fen:n}),{cache:"default",headers:{},credentials:"omit"});return r.tablebase=!0,r.fen=n,r}function As(t){return"w"===t.split(" ")[1]?"white":"black"}function Ts(t,e){const n=As(t);return e.checkmate||e.variant_loss||e.dtz&&e.dtz<0?n:e.variant_win||e.dtz&&e.dtz>0?nn(n):void 0}const Is=t=>`${t[0].toUpperCase()}${t.slice(1)}`,$s=(t,e)=>({attrs:{"data-fen":e.fen},hook:{insert(n){const o=n.elm;o.addEventListener("mouseover",(e=>{t.explorer.setHovering($(o).attr("data-fen"),$(e.target).parents("tr").attr("data-uci"))})),o.addEventListener("mouseout",(e=>{t.explorer.setHovering($(o).attr("data-fen"),null)})),o.addEventListener("click",(t=>{const n=$(t.target).parents("tr").attr("data-uci");e.onClick(t,n)}))}}}),_s={icons:{ultraBullet:"",bullet:"",blitz:"",rapid:"",classical:"",correspondence:"",chess960:"",kingOfTheHill:"",threeCheck:"",antichess:"",atomic:"",horde:""}},Ns=["ultraBullet","bullet","blitz","rapid","classical","correspondence"],Ds=["casual","rated"],qs=[1600,1800,2e3,2200,2500],Os=1952;class Rs{constructor(t,e,n){this.root=t,this.variant=e,this.onClose=n,this.allDbs=["lichess","player"],this.selectPlayer=t=>{if(t="me"==t?this.myName:t){if(t!=this.myName){const e=this.data.playerName.previous().filter((e=>e!==t));e.unshift(t),this.data.playerName.previous(e.slice(0,20))}this.data.db("player"),this.data.playerName.value(t),this.data.playerName.open(!1)}},this.toggleMany=t=>e=>{t().includes(e)?t().length>1&&t(t().filter((t=>t!==e))):t(t().concat([e]))},this.toggleColor=()=>this.data.color(Fr(this.data.color())),this.toggleOpen=()=>{this.data.open(!this.data.open()),this.data.open()||("player"!=this.data.db()||this.data.playerName.value()||this.data.db("lichess"),this.onClose())},this.fullHouse=()=>this.data.byDb().since()<="1952-01"&&(!this.data.byDb().until()||(new Date).toISOString().slice(0,7)<=this.data.byDb().until())&&("masters"===this.data.db()||this.data.speed().length==Ns.length)&&("lichess"!==this.data.db()||this.data.rating().length==qs.length)&&("player"!==this.data.db()||this.data.mode().length==Ds.length),this.myName=document.body.dataset.user,"standard"===e&&this.allDbs.unshift("masters");const o={};for(const r of this.allDbs)o[r]={since:xn("explorer.since-2."+r,("masters"===r?Os:2012)+"-01"),until:xn("explorer.until-2."+r,(new Date).toISOString().slice(0,7))};this.data={open:q(!1),db:xn("explorer.db."+e,this.allDbs[0]),rating:Sn("explorer.rating",(()=>qs)),speed:Sn("explorer.speed",(()=>Ns)),mode:Sn("explorer.mode",(()=>Ds)),byDbData:o,playerName:{open:q(!1),value:xn("explorer.player.name",document.body.dataset.user||""),previous:Sn("explorer.player.name.previous",(()=>[]))},color:q("white"),byDb(){return this.byDbData[this.db()]||this.byDbData.lichess}}}}function Ls(t){return["masters"===t.data.db()?js(t):"lichess"===t.data.db()?Gs(t):Bs(t),m("section.save",m("button.button.button-green.text",{attrs:E(""),hook:S("click",t.toggleOpen)},t.root.trans.noarg("allSet")))]}const Fs="Select a Lichess player",Bs=t=>{const e=t.data.playerName.value();return m("div.player-db",[t.data.playerName.open()?Js(t):void 0,m("section.name",[m("label",t.root.trans("player")),m("div",[m("div.choices",m("button.player-name"+(e?".active":""),{hook:S("click",(()=>t.data.playerName.open(!0)),t.root.redraw),attrs:e?{title:Fs}:void 0},e||Fs)),m("button.button-link.text.color",{attrs:E(""),hook:S("click",t.toggleColor,t.root.redraw)}," "+t.root.trans("white"==t.data.color()?"asWhite":"asBlack"))])]),Vs(t),Hs(t),Ks(t)])},js=t=>m("div",[m("section.date",[m("label",[t.root.trans.noarg("since"),Us(t.data.byDb().since,(()=>""),t.root.redraw)]),m("label",[t.root.trans.noarg("until"),Us(t.data.byDb().until,t.data.byDb().since,t.root.redraw)])])]),zs=(t,e,n)=>o=>m("button",{attrs:{"aria-pressed":`${e().includes(o)}`,title:n?Is(""+o):""},hook:S("click",(n=>t.toggleMany(e)(o)),t.root.redraw)},n?n(o):t.root.trans.noarg(""+o)),Gs=t=>m("div",[Vs(t),m("section.rating",[m("label",t.root.trans.noarg("averageElo")),m("div.choices",qs.map(zs(t,t.data.rating)))]),Ks(t)]),Vs=t=>m("section.speed",[m("label",t.root.trans.noarg("timeControl")),m("div.choices",Ns.map(zs(t,t.data.speed,(t=>Pe(_s.icons[t])))))]),Hs=t=>m("section.mode",[m("label",t.root.trans.noarg("mode")),m("div.choices",Ds.map(zs(t,t.data.mode)))]),Ws=(t,e,n)=>{const o=t=>t.setCustomValidity(!t.value||e()<=t.value?"":"Invalid date range"),r=(new Date).toISOString().slice(0,7);return m("input",{key:e()?"until-month":"since-month",attrs:{type:"month",title:"Insert year and month in YYYY-MM format starting from 1952-01",pattern:"^(19|20)[0-9]{2}-(0[1-9]|1[012])$",placeholder:"YYYY-MM",min:"1952-01",max:r,value:t()>r?r:t()},hook:{insert:e=>{const r=e.elm;o(r),r.addEventListener("change",(e=>{const r=e.target;r.setCustomValidity(""),r.checkValidity()&&(o(r),t(r.value),n())}))},update:(t,e)=>o(e.elm)}})},Us=(t,e,n)=>{const o=t=>t.setCustomValidity(!t.value||e().split("-")[0]<=t.value?"":"Invalid date range");return m("input",{attrs:{key:e()?"until-year":"since-year",type:"number",title:"Insert year in YYYY format starting from 1952",placeholder:"YYYY",min:Os,max:(new Date).toISOString().slice(0,4),value:t().split("-")[0]},hook:{insert:r=>{const i=r.elm;o(i),i.addEventListener("change",(r=>{const i=r.target;i.setCustomValidity(""),i.checkValidity()&&(o(i),t(i.value?`${i.value}-${e()?"12":"01"}`:""),n())}))},update:(t,e)=>o(e.elm)}})},Ks=t=>m("section.date",[m("label",[t.root.trans.noarg("since"),Ws(t.data.byDb().since,(()=>""),t.root.redraw)]),m("label",[t.root.trans.noarg("until"),Ws(t.data.byDb().until,t.data.byDb().since,t.root.redraw)])]),Js=t=>{const e=e=>{t.selectPlayer(e),t.root.redraw()};return me({class:"explorer__config__player__choice",onClose(){t.data.playerName.open(!1),t.root.redraw()},content:[m("h2","Personal opening explorer"),m("div.input-wrapper",[m("input",{attrs:{placeholder:t.root.trans.noarg("searchByUsername")},hook:x((t=>lichess.userComplete().then((n=>{n({input:t,tag:"span",onSelect:t=>e(t.name)}),t.focus()}))))})]),m("div.previous",[...t.myName?[t.myName]:[],...t.data.playerName.previous()].map((n=>m("button.button"+(n==t.myName?".button-green":""),{hook:S("click",(()=>e(n)))},n))))]})};function Ys(t,e,n){if(n.dtm)return m("result."+Ts(e,n),{attrs:{title:t.trans.plural("mateInXHalfMoves",Math.abs(n.dtm))+" (Depth To Mate)"}},"DTM "+Math.abs(n.dtm))}function Xs(t,e,n){const o=t.trans.noarg;return n.checkmate?m("result."+Ts(e,n),o("checkmate")):n.variant_win?m("result."+Ts(e,n),o("variantLoss")):n.variant_loss?m("result."+Ts(e,n),o("variantWin")):n.stalemate?m("result.draws",o("stalemate")):n.insufficient_material?m("result.draws",o("insufficientMaterial")):null===n.dtz?null:0===n.dtz?m("result.draws",o("draw")):n.zeroing?n.san.includes("x")?m("result."+Ts(e,n),o("capture")):m("result."+Ts(e,n),o("pawnMove")):m("result."+Ts(e,n),{attrs:{title:o("dtzWithRounding")+" (Distance To Zeroing)"}},"DTZ "+Math.abs(n.dtz))}function Qs(t){const e=t.white+t.draws+t.black;return m("div.bar",["white","draws","black"].map((function(n){const o=100*t[n]/e;return m("span."+n,{attrs:{style:"width: "+Math.round(1e3*t[n]/e)/10+"%"}},o>12?Math.round(o)+(o>20?"%":""):"")})))}function Zs(t,e){if(!e.uci)return"Total";if(e.game){const n=e.game,o="white"===n.winner?"1-0":"black"===n.winner?"0-1":"½-½";return t.explorer.opts.showRatings?`${n.white.name} (${n.white.rating}) ${o} ${n.black.name} (${n.black.rating})`:`${n.white.name} ${o} ${n.black.name}`}if(t.explorer.opts.showRatings){if(e.averageRating)return t.trans("averageRatingX",e.averageRating);if(e.averageOpponentRating)return`Average opponent rating: ${e.averageOpponentRating}`}return""}function ta(t){return"white"===t?m("result.white","1-0"):"black"===t?m("result.black","0-1"):m("result.draws","½-½")}function ea(t,e,n,o){if(!t.explorer.withGames||!o.length)return null;const r=t.explorer.gameMenu(),i="masters"==t.explorer.db();return m("table.games",[m("thead",[m("tr",[m("th.title",{attrs:{colspan:i?4:5}},n)])]),m("tbody",$s(t,{fen:e,onClick:(e,n)=>{const o=$(e.target).parents("tr");if(!o.length)return;const r=o.data("id");t.study&&t.study.members.canContribute()?(t.explorer.gameMenu(r),t.redraw()):na(t,r)}}),o.map((e=>r===e.id?function(t,e){function n(n){t.study.explorerGame(e.id,n),t.explorer.gameMenu(null),t.redraw()}return m("tr",{key:e.id+"-m"},[m("td.game_menu",{attrs:{colspan:"masters"==t.explorer.db()?4:5}},[m("div.game_title",`${e.white.name} - ${e.black.name}, ${ta(e.winner).text}, ${e.year}`),m("div.menu",[m("a.text",{attrs:E(""),hook:S("click",(n=>na(t,e.id)))},"View"),...t.study?[m("a.text",{attrs:E(""),hook:S("click",(t=>n(!1)),t.redraw)},"Cite"),m("a.text",{attrs:E(""),hook:S("click",(t=>n(!0)),t.redraw)},"Insert")]:[],m("a.text",{attrs:E(""),hook:S("click",(e=>t.explorer.gameMenu(null)),t.redraw)},"Close")])])])}(t,e):m("tr",{key:e.id,attrs:{"data-id":e.id,"data-uci":e.uci||""}},[t.explorer.opts.showRatings?m("td",[e.white,e.black].map((t=>m("span",""+t.rating)))):null,m("td",[e.white,e.black].map((t=>m("span",t.name)))),m("td",ta(e.winner)),m("td",e.month||e.year),i?void 0:m("td",e.speed&&m("i",{attrs:{title:Is(e.speed),...E(_s.icons[e.speed])}}))]))))])}function na(t,e){let n="/"+e+"/"+t.chessground.state.orientation+(t.node.ply>0?"?fen="+t.node.fen:"");"masters"===t.explorer.db()&&(n="/import/master"+n),window.open(n,"_blank","noopener")}function oa(t){return m("button.button.button-empty.text",{attrs:E(""),hook:S("click",t.toggleExplorer,t.redraw)},t.trans.noarg("close"))}function ra(t,e){return m("div.data.empty",[da(t.explorer),sa(t,e),m("div.message",[m("strong",t.trans.noarg("noGameFound")),t.explorer.config.fullHouse()?null:m("p.explanation",t.trans.noarg("maybeIncludeMoreGamesFromThePreferencesMenu"))])])}function ia(t,e){return m("div.data.empty",[m("div.title",t.trans.noarg("gameOver")),m("div.message",[m("i",{attrs:E("")}),m("h3",t.trans.noarg(e)),oa(t)])])}const sa=(t,e)=>{const n=null==e?void 0:e.opening;return m("div.title",{attrs:n?{title:n&&`${n.eco} ${n.name}`}:{}},n?[m("strong",n.eco)," ",n.name]:[ua(t,t.data.game.variant)])};let aa;const ca=()=>{aa=void 0};function la(t){const e=t.trans.noarg,n=t.explorer.current();if(n&&n.isOpening){const o=function(t,e){if(!e.moves.length)return null;const n=t.trans.noarg,o=e.moves.length>1&&[e.white,e.black,e.draws].every(I)?[...e.moves,{...e,uci:"",san:"Σ"}]:e.moves;return m("table.moves",[m("thead",[m("tr",[m("th",n("move")),m("th",n("games")),m("th",n("whiteDrawBlack"))])]),m("tbody",$s(t,{fen:e.fen,onClick:(e,n)=>n&&t.explorerMove(n)}),o.map((e=>m("tr"+(e.uci?"":".sum"),{key:e.uci,attrs:{"data-uci":e.uci,title:Zs(t,e)}},[m("td","P"===e.san[0]?e.san.slice(1):e.san),m("td",Q(e.white+e.draws+e.black)),m("td",Qs(e))]))))])}(t,n),r=ea(t,n.fen,e("recentGames"),n.recentGames||[]),i=ea(t,n.fen,e("topGames"),n.topGames||[]);aa=o||r||i?m("div.data",[da(t.explorer),(null==n?void 0:n.opening)&&sa(t,n),o,i,r]):ra(t,n)}else if(n&&function(t){return!!t.tablebase}(n)){const o=(o,r,i)=>function(t,e,n,o,r){return r.length?[m("div.title",o?{attrs:{title:o}}:{},n),m("table.tablebase",[m("tbody",$s(t,{fen:e,onClick:(e,n)=>n&&t.explorerMove(n)}),r.map((n=>m("tr",{key:n.uci,attrs:{"data-uci":n.uci}},[m("td",n.san),m("td",[Xs(t,e,n),Ys(t,e,n)])]))))])]:[]}(t,n.fen,e(r),i&&e(i),n.moves.filter((t=>t.category==o)));aa=n.moves.length?m("div.data",[...o("loss","winning"),...o("unknown","unknown"),...o("maybe-loss","winOr50MovesByPriorMistake","unknownDueToRounding"),...o("blessed-loss","winPreventedBy50MoveRule"),...o("draw","drawn"),...o("cursed-win","lossSavedBy50MoveRule"),...o("maybe-win","lossOr50MovesByPriorMistake","unknownDueToRounding"),...o("win","losing")]):n.checkmate?ia(t,"checkmate"):n.stalemate?ia(t,"stalemate"):n.variant_win||n.variant_loss?ia(t,"variantEnding"):ra(t)}return aa}const da=t=>{const e=t.db(),n=(e,n)=>m("button.button-link",{key:e,attrs:{title:n},hook:S("click",(()=>t.config.data.db(e.toLowerCase())),t.reload)},e),o=(n,o)=>m("span.active.text."+e,{attrs:{title:o,...E("")},hook:"player"==e?S("click",t.config.toggleColor,t.reload):void 0},n),r=t.config.data.playerName.value(),i=t.root.trans("masterDbExplanation",2200,"1952","2021-11"),s=t.root.trans("lichessDbExplanation");return m("div.explorer-title",["masters"==e?o([m("strong","Masters")," database"],i):t.config.allDbs.includes("masters")?n("Masters",i):void 0,"lichess"==e?o([m("strong","Lichess")," database"],s):n("Lichess",s),"player"==e?r?o([m("strong"+(r.length>14?".long":""),r)," "+t.root.trans("white"==t.config.data.color()?"asWhite":"asBlack"),t.isIndexing()&&!t.config.data.open()?m("i.ddloader",{attrs:{title:"Indexing..."}}):void 0],t.root.trans("switchSides")):o([m("strong","Player")," database"],""):m("button.button-link.player",{key:"player",hook:S("click",(()=>{t.config.selectPlayer(r||"me"),"player"!=t.db()&&(t.config.data.db("player"),t.config.data.open(!0))}),t.reload)},t.root.trans("player"))])};function ua(t,e){return"standard"===e.key||"fromPosition"===e.key?t.trans.noarg("openingExplorer"):t.trans("xOpeningExplorer",e.name)}let ha="";function pa(t){const e=t.explorer;if(!e.enabled())return;const n=e.current(),o=e.config.data.open(),r=!o&&(e.loading()||!n&&!e.failing()),i=o?function(t){return m("div.config",[da(t.explorer),...Ls(t.explorer.config)])}(t):e.failing()?function(t){var e;return m("div.data.empty",[m("div.title",ua(t,t.data.game.variant)),m("div.failing.message",[m("h3","Oops, sorry!"),m("p.explanation",null===(e=t.explorer.failing())||void 0===e?void 0:e.toString()),oa(t)])])}(t):la(t);return m("section.explorer-box.sub-box"+(o?".explorer__config":""),{class:{loading:r,reduced:!o&&(!!e.failing()||e.movesAway()>2)},hook:{insert:t=>t.elm.scrollTop=0,postpatch(t,e){n&&ha!==n.fen&&(e.elm.scrollTop=0,ha=n.fen)}}},[m("div.overlay"),i,m("button.fbt.toconf",{attrs:{"aria-label":o?"Close configuration":"Open configuration",...E(o?"":"")},hook:S("click",(()=>t.explorer.config.toggleOpen()),t.redraw)})])}function ma(t){return t.split(/\s/)[0].split(/[nbrqkp]/i).length-1}function fa(t){switch(t){case"standard":case"fromPosition":case"chess960":return 7;case"atomic":case"antichess":return 6;default:return 0}}const ga=(t,e)=>ma(e)<=fa(t);class va{constructor(t,e,n){this.root=t,this.opts=e,this.loading=q(!0),this.failing=q(null),this.hovering=q(null),this.movesAway=q(0),this.gameMenu=q(null),this.lastStream=q(null),this.cache={},this.checkHash=t=>{var e;const n=location.hash.split("/");"#explorer"!=n[0]&&"#opening"!=n[0]||this.root.embed||(this.enabled(!0),"lichess"==n[1]||"masters"===n[1]?this.config.data.db(n[1]):(null===(e=n[1])||void 0===e?void 0:e.match(/[A-Za-z0-9_-]{2,30}/))&&(this.config.selectPlayer(n[1]),this.config.data.color("black"==n[2]?"black":"white")),t&&this.root.redraw())},this.reload=()=>{this.cache={},this.setNode(),this.root.redraw()},this.destroy=ca,this.baseXhrOpening=()=>({endpoint:this.opts.endpoint,config:this.config.data}),this.fetch=U((()=>{const t=this.root.node.fen,e=e=>{this.cache[t]=e,this.movesAway(e.moves.length?0:this.movesAway()+1),this.loading(!1),this.failing(null),this.root.redraw()},n=t=>{this.loading(!1),this.failing(t),this.root.redraw()},o=this.lastStream();o&&o.promise.then((t=>t.cancel())),this.withGames&&this.tablebaseRelevant(this.effectiveVariant,t)?Es(this.opts.tablebaseEndpoint,this.effectiveVariant,t).then(e,n):this.lastStream(Qn(Ms({...this.baseXhrOpening(),db:this.db(),variant:this.effectiveVariant,rootFen:this.root.nodeList[0].fen,play:this.root.nodeList.slice(1).map((t=>t.uci)),fen:t,withGames:this.withGames},e).then((t=>(t.end.promise.then((t=>!0!==t?n(t):this.root.redraw())),t)))))}),250,!0),this.empty={isOpening:!0,moves:[],fen:"",opening:this.root.data.game.opening},this.tablebaseRelevant=(t,e)=>ma(e)-1<=fa(t)&&this.root.ceval.possible,this.setNode=()=>{if(!this.enabled())return;this.gameMenu(null);const t=this.root.node;t.ply>=50&&!this.tablebaseRelevant(this.effectiveVariant,t.fen)&&(this.cache[t.fen]=this.empty);const e=this.cache[t.fen];e?(this.movesAway(e.moves.length?0:this.movesAway()+1),this.loading(!1),this.failing(null)):(this.loading(!0),this.fetch())},this.db=()=>this.config.data.db(),this.current=()=>this.cache[this.root.node.fen],this.toggle=()=>{this.movesAway(0),this.enabled(!this.enabled()),this.setNode(),this.root.autoScroll()},this.disable=()=>{this.enabled()&&(this.enabled(!1),this.gameMenu(null),this.root.autoScroll())},this.setHovering=(t,e)=>{this.hovering(e?{fen:t,uci:e}:null),this.root.setAutoShapes()},this.onFlip=()=>{"player"==this.db()&&(this.cache={},this.setNode())},this.isIndexing=()=>{const t=this.lastStream();return!(!t||t.sync&&t.sync.end.sync)},this.fetchMasterOpening=(()=>{const t={};return e=>{const n=t[e];return n?Promise.resolve(n):new Promise((n=>Ms({...this.baseXhrOpening(),db:"masters",rootFen:e,play:[],fen:e},(o=>{t[e]=o,n(o)}))))}})(),this.fetchTablebaseHit=async t=>{const e=await Es(this.opts.tablebaseEndpoint,this.effectiveVariant,t),n=e.moves[0];if(n&&null==n.dtz)throw"unknown tablebase position";return{fen:t,best:n&&n.uci,winner:e.checkmate?Fr(As(t)):e.stalemate?void 0:Ts(t,n)}},this.allowed=q(n),this.enabled=t.embed?q(!1):xn("explorer.enabled",!1),this.withGames=t.synthetic||Lt(t.data)||!!t.data.opponent.ai,this.effectiveVariant="fromPosition"===t.data.game.variant.key?"standard":t.data.game.variant.key,this.config=new Rs(t,this.effectiveVariant,this.reload),window.addEventListener("hashchange",this.checkHash,!1),this.checkHash()}}function ba(t,e){const n=t.data.game.variant.key,o=q(!0),r=q(null),i=q(null),s=q(null),a=q(!1);function c(e,n=0){if(e.tbhit||t.outcome(e))return!0;const o=e.ceval;return!!o&&(o.depth+n>=15||o.depth>=13&&!o.cloud&&o.millis>3e3)}function l(t){return t&&(t.winner?{mate:"white"===t.winner?10:-10}:{cp:0})}function d(t){return t.tbhit&&t.tbhit.best||t.ceval&&t.ceval.pvs[0].moves[0]}function u(e,n,o){let r,i;const s=t.outcome(n);if(s&&s.winner)r="goodMove";else{const o=l(n.tbhit)||(n.threefold||s&&!s.winner?{cp:0}:n.ceval),a=l(e.tbhit)||e.ceval,c=-co(t.bottomColor(),o,a);i=d(e),(i===n.uci||n.san.startsWith("O-O")&&i===Nt[n.uci])&&(i=void 0),r=i?c<.025?"goodMove":c<.06?"inaccuracy":c<.14?"mistake":"blunder":"goodMove"}return{prev:e,node:n,path:o,verdict:r,best:i?{uci:i,san:t.position(e).unwrap((t=>function(t,e){return tr(t.clone(),e)}(t,dn(i))),(t=>"--"))}:void 0}}function h(){return t.turnColor()===t.bottomColor()}function p(){const i=t.node;if(!o())return r(null),t.redraw();if(!ga(n,i.fen)||I(i.tbhit))if(t.showComputer()||t.toggleComputer(),t.ceval.enabled()||t.toggleCeval(),t.threatMode()&&t.toggleThreatMode(),h()){const e=s();e&&(e.uci=d(i)||e.uci,t.setAutoShapes())}else{if(r(null),i.san&&c(i)){const e=t.tree.parentNode(t.path);if(c(e,1))r(u(e,i,t.path));else{const e=t.tree.parentNode(zt(t.path));c(e,1)&&r(u(e,i,t.path))}}!a()&&function(t){const n=t.ceval;return!!n&&(n.depth>=Math.min(n.maxDepth||99,e())||n.depth>=15&&(n.cloud||n.millis>5e3))}(i)?(t.playUci(d(i)),a(!0)):t.redraw()}}function m(){ga(n,t.node.fen)?t.explorer.fetchTablebaseHit(t.node.fen).then((e=>{e&&t.node.fen===e.fen&&(t.node.tbhit=e),p()}),(()=>{I(t.node.tbhit)||(t.node.tbhit=null),p()})):p()}function f(){o(!0),m()}return lichess.requestIdleCallback(m,800),{onCeval:p,onJump(){a(!1),s(null),function(t,e){if(I(e.threefold))return;const n=Ss(e.fen);let o,r=0;for(o in t)Ss(t[o].fen)===n&&r++;e.threefold=r>2}(t.nodeList,t.node),m()},isMyTurn:h,comment:r,running:o,hovering:i,hinting:s,resume:f,playableDepth:e,reset(){r(null),s(null)},preUserJump(t,e){t!==e&&(o(!1),r(null))},postUserJump(t,e){t!==e&&h()&&f()},onUserMove(){o(!0)},playCommentBest(){const e=r();e&&(t.jump(zt(e.path)),e.best&&t.playUci(e.best.uci))},commentShape(e){const n=r();e&&n&&n.best?i({uci:n.best.uci}):i(null),t.setAutoShapes()},hint(){const e=t.node.ceval?t.node.ceval.pvs[0].moves[0]:null,n=s();!e||n&&"move"===n.mode?s(null):s({mode:n?"move":"piece",uci:e}),t.setAutoShapes()},currentNode:()=>t.node,bottomColor:t.bottomColor,redraw:t.redraw}}function ya(t,e){const n=t.data.game;let o=[];const r=[];let i=[];const s=q(null),a=q("find"),c=t.redraw;function l(t){return i.includes(t)}function d(){const n="white"==e?1:0;return o=function(t,e){const n=[];for(let o=1;o<t.length;o++){const r=t[o],i=t[o-1];if(e(r)&&r.eval&&i.eval){const t=Math.abs(co("white",i.eval,r.eval));xs(i)&&(t>.1||i.eval.mate&&!r.eval.mate&&Math.abs(i.eval.mate)<=3)&&n.push(r)}}return n}(t.mainline,(t=>t.ply%2===n&&!r.includes(t.ply))),o.find((t=>!l(t.ply)))}function u(){a("find");const e=d();if(!e)return s(null),c();const o={node:e,path:t.mainlinePathToPly(e.ply)},i=zt(o.path),l={node:t.tree.nodeAtPath(i),path:i},h=l.node.children.find((t=>!!t.comp));s({fault:o,prev:l,solution:{node:h,path:i+h.id},openingUcis:[]}),"standard"===n.variant.key&&n.division&&(!n.division.middle||o.node.ply<n.division.middle)&&t.explorer.fetchMasterOpening(l.node.fen).then((t=>{const e=s(),n=[];t.moves.forEach((t=>{t.white+t.draws+t.black>1&&n.push(t.uci)})),n.includes(o.node.uci)?(r.push(o.node.ply),setTimeout(u,100)):(e.openingUcis=n,s(e))})),t.userJump(l.path),c()}function h(){const n=t.node,o=s();if(o&&"eval"===a()&&o.fault.node.ply===n.ply&&function(t){var e;return!!t.ceval&&(t.ceval.depth>=18||t.ceval.depth>=14&&(null!==(e=t.ceval.millis)&&void 0!==e?e:0)>7e3)}(n)){co(e,n.ceval,o.prev.node.eval)>-.035?p():m()}}function p(){f(),a("win"),c()}function m(){a("fail");const e={node:t.node,path:t.path};t.userJump(s().prev.path),!t.tree.pathIsMainline(e.path)&&N(e.node.children)&&t.tree.deleteNodeAt(e.path),c()}function f(){i.push(s().fault.node.ply)}function g(){const t=a();return"find"===t||"fail"===t}return u(),{current:s,color:e,isPlySolved:l,onJump:function(){const e=t.node,n=a(),o=s();if(o){if("eval"===n&&o.fault.node.ply!==e.ply)return a("find"),void t.setAutoShapes();g()&&o.fault.node.ply===e.ply&&(o.openingUcis.includes(e.uci)||e.comp?p():e.eval?m():(a("eval"),t.ceval.enabled()||t.toggleCeval(),h())),t.setAutoShapes()}},jumpToNext:u,skip:function(){f(),u()},viewSolution:function(){a("view"),t.userJump(s().solution.path),f()},hideComputerLine:function(t){return t.ply%2==0!=("white"===e)&&!l(t.ply)},showBadNode:function(){const e=s();if(e&&g()&&e.prev.path===t.path)return e.fault.node},onCeval:h,onMergeAnalysisData:function(){g()&&!s()&&u()},feedback:a,isSolving:g,completion:()=>[i.length,o.length],reset(){i=[],u()},flip(){"racingKings"!==t.data.game.variant.key?t.flip():(t.retro=ya(t,Fr(e)),c())},close:t.toggleRetro,trans:t.trans,noarg:t.trans.noarg,node:()=>t.node,redraw:c}}const wa="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ka={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Ca={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function xa(t){"start"===t&&(t=wa);const e=new Map;let n=7,o=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--n,n<0)return e;o=0;break;case"~":{const t=e.get(qr([o-1,n]));t&&(t.promoted=!0);break}default:{const t=r.charCodeAt(0);if(t<57)o+=t-48;else{const t=r.toLowerCase();e.set(qr([o,n]),{role:ka[t],color:r===t?"black":"white"}),++o}}}return e}function Sa(t,e){return Math.abs(t-e)}const Ma=(t,e,n,o)=>{const r=Sa(t,n),i=Sa(e,o);return 1===r&&2===i||2===r&&1===i},Pa=(t,e,n,o)=>Sa(t,n)===Sa(e,o),Ea=(t,e,n,o)=>t===n||e===o,Aa=(t,e,n,o)=>Pa(t,e,n,o)||Ea(t,e,n,o);function Ta(t,e,n){const o=t.get(e);if(!o)return[];const r=Or(e),i=o.role,s="pawn"===i?(a=o.color,(t,e,n,o)=>Sa(t,n)<2&&("white"===a?o===e+1||e<=1&&o===e+2&&t===n:o===e-1||e>=6&&o===e-2&&t===n)):"knight"===i?Ma:"bishop"===i?Pa:"rook"===i?Ea:"queen"===i?Aa:function(t,e,n){return(o,r,i,s)=>Sa(o,i)<2&&Sa(r,s)<2||n&&r===s&&r===("white"===t?0:7)&&(4===o&&(2===i&&e.includes(0)||6===i&&e.includes(7))||e.includes(i))}(o.color,function(t,e){const n="white"===e?"1":"8",o=[];for(const[r,i]of t)r[1]===n&&i.color===e&&"rook"===i.role&&o.push(Or(r)[0]);return o}(t,o.color),n);var a;return Rr.filter((t=>(r[0]!==t[0]||r[1]!==t[1])&&s(r[0],r[1],t[0],t[1]))).map(qr)}function Ia(t,...e){t&&setTimeout((()=>t(...e)),1)}function $a(t){t.premovable.current&&(t.premovable.current=void 0,Ia(t.premovable.events.unset))}function _a(t){const e=t.predroppable;e.current&&(e.current=void 0,Ia(e.events.unset))}function Na(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!o)return!1;const i=r&&r.color!==o.color?r:void 0;return n===t.selected&&Ba(t),Ia(t.events.move,e,n,i),function(t,e,n){if(!t.autoCastle)return!1;const o=t.pieces.get(e);if(!o||"king"!==o.role)return!1;const r=Or(e),i=Or(n);if(0!==r[1]&&7!==r[1]||r[1]!==i[1])return!1;4!==r[0]||t.pieces.has(n)||(6===i[0]?n=qr([7,i[1]]):2===i[0]&&(n=qr([0,i[1]])));const s=t.pieces.get(n);return!(!s||s.color!==o.color||"rook"!==s.role||(t.pieces.delete(e),t.pieces.delete(n),r[0]<i[0]?(t.pieces.set(qr([6,i[1]]),o),t.pieces.set(qr([5,i[1]]),s)):(t.pieces.set(qr([2,i[1]]),o),t.pieces.set(qr([3,i[1]]),s)),0))}(t,e,n)||(t.pieces.set(n,o),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,Ia(t.events.change),i||!0}function Da(t,e,n,o){if(t.pieces.has(n)){if(!o)return!1;t.pieces.delete(n)}return Ia(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,Ia(t.events.change),t.movable.dests=void 0,t.turnColor=Fr(t.turnColor),!0}function qa(t,e,n){const o=Na(t,e,n);return o&&(t.movable.dests=void 0,t.turnColor=Fr(t.turnColor),t.animation.current=void 0),o}function Oa(t,e,n){if(za(t,e,n)){const o=qa(t,e,n);if(o){const r=t.hold.stop();Ba(t);const i={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return!0!==o&&(i.captured=o),Ia(t.movable.events.after,e,n,i),!0}}else if(function(t,e,n){return e!==n&&Ga(t,e)&&Ta(t.pieces,e,t.premovable.castle).includes(n)}(t,e,n))return function(t,e,n,o){_a(t),t.premovable.current=[e,n],Ia(t.premovable.events.set,e,n,o)}(t,e,n,{ctrlKey:t.stats.ctrlKey}),Ba(t),!0;return Ba(t),!1}function Ra(t,e,n,o){const r=t.pieces.get(e);r&&(function(t,e,n){const o=t.pieces.get(e);return!(!o||e!==n&&t.pieces.has(n)||"both"!==t.movable.color&&(t.movable.color!==o.color||t.turnColor!==o.color))}(t,e,n)||o)?(t.pieces.delete(e),Da(t,r,n,o),Ia(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);return!!o&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&t.movable.color===o.color&&t.turnColor!==o.color}(t,e,n)?function(t,e,n){$a(t),t.predroppable.current={role:e,key:n},Ia(t.predroppable.events.set,e,n)}(t,r.role,n):($a(t),_a(t)),t.pieces.delete(e),Ba(t)}function La(t,e,n){if(Ia(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled)return Ba(t),void t.hold.cancel();if((t.selectable.enabled||n)&&t.selected!==e&&Oa(t,t.selected,e))return void(t.stats.dragged=!1)}(ja(t,e)||Ga(t,e))&&(Fa(t,e),t.hold.start())}function Fa(t,e){t.selected=e,Ga(t,e)?t.premovable.dests=Ta(t.pieces,e,t.premovable.castle):t.premovable.dests=void 0}function Ba(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function ja(t,e){const n=t.pieces.get(e);return!!n&&("both"===t.movable.color||t.movable.color===n.color&&t.turnColor===n.color)}function za(t,e,n){var o,r;return e!==n&&ja(t,e)&&(t.movable.free||!!(null===(r=null===(o=t.movable.dests)||void 0===o?void 0:o.get(e))||void 0===r?void 0:r.includes(n)))}function Ga(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function Va(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],o=e[1];let r=!1;if(za(t,n,o)){const e=qa(t,n,o);if(e){const i={premove:!0};!0!==e&&(i.captured=e),Ia(t.movable.events.after,n,o,i),r=!0}}return $a(t),r}function Ha(t){$a(t),_a(t),Ba(t)}function Wa(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Ha(t)}function Ua(t,e,n){let o=Math.floor(8*(t[0]-n.left)/n.width);e||(o=7-o);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),o>=0&&o<8&&r>=0&&r<8?qr([o,r]):void 0}function Ka(t){return"white"===t.orientation}const Ja=["green","red","blue","yellow"];function Ya(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?Ba(t):Ha(t);const n=Wr(e),o=Ua(n,Ka(t),t.dom.bounds());o&&(t.drawable.current={orig:o,pos:n,brush:ec(e),snapToValidMove:t.drawable.defaultSnapToValidMove},Xa(t))}function Xa(t){requestAnimationFrame((()=>{const e=t.drawable.current;if(e){const n=Ua(e.pos,Ka(t),t.dom.bounds());n||(e.snapToValidMove=!1);const o=e.snapToValidMove?function(t,e,n,o){const r=Or(t),i=Rr.filter((t=>Aa(r[0],r[1],t[0],t[1])||Ma(r[0],r[1],t[0],t[1]))),s=i.map((t=>Jr(qr(t),n,o))).map((t=>Br(e,t))),[,a]=s.reduce(((t,e,n)=>t[0]<e?t:[e,n]),[s[0],0]);return qr(i[a])}(e.orig,e.pos,Ka(t),t.dom.bounds()):n;o!==e.mouseSq&&(e.mouseSq=o,e.dest=o!==e.orig?o:void 0,t.dom.redrawNow()),Xa(t)}}))}function Qa(t,e){t.drawable.current&&(t.drawable.current.pos=Wr(e))}function Za(t){const e=t.drawable.current;e&&(e.mouseSq&&function(t,e){const n=t=>t.orig===e.orig&&t.dest===e.dest,o=t.shapes.find(n);o&&(t.shapes=t.shapes.filter((t=>!n(t))));o&&o.brush===e.brush||t.shapes.push(e);nc(t)}(t.drawable,e),tc(t))}function tc(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function ec(t){var e;const n=(t.shiftKey||t.ctrlKey)&&Ur(t),o=t.altKey||t.metaKey||(null===(e=t.getModifierState)||void 0===e?void 0:e.call(t,"AltGraph"));return Ja[(n?1:0)+(o?2:0)]}function nc(t){t.onChange&&t.onChange(t.shapes)}function oc(t,e){return e.animation.enabled?function(t,e){const n=new Map(e.pieces),o=t(e),r=function(t,e){const n=new Map,o=[],r=new Map,i=[],s=[],a=new Map;let c,l,d;for(const[u,h]of t)a.set(u,ic(u,h));for(const u of Dr)c=e.pieces.get(u),l=a.get(u),c?l?jr(c,l.piece)||(i.push(l),s.push(ic(u,c))):s.push(ic(u,c)):l&&i.push(l);for(const u of s)l=sc(u,i.filter((t=>jr(u.piece,t.piece)))),l&&(d=[l.pos[0]-u.pos[0],l.pos[1]-u.pos[1]],n.set(u.key,d.concat(d)),o.push(l.key));for(const u of i)o.includes(u.key)||r.set(u.key,u.piece);return{anims:n,fadings:r}}(n,e);if(r.anims.size||r.fadings.size){const t=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},t||ac(e,performance.now())}else e.dom.redraw();return o}(t,e):rc(t,e)}function rc(t,e){const n=t(e);return e.dom.redraw(),n}function ic(t,e){return{key:t,pos:Or(t),piece:e}}function sc(t,e){return e.sort(((e,n)=>Br(t.pos,e.pos)-Br(t.pos,n.pos)))[0]}function ac(t,e){const n=t.animation.current;if(void 0===n)return void(t.dom.destroyed||t.dom.redrawNow());const o=1-(e-n.start)*n.frequency;if(o<=0)t.animation.current=void 0,t.dom.redrawNow();else{const e=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}(o);for(const t of n.plan.anims.values())t[2]=t[0]*e,t[3]=t[1]*e;t.dom.redrawNow(!0),requestAnimationFrame(((e=performance.now())=>ac(t,e)))}}function cc(t,e){if(!e.isTrusted||void 0!==e.button&&0!==e.button)return;if(e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),o=Wr(e),r=Ua(o,Ka(t),n);if(!r)return;const i=t.pieces.get(r),s=t.selected;var a;s||!t.drawable.enabled||!t.drawable.eraseOnClick&&i&&i.color===t.turnColor||(a=t).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),nc(a.drawable)),!1!==e.cancelable&&(!e.touches||t.blockTouchScroll||i||s||function(t,e){const n=Ka(t),o=t.dom.bounds(),r=Math.pow(o.width/8,2);for(const i of t.pieces.keys()){const t=Jr(i,n,o);if(Br(t,e)<=r)return!0}return!1}(t,o))&&e.preventDefault();const c=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&za(t,t.selected,r)?oc((t=>La(t,r)),t):La(t,r);const d=t.selected===r,u=fc(t,r);if(i&&u&&d&&function(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&("both"===t.movable.color||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}(t,r)){t.draggable.current={orig:r,piece:i,origPos:o,pos:o,started:t.draggable.autoDistance&&t.stats.dragged,element:u,previouslySelected:s,originTarget:e.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const a=t.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,Gr(a,zr(n)(Or(r),Ka(t))),Hr(a,!0)),dc(t)}else c&&$a(t),l&&_a(t);t.dom.redraw()}function lc(t,e,n,o){const r="a0";t.pieces.set(r,e),t.dom.redraw();const i=Wr(n);t.draggable.current={orig:r,piece:e,origPos:i,pos:i,started:!0,element:()=>fc(t,r),originTarget:n.target,newPiece:!0,force:!!o,keyHasChanged:!1},dc(t)}function dc(t){requestAnimationFrame((()=>{var e;const n=t.draggable.current;if(!n)return;(null===(e=t.animation.current)||void 0===e?void 0:e.plan.anims.has(n.orig))&&(t.animation.current=void 0);const o=t.pieces.get(n.orig);if(o&&jr(o,n.piece)){if(!n.started&&Br(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const t=n.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),n.element=t}const e=t.dom.bounds();Gr(n.element,[n.pos[0]-e.left-e.width/16,n.pos[1]-e.top-e.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==Ua(n.pos,Ka(t),e))}}else pc(t);dc(t)}))}function uc(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=Wr(e))}function hc(t,e){const n=t.draggable.current;if(!n)return;if("touchend"===e.type&&!1!==e.cancelable&&e.preventDefault(),"touchend"===e.type&&n.originTarget!==e.target&&!n.newPiece)return void(t.draggable.current=void 0);$a(t),_a(t);const o=Ua(Wr(e)||n.pos,Ka(t),t.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?Ra(t,n.orig,o,n.force):(t.stats.ctrlKey=e.ctrlKey,Oa(t,n.orig,o)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!o&&(t.pieces.delete(n.orig),Ia(t.events.change)),(n.orig!==n.previouslySelected&&!n.keyHasChanged||n.orig!==o&&o)&&t.selectable.enabled||Ba(t),mc(t),t.draggable.current=void 0,t.dom.redraw()}function pc(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,Ba(t),mc(t),t.dom.redraw())}function mc(t){const e=t.dom.elements;e.ghost&&Hr(e.ghost,!1)}function fc(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&"PIECE"===n.tagName)return n;n=n.nextSibling}}const gc=["queen","knight","rook","bishop"];class vc{constructor(t,e,n,o=1){this.withGround=t,this.onCancel=e,this.redraw=n,this.autoQueenPref=o,this.start=(t,e,n,o,r=!1)=>this.withGround((i=>{const s=i.state.pieces.get(t),a=s||i.state.pieces.get(e);return"pawn"==(null==a?void 0:a.role)&&("8"==e[1]&&"black"==i.state.turnColor||"1"==e[1]&&"white"==i.state.turnColor)&&(this.prePromotionRole&&(null==o?void 0:o.premove)?(this.doPromote({orig:t,dest:e,callback:n},this.prePromotionRole),!0):(null==o?void 0:o.ctrlKey)||this.promoting||!(3===this.autoQueenPref||2===this.autoQueenPref&&s||r)?(this.promoting={orig:t,dest:e,pre:!!s,callback:n},this.redraw(),!0):(s?this.setPrePromotion(e,"queen"):this.doPromote({orig:t,dest:e,callback:n},"queen"),!0))}))||!1,this.cancel=()=>{this.cancelPrePromotion(),this.promoting&&(this.promoting=void 0,this.onCancel(),this.redraw())},this.cancelPrePromotion=()=>{this.prePromotionRole&&(this.withGround((t=>t.setAutoShapes([]))),this.prePromotionRole=void 0,this.redraw())},this.view=t=>{const e=this.promoting;if(e)return this.withGround((n=>this.renderPromotion(e.dest,t?gc.concat("king"):gc,Fr(n.state.turnColor),n.state.orientation)))||null}}finish(t){const e=this.promoting;e&&(this.promoting=void 0,e.pre?this.setPrePromotion(e.dest,t):this.doPromote(e,t),this.redraw())}doPromote(t,e){this.withGround((n=>function(t,e,n){const o=t.state.pieces.get(e);o&&"pawn"==o.role&&t.setPieces(new Map([[e,{color:o.color,role:n,promoted:!0}]]))}(n,t.dest,e))),t.callback(t.orig,t.dest,e)}setPrePromotion(t,e){this.prePromotionRole=e,this.withGround((n=>n.setAutoShapes([{orig:t,piece:{color:Fr(n.state.turnColor),role:e,opacity:.8},brush:""}])))}renderPromotion(t,e,n,o){let r=12.5*(7-Or(t)[0]);"white"===o&&(r=87.5-r);return m("div#promotion-choice."+(n===o?"top":"bottom"),{hook:x((t=>{t.addEventListener("click",this.cancel),t.oncontextmenu=()=>!1}))},e.map(((t,e)=>m("square",{attrs:{style:"top: "+12.5*(n===o?e:7-e)+"%;left: "+r+"%"},hook:S("click",(e=>{e.stopPropagation(),this.finish(t)}))},[m("piece."+t+"."+n)]))))}}function bc(){const t=new Map,e=t=>{$(".analyse__wiki").html(t).toggleClass("empty",!t),lichess.pubsub.emit("chat.resize")},n="https://en.wikibooks.org",o=(t,e)=>(t=>t.replace(/<p>(<br \/>|\s)*<\/p>/g,""))((t=>t.replace('<h2><span id="Theory_table">Theory table</span></h2>',""))((t=>t.replace(/For explanation of theory tables see theory table and for notation see algebraic notation.?/,""))((t=>t.replace("When contributing to this Wikibook, please follow the Conventions for organization.",""))(t))))+(t=>`<p><a target="_blank" href="${n}/wiki/${t}">Read more on WikiBooks</a></p>`)(e);return U((async r=>{var i;const s=r.slice(1).map((t=>`${(t=>`${Math.floor((t.ply+1)/2)}${t.ply%2==1?"._":"..."}`)(t)}${t.san}`)),a=null!==(i=s.join("/").replace(/[+!#?]/g,""))&&void 0!==i?i:"";if(s.length>30||!a||a.length>234)e("");else if(t.has(a))e(t.get(a));else if(Array.from({length:s.length},((t,e)=>-e-1)).map((t=>s.slice(0,t).join("/"))).some((e=>t.has(e)&&!t.get(e).length)))e("");else{const r=`Chess_Opening_Theory/${a}`;try{const i=await fetch(`${n}/w/api.php?titles=${r}&redirects&origin=*&action=query&prop=extracts&formatversion=2&format=json&exchars=1200`),s=n=>{t.set(a,n),e(n)};if(i.ok){const t=(await i.json()).query.pages[0];t.missing?s(""):t.invalid?e("invalid request: "+t.invalidreason):t.extract?s(o(t.extract,r)):e("error: unexpected API response:<br><pre>"+JSON.stringify(t)+"</pre>")}else s("")}catch(c){e("error: "+c)}}}),500,!0)}class yc{constructor(t,e){this.opts=t,this.redraw=e,this.autoScrollRequested=!1,this.redirecting=!1,this.onMainline=!0,this.flipped=!1,this.showComments=!0,this.showAutoShapes=xn("show-auto-shapes",!0),this.showGauge=xn("show-gauge",!0),this.showComputer=xn("show-computer",!0),this.showMoveAnnotation=xn("show-move-annotation",!0),this.keyboardHelp="#keyboard"===location.hash,this.threatMode=q(!1),this.cgVersion={js:1,dom:1},this.pvUciQueue=[],this.enableWiki=t=>{this.wiki=t?bc():void 0,this.wiki&&this.wiki(this.nodeList)},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=Yt(this.nodeList),this.mainline=ne(this.tree.root),this.onMainline=this.tree.pathIsMainline(t),this.fenInput=void 0,this.pgnInput=void 0,this.wiki&&this.wiki(this.nodeList)},this.flip=()=>{this.flipped=!this.flipped,this.chessground.set({orientation:this.bottomColor()}),this.retro&&"racingKings"!==this.data.game.variant.key&&(this.retro=ya(this,this.bottomColor())),this.practice&&this.restartPractice(),this.explorer.onFlip(),this.redraw()},this.bottomIsWhite=()=>"white"===this.bottomColor(),this.getDests=Ne(800,(()=>{this.embed||I(this.node.dests)||this.socket.sendAnaDests({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path})})),this.throttleSound=t=>Ne(100,(()=>lichess.sound.play(t))),this.sound={move:this.throttleSound("move"),capture:this.throttleSound("capture"),check:this.throttleSound("check")},this.onChange=Ne(300,(()=>{lichess.pubsub.emit("analysis.change",this.node.fen,this.path,!!this.onMainline&&this.node.ply)})),this.updateHref=U((()=>{this.opts.study||window.history.replaceState(null,"","#"+this.node.ply)}),750),this.playedLastMoveMyself=()=>!!this.justPlayed&&!!this.node.uci&&this.node.uci.startsWith(this.justPlayed),this.userJump=t=>{if(this.autoplay.stop(),this.gamebookPlay()||this.withCg((t=>t.selectSquare(null))),this.practice){const e=this.path;this.practice.preUserJump(e,t),this.jump(t),this.practice.postUserJump(e,this.path)}else this.jump(t)},this.jumpToMain=t=>{this.userJump(this.mainlinePathToPly(t))},this.jumpToIndex=t=>{this.jumpToMain(t+1+this.tree.root.ply)},this.userNewPiece=(t,e)=>{if(function(t,e,n,o){if(n.color!==t.state.movable.color)return!1;if("pawn"===n.role&&("1"===o[1]||"8"===o[1]))return!1;const r=_t(e);return null===r||r.includes(o)}(this.chessground,this.node.drops,t,e)){this.justPlayed=sn(t.role).toUpperCase()+"@"+e,this.justDropped=t.role,this.justCaptured=void 0,this.sound.move();const n={role:t.role,pos:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};this.socket.sendAnaDrop(n),this.preparePremoving(),this.redraw()}else this.jump(this.path)},this.userMove=(t,e,n)=>{this.justPlayed=t,this.justDropped=void 0;const o=this.chessground.state.pieces.get(e),r=n||o&&"pawn"==o.role&&t[0]!=e[0];this.sound[r?"capture":"move"](),this.promotion.start(t,e,((t,e,o)=>this.sendMove(t,e,n,o)))||this.sendMove(t,e,n)},this.sendMove=(t,e,n,o)=>{const r={orig:t,dest:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};n&&(this.justCaptured=n),o&&(r.promotion=o),this.practice&&this.practice.onUserMove(),this.socket.sendAnaMove(r),this.preparePremoving(),this.redraw()},this.onPremoveSet=()=>{this.study&&this.study.onPremoveSet()},this.setAutoShapes=()=>{this.withCg((t=>t.setAutoShapes(function(t){const e=t.node.fen.includes(" w ")?"white":"black",n=Fr(e);if(t.practice){const n=t.practice.hovering();if(n)return Xr(e,n.uci,"green");const o=t.practice.hinting();return o?"move"===o.mode?Xr(e,o.uci,"paleBlue"):[{orig:"@"===o.uci[1]?o.uci.slice(2,4):o.uci.slice(0,2),brush:"paleBlue"}]:[]}const o=t.getCeval(),{eval:r={},fen:i,ceval:s,threat:a}=t.node;let c=t.explorer.hovering();c&&c.fen===i||(t.explorer.hovering(null),c=o.hovering());let l,d=[];if(t.retro&&(l=t.retro.showBadNode()))return Xr(e,l.uci,"paleRed",{lineWidth:8});if(c&&c.fen===i&&(d=d.concat(Xr(e,c.uci,"paleBlue"))),t.showAutoShapes()&&t.showComputer()&&(r.best&&(d=d.concat(Xr(n,r.best,"paleGreen"))),!c&&parseInt(o.multiPv()))){const n=o.enabled()&&s?s.pvs[0].moves[0]:t.nextNodeBest();n&&(d=d.concat(Xr(e,n,"paleBlue"))),o.enabled()&&s&&s.pvs[1]&&!(t.threatMode()&&a&&a.pvs.length>2)&&s.pvs.forEach((function(t){if(t.moves[0]===n)return;const o=co(e,s.pvs[0],t);o>=0&&o<.2&&(d=d.concat(Xr(e,t.moves[0],"paleGrey",{lineWidth:Math.round(12-50*o)})))}))}if(o.enabled()&&t.threatMode()&&a){const[t,...e]=a.pvs;d=d.concat(Xr(n,t.moves[0],e.length>0?"paleRed":"red")),e.forEach((function(e){const o=co(n,e,t);o>=0&&o<.2&&(d=d.concat(Xr(n,e.moves[0],"paleRed",{lineWidth:Math.round(11-45*o)})))}))}if(t.showMoveAnnotation()&&t.showComputer()){const{uci:e,glyphs:n,san:o}=t.node;if(e&&o&&n&&n.length>0){const t=n[0],r=Qr[t.symbol];if(r){const t=dn(e),n=o.startsWith("O-O")?0===on(t.to)?o.startsWith("O-O-O")?"c1":"g1":o.startsWith("O-O-O")?"c8":"g8":ln(t.to);d=d.concat({orig:n,customSvg:r})}}}return d}(this))))},this.onNewCeval=(t,e,n)=>{this.tree.updateAt(e,(o=>{if(o.fen===t.fen||n){if(n){const e=t;(!o.threat||lo(e,o.threat)||o.threat.maxDepth<e.maxDepth)&&(o.threat=e)}else!o.ceval||lo(t,o.ceval)?o.ceval=t:t.cloud||(o.ceval.cloud&&this.ceval.isDeeper()?o.ceval=t:t.maxDepth>o.ceval.maxDepth&&(o.ceval.maxDepth=t.maxDepth));e===this.path&&(this.setAutoShapes(),n||(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),this.studyPractice&&this.studyPractice.onCeval(),this.evalCache.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop()),this.redraw())}}))},this.startCeval=Ne(800,(()=>{this.ceval.enabled()&&(this.canUseCeval()?(this.ceval.start(this.path,this.nodeList,this.threatMode()),this.evalCache.fetch(this.path,parseInt(this.ceval.multiPv()))):this.ceval.stop())})),this.toggleCeval=()=>{this.showComputer()&&(this.ceval.toggle(),this.setAutoShapes(),this.startCeval(),this.ceval.enabled()||(this.threatMode(!1),this.practice&&this.togglePractice()),this.redraw())},this.toggleThreatMode=()=>{this.node.check||(this.ceval.enabled()||this.ceval.toggle(),this.ceval.enabled()&&(this.threatMode(!this.threatMode()),this.threatMode()&&this.practice&&this.togglePractice(),this.setAutoShapes(),this.startCeval(),this.redraw()))},this.disableThreatMode=()=>!!this.practice,this.mandatoryCeval=()=>!!this.studyPractice,this.cevalSetMultiPv=t=>{this.ceval.multiPv(t),this.tree.removeCeval(),this.evalCache.clear(),this.cevalReset()},this.cevalSetThreads=t=>{this.ceval.threads&&(this.ceval.threads(t),this.cevalReset())},this.cevalSetHashSize=t=>{this.ceval.hashSize&&(this.ceval.hashSize(t),this.cevalReset())},this.cevalSetInfinite=t=>{this.ceval.infinite(t),this.cevalReset()},this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.toggleAutoShapes=t=>{this.showAutoShapes(t),this.resetAutoShapes()},this.toggleGauge=()=>{this.showGauge(!this.showGauge())},this.toggleMoveAnnotation=t=>{this.showMoveAnnotation(t),this.resetAutoShapes()},this.toggleComputer=()=>{this.ceval.enabled()&&this.toggleCeval();const t=!this.showComputer();this.showComputer(t),!t&&this.practice&&this.togglePractice(),this.onToggleComputer(),lichess.pubsub.emit("analysis.comp.toggle",t)},this.toggleRetro=()=>{this.retro?this.retro=void 0:(this.retro=ya(this,this.bottomColor()),this.practice&&this.togglePractice(),this.explorer.enabled()&&this.toggleExplorer()),this.setAutoShapes()},this.toggleExplorer=()=>{this.practice&&this.togglePractice(),(this.explorer.enabled()||this.explorer.allowed())&&this.explorer.toggle()},this.togglePractice=()=>{this.practice||!this.ceval.possible?(this.practice=void 0,this.showGround()):(this.retro&&this.toggleRetro(),this.explorer.enabled()&&this.toggleExplorer(),this.practice=ba(this,(()=>this.studyPractice&&null===this.studyPractice.success()?20:18)),this.setAutoShapes())},this.gamebookPlay=()=>this.study&&this.study.gamebookPlay(),this.isGamebook=()=>!(!this.study||!this.study.data.chapter.gamebook),this.withCg=t=>{if(this.chessground&&this.cgVersion.js===this.cgVersion.dom)return t(this.chessground)},this.data=t.data,this.element=t.element,this.embed=t.embed,this.trans=t.trans,this.treeView=function(t="column"){const e=xn("treeView",t);function n(){return"inline"===e()}function o(t){e(t?"inline":"column")}return{get:e,set:o,toggle(){o(!n())},inline:n}}(t.embed?"inline":"column"),this.promotion=new vc(this.withCg,(()=>this.withCg((t=>t.set(this.cgConfig)))),this.redraw),this.data.forecast&&(this.forecast=ws(this.data.forecast,this.data,e)),this.opts.wiki&&(this.wiki=bc()),lichess.AnalyseNVUI&&(this.nvui=lichess.AnalyseNVUI(e)),this.instanciateEvalCache(),this.initialize(this.data,!1),this.instanciateCeval(),this.initialPath="";{const t=window.location,e="#last"===t.hash?this.tree.lastPly():parseInt(t.hash.substr(1));if(e){window.history.replaceState(null,"",t.pathname+t.search);const n=ne(this.tree.root);this.initialPath=Xt(n,(t=>t.ply<=e))}}this.setPath(this.initialPath),this.showGround(),this.onToggleComputer(),this.startCeval(),this.explorer.setNode(),this.study=t.study?hi(t.study,this,(t.tagTypes||"").split(","),t.practice,t.relay):void 0,this.studyPractice=this.study?this.study.practice:void 0,"#practice"===location.hash||this.study&&this.study.data.chapter.practice?this.togglePractice():"#menu"===location.hash&&lichess.requestIdleCallback(this.actionMenu.toggle,500),we(this),lichess.pubsub.on("jump",(t=>{this.jumpToMain(parseInt(t)),this.redraw()})),lichess.pubsub.on("sound_set",(t=>{this.music||"music"!==t||lichess.loadScript("javascripts/music/replay.js").then((()=>{this.music=window.lichessReplayMusic()})),this.music&&"music"!==t&&(this.music=null)})),lichess.pubsub.on("analysis.change.trigger",this.onChange),lichess.pubsub.on("analysis.chart.click",(t=>{this.jumpToIndex(t),this.redraw()})),lichess.pubsub.on("speech.enabled",Ce),Ce(lichess.sound.speech())}initialize(t,e){this.data=t,this.synthetic="synthetic"===t.game.id,this.ongoing=!this.synthetic&&Ot(t);const n=e&&this.tree.root;this.tree=re(function(t){const e=t[0],n=t.length;let o=e;e.id="";for(let r=1;r<n;r++){const e=t[r];o.children?o.children.unshift(e):o.children=[e],o=e}return o.children=o.children||[],e}(this.data.treeParts)),n&&this.tree.merge(n),this.actionMenu=new Ti,this.autoplay=new pi(this),this.socket?this.socket.clearCache():this.socket=function(t,e){let n,o,r={};function i(){r="standard"===e.data.game.variant.key&&e.tree.root.fen.split(" ",1)[0]===wa?{"":{path:"",dests:"iqy muC gvx ltB bqs pxF jrz nvD ksA owE"}}:{}}function s(){if(e.study)return e.study.vm.chapterId}function a(t,n=!1){const o=s();o&&(t.ch=o,n&&(e.study.isWriting()?e.study.vm.mode.sticky||(t.sticky=!1):t.write=!1))}i(),e.synthetic||setTimeout((function(){t("startWatching",e.data.game.id)}),1e3);const c={node(t){clearTimeout(n),t.ch==s()?e.addNode(t.node,t.path):console.log("socket handler node got wrong chapter id",t)},stepFailure(){clearTimeout(n),e.reset()},dests(t){clearTimeout(o),t.ch&&t.ch!==s()?console.log("socket handler node got wrong chapter id",t):(r[t.path]=t,e.addDests(t.dests,t.path))},destsFailure(t){console.log(t),clearTimeout(o)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==Yt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()},analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)}};function l(t){"standard"===t.variant&&delete t.variant}return{receive(t,n){const o=c[t];return o?(o(n),!0):!!e.study&&e.study.socketHandler(t,n)},sendAnaMove:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaMove",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDrop:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaDrop",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDests:function e(n){clearTimeout(o),r[n.path]?setTimeout((function(){c.dests(r[n.path])}),300):(l(n),a(n),t("anaDests",n),o=setTimeout((function(){console.log(n,"resendAnaDests"),e(n)}),3e3))},clearCache:i,send:t}}(this.opts.socketSend,this),this.explorer&&this.explorer.destroy(),this.explorer=new va(this,this.opts.explorer,this.explorer?this.explorer.allowed():!this.embed),this.gamePath=this.synthetic||this.ongoing?void 0:Vt(ne(this.tree.root)),this.fork=function(t){let e,n=0;function o(){return t.node.children.length>1}return{state(){const r=t.node;return e&&e.id===r.id||(e=r,n=0),{node:r,selected:n,displayed:o()}},next(){if(o())return n=Math.min(t.node.children.length-1,n+1),!0},prev(){if(o())return n=Math.max(0,n-1),!0},highlight(e){var n;if(!o()||!I(e))return void t.explorer.setHovering(t.node.fen,null);const r=null===(n=t.node.children[e])||void 0===n?void 0:n.uci,i=I(r)?r:null;t.explorer.setHovering(t.node.fen,i)},proceed(e){if(o()){e=I(e)?e:n;const o=t.node.children[e];if(I(o))return t.userJumpIfCan(t.path+o.id),!0}}}}(this),lichess.sound.preloadBoardSounds()}topColor(){return nn(this.bottomColor())}bottomColor(){return"racingKings"===this.data.game.variant.key?this.flipped?"black":"white":this.flipped?nn(this.data.orientation):this.data.orientation}getOrientation(){return this.bottomColor()}getNode(){return this.node}turnColor(){return this.node.ply%2==0?"white":"black"}togglePlay(t){this.autoplay.toggle(t),this.actionMenu.open=!1}uciToLastMove(t){if(t)return"@"===t[1]?[t.substr(2,2),t.substr(2,2)]:[t.substr(0,2),t.substr(2,2)]}showGround(){this.onChange(),I(this.node.dests)||this.getDests(),this.withCg((t=>{t.set(this.makeCgOpts()),this.setAutoShapes(),this.node.shapes&&t.setShapes(this.node.shapes)}))}makeCgOpts(){const t=this.node,e=this.turnColor(),n=function(t){if(void 0===t)return null;const e=new Map;if(t)for(const n of t.split(" "))e.set(It[n[0]],n.slice(1).split("").map((t=>It[t])));return e}(this.node.dests),o=_t(this.node.drops),r=this.gamebookPlay(),i=r?r.movableColor():this.practice?this.bottomColor():!this.embed&&(n&&n.size>0||null===o||o.length)?e:void 0,s={fen:t.fen,turnColor:e,movable:this.embed?{color:void 0,dests:new Map}:{color:i,dests:i===e&&n||new Map},check:!!t.check,lastMove:this.uciToLastMove(t.uci)};return n||t.check||(s.turnColor=nn(e),s.movable.color=e),s.premovable={enabled:s.movable.color&&s.turnColor!==s.movable.color},this.cgConfig=s,s}autoScroll(){this.autoScrollRequested=!0}jump(t){const e=t!==this.path,n=e&&t.length==this.path.length+2;this.setPath(t),e&&(this.study&&this.study.setPath(t,this.node),n&&(this.node.uci?this.playedLastMoveMyself()||(this.node.san.includes("x")?this.sound.capture():this.sound.move()):this.sound.move(),/\+|#/.test(this.node.san)&&this.sound.check()),this.threatMode(!1),this.ceval.stop(),this.startCeval(),xe(this.node)),this.justPlayed=this.justDropped=this.justCaptured=void 0,this.explorer.setNode(),this.updateHref(),this.autoScroll(),this.promotion.cancel(),e&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.study&&this.study.onJump()),this.music&&this.music.jump(this.node),lichess.pubsub.emit("ply",this.node.ply),this.showGround()}canJumpTo(t){return!this.study||this.study.canJumpTo(t)}userJumpIfCan(t){this.canJumpTo(t)&&this.userJump(t)}mainlinePathToPly(t){return Xt(this.mainline,(e=>e.ply<=t))}jumpToGlyphSymbol(t,e){const n=function(t,e,n,o){const r=n.length;if(!r)return;const i=o-n[0].ply;for(let s=1;s<r;s++){const o=n[(i+s)%r];if(o.ply%2==("white"===t?1:0)&&o.glyphs&&o.glyphs.find((function(t){return t.symbol===e})))return o}}(t,e,this.mainline,this.node.ply);n&&this.jumpToMain(n.ply),this.redraw()}reloadData(t,e){this.initialize(t,e),this.redirecting=!1,this.setPath(""),this.instanciateCeval(),this.instanciateEvalCache(),this.cgVersion.js++}changePgn(t){this.redirecting=!0,B("/analysis/pgn",{method:"post",body:G({pgn:t})}).then((t=>{this.reloadData(t,!1),this.userJump(this.mainlinePathToPly(this.tree.lastPly())),this.redraw()}),(t=>{console.log(t),this.redirecting=!1,this.redraw()}))}changeFen(t){this.redirecting=!0,window.location.href="/analysis/"+this.data.game.variant.key+"/"+encodeURIComponent(t).replace(/%20/g,"_").replace(/%2F/g,"/")}preparePremoving(){this.chessground.set({turnColor:this.chessground.state.movable.color,movable:{color:nn(this.chessground.state.movable.color)},premovable:{enabled:!0}})}addNode(t,e){const n=this.tree.addNode(t,e);if(!n)return console.log("Can't addNode",t,e),this.redraw();this.jump(n),this.redraw();const o=this.pvUciQueue.shift();o?this.playUci(o,this.pvUciQueue):this.chessground.playPremove()}addDests(t,e){this.tree.addDests(t,e),e===this.path&&(this.showGround(),this.outcome()&&this.ceval.stop()),this.withCg((t=>t.playPremove()))}deleteNode(t){const e=this.tree.nodeAtPath(t);if(!e)return;const n=Zt(e);(n.nodes>=10||n.comments>0)&&!confirm("Delete "+Ae("move",n.nodes)+(n.comments?" and "+Ae("comment",n.comments):"")+"?")||(this.tree.deleteNodeAt(t),Gt(this.path,t)?this.userJump(zt(t)):this.jump(this.path),this.study&&this.study.deleteNode(t))}promote(t,e){this.tree.promoteAt(t,e),this.jump(t),this.study&&this.study.promote(t,e)}forceVariation(t,e){this.tree.forceVariationAt(t,e),this.jump(t),this.study&&this.study.forceVariation(t,e)}reset(){this.showGround(),this.redraw()}encodeNodeFen(){return this.node.fen.replace(/\s/g,"_")}currentEvals(){return{server:this.node.eval,client:this.node.ceval}}nextNodeBest(){return Ht(this.node,(t=>{var e;return null===(e=t.eval)||void 0===e?void 0:e.best}))}instanciateCeval(){this.ceval&&this.ceval.destroy(),this.ceval=Zo({variant:this.data.game.variant,initialFen:this.data.game.initialFen,possible:!this.embed&&(this.synthetic||!Ot(this.data)),emit:(t,e)=>{this.onNewCeval(t,e.path,e.threatMode)},setAutoShapes:this.setAutoShapes,redraw:this.redraw,...this.opts.study&&this.opts.practice?{storageKeyPrefix:"practice",multiPvDefault:1}:{}})}getCeval(){return this.ceval}outcome(t){return this.position(t||this.node).unwrap((t=>t.outcome()),(t=>{}))}position(t){const e=yn(t.fen).unwrap();return Yo(Zn(this.data.game.variant.key),e)}canUseCeval(){return!this.node.threefold&&!this.outcome()}cevalReset(){this.ceval.stop(),this.ceval.enabled()||this.ceval.toggle(),this.startCeval(),this.redraw()}showEvalGauge(){return this.hasAnyComputerAnalysis()&&this.showGauge()&&!this.outcome()&&this.showComputer()}hasAnyComputerAnalysis(){return!!this.data.analysis||this.ceval.enabled()}resetAutoShapes(){this.showAutoShapes()||this.showMoveAnnotation()?this.setAutoShapes():this.chessground&&this.chessground.setAutoShapes([])}onToggleComputer(){this.showComputer()?this.resetAutoShapes():(this.tree.removeComputerVariations(),this.ceval.enabled()&&this.toggleCeval(),this.chessground&&this.chessground.setAutoShapes([]))}mergeAnalysisData(t){this.study&&this.study.data.chapter.id!==t.ch||(this.tree.merge(t.tree),this.showComputer()||this.tree.removeComputerVariations(),this.data.analysis=t.analysis,t.analysis&&(t.analysis.partial=!!Wt(t.tree,(t=>!t.eval&&!!t.children.length&&t.ply<=300))),t.division&&(this.data.game.division=t.division),this.retro&&this.retro.onMergeAnalysisData(),this.study&&this.study.serverEval.onMergeAnalysisData(),lichess.pubsub.emit("analysis.server.progress",this.data),this.redraw())}playUci(t,e){this.pvUciQueue=null!=e?e:[];const n=dn(t),o=ln(n.to);if("from"in n){const t=this.chessground.state.pieces.get(ln(n.from)),e=this.chessground.state.pieces.get(o);this.sendMove(ln(n.from),o,e&&t&&e.color!==t.color?e:void 0,n.promotion)}else this.chessground.newPiece({color:this.chessground.state.movable.color,role:n.role},o)}playUciList(t){this.pvUciQueue=t;const e=this.pvUciQueue.shift();e&&this.playUci(e,this.pvUciQueue)}explorerMove(t){this.playUci(t),this.explorer.loading(!0)}playBestMove(){var t;const e=(null===(t=this.node.ceval)||void 0===t?void 0:t.pvs[0].moves[0])||this.nextNodeBest();e&&this.playUci(e)}canEvalGet(){if(this.node.ply>=15&&!this.opts.study)return!1;const t=new Set;for(let e=this.nodeList.length-1;e>=0;e--){const n=this.nodeList[e],o=n.fen.split(" ").slice(0,4).join(" ");if(t.has(o))return!1;if(n.san&&ho(this.data.game.variant.key,n.san))return!0;t.add(o)}return!0}instanciateEvalCache(){this.evalCache=ys({variant:this.data.game.variant.key,canGet:()=>this.canEvalGet(),canPut:()=>!!(this.data.evalPut&&this.canEvalGet()&&(this.opts.study||!this.node.ceval.mate&&Math.abs(this.node.ceval.cp)<99)),getNode:()=>this.node,send:this.opts.socketSend,receive:this.onNewCeval})}restartPractice(){this.practice=void 0,this.togglePractice()}}const wc={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0};const kc={white:0,black:0};function Cc(t,e,n,o){const r=[];let i;for(i in t)if(t[i]>0){const e=[];for(let n=0;n<t[i];n++)e.push(m("mpiece."+i));r.push(m("div",e))}if(o)for(let s=0;s<o;s++)r.push(m("div",m("mpiece.king")));return e>0&&r.push(m("score","+"+e)),m("div.material.material-"+n,r)}const xc={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};function Sc(t,e,n,o,r,i){let s,a=0;t?(s=function(t){const e={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};for(const n of t.values()){const t=e[Fr(n.color)];t[n.role]>0?t[n.role]--:e[n.color][n.role]++}return e}(n),a=function(t){let e=0;for(const n of t.values())e+=wc[n.role]*("white"===n.color?1:-1);return e}(n)*("white"===e?1:-1)):s=xc;const c=o?function(t,e){const n={...kc};for(const o of t){if(e<o.ply)break;o.check&&(o.ply%2==1?n.white++:n.black++)}return n}(r,i):kc,l=Fr(e);return[Cc(s[l],-a,"top",c[l]),Cc(s[e],a,"bottom",c[e])]}function Mc(t,e){for(let n=0;n<8;n++)for(let o=n%2===e?0:1;o<8;o+=2)if(/[bB]/.test(t[8*n+o]))return!0;return!1}function Pc(t){var e;const n=t.trans.noarg,o=t.data;switch(o.game.status.name){case"started":return n("playingRightNow");case"aborted":return n("gameAborted");case"mate":return n("checkmate");case"resign":return n("white"==o.game.winner?"blackResigned":"whiteResigned");case"stalemate":return n("stalemate");case"timeout":switch(o.game.winner){case"white":return n("blackLeftTheGame");case"black":return n("whiteLeftTheGame")}return`${o.game.turns%2==0?n("whiteLeftTheGame"):n("blackLeftTheGame")}${o.game.winner?"":` • ${n("draw")}`}`;case"draw":return(null===(e=o.game.drawOffers)||void 0===e?void 0:e.some((t=>t>=o.game.turns)))?n("drawByMutualAgreement"):"100"===o.game.fen.split(" ")[4]?`${n("fiftyMovesWithoutProgress")} • ${n("draw")}`:o.game.threefold?`${n("threefoldRepetition")} • ${n("draw")}`:function(t,e){if("horde"===t||"kingOfTheHill"===t||"racingKings"===t||"crazyhouse"===t||"atomic"===t||"antichess"===t)return!1;let n=e.split(" ")[0].replace(/[^a-z]/gi,"");if("threeCheck"===t)return!/[pbnrq]/.test(n)||!/[PBNRQ]/.test(n);if(/[prq]/i.test(n))return!1;if(/n/.test(n))return n.length-n.replace(/[a-z]/g,"").length<=2&&!/[PBNR]/.test(n);if(/N/.test(n))return n.length-n.replace(/[A-Z]/g,"").length<=2&&!/[pbnr]/.test(n);if(/b/i.test(n)){for(let t=8;t>1;t--)n=n.replace(""+t,"1"+(t-1));return!(Mc(n,0)&&Mc(n,1)||/[pPnN]/.test(n))}return!1}(o.game.variant.key,o.game.fen)?`${n("insufficientMaterial")} • ${n("draw")}`:n("draw");case"outoftime":return`${o.game.turns%2==0?n("whiteTimeOut"):n("blackTimeOut")}${o.game.winner?"":` • ${n("draw")}`}`;case"noStart":return"white"==o.game.winner?n("blackDidntMove"):n("whiteDidntMove");case"cheat":return n("cheatDetected");case"variantEnd":switch(o.game.variant.key){case"kingOfTheHill":return n("kingInTheCenter");case"threeCheck":return n("threeChecks")}return n("variantEnding");case"unknownFinish":return"Finished";default:return o.game.status.name}}function Ec(t,e){const n=Ft(t.data,e);return n.user?m("a.user-link.ulpt",{attrs:{href:"/@/"+n.user.username}},[n.user.username," ",(o=n.ratingDiff,0===o?m("span","±0"):o&&o>0?m("good","+"+o):o&&o<0?m("bad","−"+-o):void 0)]):m("span",n.name||n.ai&&"Stockfish level "+n.ai||t.study&&Nn(t.study.data.chapter.tags,e)||"Anonymous");var o}const Ac=[{kind:"inaccuracy",i18n:"nbInaccuracies",symbol:"?!"},{kind:"mistake",i18n:"nbMistakes",symbol:"?"},{kind:"blunder",i18n:"nbBlunders",symbol:"??"}];function Tc(t,e){const n=t.data,o=n.analysis[e].acpl;return m("div.advice-summary__side",[m("div.advice-summary__player",[m(`i.is.color-icon.${e}`),Ec(t,e)]),...Ac.map((o=>{const r=n.analysis[e][o.kind];return m("div.advice-summary__mistake"+(r?".symbol":""),{attrs:r?{"data-color":e,"data-symbol":o.symbol}:{}},t.trans.vdomPlural(o.i18n,r,m("strong",r)))})),m("div.advice-summary__acpl",[m("strong",""+(I(o)?o:"?")),m("span",t.trans.noarg("averageCentipawnLoss"))])])}function Ic(t){return m("div.advice-summary",{hook:{insert:e=>{$(e.elm).on("click","div.symbol",(function(){t.jumpToGlyphSymbol($(this).data("color"),$(this).data("symbol"))}))}}},[Tc(t,"white"),t.study?null:m("a.button.text",{class:{active:!!t.retro},attrs:E(""),hook:S("click",t.toggleRetro,t.redraw)},t.trans.noarg("learnFromYourMistakes")),Tc(t,"black")])}function $c(t){if(t.studyPractice||t.embed)return;if(!t.data.analysis||!t.showComputer()||t.study&&"serverEval"!==t.study.vm.toolTab())return m("div.analyse__acpl");let e=""+(t.data.analysis.partial?Math.random():"")+!!t.retro;return t.study&&(e+=t.study.data.chapter.id),m("div.analyse__acpl",b("div.advice-summary",Ic,[t,e]))}function _c(t){if(t.embed)return;const e=t.node,n=e.clock;if(!n&&0!==n)return;const o=t.bottomIsWhite(),r=t.tree.getParentClock(e,t.path),i=e.ply%2==0,s=[r,n];i||s.reverse();const a=t.study,c=a&&a.data.chapter.relay;if(c&&c.lastMoveAt&&c.path===t.path&&""!==t.path&&!_n(a.data.chapter)){const t=(Date.now()-c.lastMoveAt)/10,e=i?0:1;s[e]&&(s[e]=Math.max(0,s[e]-t))}const l=!t.study||!t.study.relay;return[Nc(s[0],i,o?"bottom":"top",l),Nc(s[1],!i,o?"top":"bottom",l)]}function Nc(t,e,n,o){return m("div.analyse__clock."+n,{class:{active:e}},function(t,e){if(!t&&0!==t)return["-"];const n=new Date(10*t),o=n.getUTCMilliseconds(),r=":",i=Dc(n.getUTCMinutes())+r+Dc(n.getUTCSeconds());return!e||t>=36e4?[Math.floor(t/36e4)+r+i]:t>=6e3?[i]:[i,m("tenths","."+Math.floor(o/100).toString())]}(t,o))}function Dc(t){return(t<10?"0":"")+t}const qc=["mousedown","touchstart"],Oc=["pawn","knight","bishop","rook","queen"];function Rc(t,e,n){if(!t.node.crazy||"crazyhouse"!==t.data.game.variant.key)return;const o=t.node.crazy.pockets["white"===e?0:1],r=t.justDropped,i=t.justCaptured;i&&(i.role=i.promoted?"pawn":i.role);const s=e===t.turnColor(),a=!t.embed&&s;return m(`div.pocket.is2d.pocket-${n}.pos-${t.bottomColor()}`,{class:{usable:a},hook:x((n=>{t.embed||qc.forEach((o=>{n.addEventListener(o,(n=>function(t,e,n){if(void 0!==n.button&&0!==n.button)return;if(t.chessground.state.movable.color!==e)return;const o=n.target,r=o.getAttribute("data-role"),i=o.getAttribute("data-nb");r&&e&&"0"!==i&&(n.stopPropagation(),n.preventDefault(),lc(t.chessground.state,{color:e,role:r},n))}(t,e,n)))}))}))},Oc.map((t=>{let n=o[t]||0;return s&&(r===t&&n--,i&&i.role===t&&n++),m("div.pocket-c1",m("div.pocket-c2",m("piece."+t+"."+e,{attrs:{"data-role":t,"data-color":e,"data-nb":n}})))})))}function Lc(t,e,n){const o=n[0];if(!o)return;const r=e.findStartingWithNode(o);if(!r.length)return;const i=r.filter((function(t){return t.length>1}));return m("button.on-my-turn.button.text",{attrs:E(""),hook:S("click",(t=>e.playAndSave(o)))},[m("span",[m("strong",t.trans("playX",$t(n[0].san))),i.length?m("span",t.trans.plural("andSaveNbPremoveLines",i.length)):m("span",t.trans.noarg("noConditionalPremoves"))])])}function Fc(t,e){const n=t.tree.getCurrentNodesAfterPly(t.nodeList,t.mainline,t.data.game.turns);return e.truncate(n.map((t=>({ply:t.ply,fen:t.fen,uci:t.uci,san:t.san,check:t.check}))))}function Bc(t,e){const n=Fc(t,e),o=e.isCandidate(n);return m("div.forecast",{class:{loading:e.loading()}},[e.loading()?m("div.overlay",ye()):null,m("div.box",[m("div.top",t.trans.noarg("conditionalPremoves")),m("div.list",e.list().map((function(n,o){return m("div.entry.text",{attrs:E("")},[m("button.del",{hook:S("click",(t=>e.removeIndex(o)),t.redraw),attrs:{"data-icon":"",type:"button"}}),m("sans",wi(n))])}))),m("button.add.text",{class:{enabled:o},attrs:E(o?"":""),hook:S("click",(n=>e.addNodes(Fc(t,e))),t.redraw)},[m("span",o?[m("span",t.trans.noarg("addCurrentVariation")),m("sans",wi(n))]:t.trans.noarg("playVariationToCreateConditionalPremoves"))])]),e.onMyTurn?Lc(t,e,n):null])}const jc=(t,e=100)=>{let n;const o=Ne(e,(()=>requestAnimationFrame((()=>{t(),n&&clearTimeout(n),n=setTimeout(o,500)}))));o()};let zc=!1;let Gc=!1;function Vc(t){const e=()=>function(t){const e=t.querySelector(".mchat"),n=t.querySelector(".analyse__board .cg-wrap"),o=t.querySelector(".analyse__side");if(e&&n&&o){const t=n.offsetHeight-o.offsetHeight;t&&(e.style.height=`calc(${t}px - 2vmin)`)}}(t);var n;jc(e),n=e,zc||(zc=!0,document.body.addEventListener("chessground.resize",n)),Gc||(lichess.pubsub.on("chat.resize",e),Gc=!0)}function Hc(t,e){e.animation&&(Uc(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function Wc(t,e){var n,o;if((null===(n=e.movable)||void 0===n?void 0:n.dests)&&(t.movable.dests=void 0),(null===(o=e.drawable)||void 0===o?void 0:o.autoShapes)&&(t.drawable.autoShapes=[]),Uc(t,e),e.fen&&(t.pieces=xa(e.fen),t.drawable.shapes=[]),"check"in e&&function(t,e){if(t.check=void 0,!0===e&&(e=t.turnColor),e)for(const[n,o]of t.pieces)"king"===o.role&&o.color===e&&(t.check=n)}(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Fa(t,t.selected),Hc(t,e),!t.movable.rookCastle&&t.movable.dests){const e="white"===t.movable.color?"1":"8",n="e"+e,o=t.movable.dests.get(n),r=t.pieces.get(n);if(!o||!r||"king"!==r.role)return;t.movable.dests.set(n,o.filter((t=>!(t==="a"+e&&o.includes("c"+e)||t==="h"+e&&o.includes("g"+e)))))}}function Uc(t,e){for(const n in e)Kc(t[n])&&Kc(e[n])?Uc(t[n],e[n]):t[n]=e[n]}function Kc(t){return"object"==typeof t}function Jc(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function Yc(t,e){function n(){!function(t){t.orientation=Fr(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}(t),e()}return{set(e){e.orientation&&e.orientation!==t.orientation&&n(),Hc(t,e),(e.fen?oc:rc)((t=>Wc(t,e)),t)},state:t,getFen:()=>{return e=t.pieces,Nr.map((t=>$r.map((n=>{const o=e.get(n+t);if(o){let t=Ca[o.role];return"white"===o.color&&(t=t.toUpperCase()),o.promoted&&(t+="~"),t}return"1"})).join(""))).join("/").replace(/1{2,}/g,(t=>t.length.toString()));var e},toggleOrientation:n,setPieces(e){oc((t=>function(t,e){for(const[n,o]of e)o?t.pieces.set(n,o):t.pieces.delete(n)}(t,e)),t)},selectSquare(e,n){e?oc((t=>La(t,e,n)),t):t.selected&&(Ba(t),t.dom.redraw())},move(e,n){oc((t=>Na(t,e,n)),t)},newPiece(e,n){oc((t=>Da(t,e,n)),t)},playPremove(){if(t.premovable.current){if(oc(Va,t))return!0;t.dom.redraw()}return!1},playPredrop(e){if(t.predroppable.current){const n=function(t,e){const n=t.predroppable.current;let o=!1;if(!n)return!1;e(n)&&Da(t,{role:n.role,color:t.movable.color},n.key)&&(Ia(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return _a(t),o}(t,e);return t.dom.redraw(),n}return!1},cancelPremove(){rc($a,t)},cancelPredrop(){rc(_a,t)},cancelMove(){rc((t=>{Ha(t),pc(t)}),t)},stop(){rc((t=>{Wa(t),pc(t)}),t)},explode(e){!function(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout((()=>{Jc(t,2),setTimeout((()=>Jc(t,void 0)),120)}),120)}(t,e)},setAutoShapes(e){rc((t=>t.drawable.autoShapes=e),t)},setShapes(e){rc((t=>t.drawable.shapes=e),t)},getKeyAtDomPos:e=>Ua(e,Ka(t),t.dom.bounds()),redrawAll:e,dragNewPiece(e,n,o){lc(t,e,n,o)},destroy(){Wa(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function Xc(t,e,n){const o=new Map,r=[];for(const a of t)o.set(a.hash,!1);let i,s=e.firstChild;for(;s;)i=s.getAttribute("cgHash"),o.has(i)?o.set(i,!0):r.push(s),s=s.nextSibling;for(const a of r)e.removeChild(a);for(const a of t)o.get(a.hash)||e.appendChild(n(a))}function Qc(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Zc(t,e,n){const o=t.drawable,r=o.current,i=r&&r.mouseSq?r:void 0,s=new Map,a=t.dom.bounds(),c=o.autoShapes.filter((t=>!t.piece));for(const m of o.shapes.concat(c).concat(i?[i]:[]))m.dest&&s.set(m.dest,(s.get(m.dest)||0)+1);const l=o.shapes.concat(c).map((t=>({shape:t,current:!1,hash:tl(t,s,!1,a)})));i&&l.push({shape:i,current:!0,hash:tl(i,s,!0,a)});const d=l.map((t=>t.hash)).join(";");if(d===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=d;const u=e.querySelector("defs"),h=e.querySelector("g"),p=n.querySelector("g");!function(t,e,n){const o=new Map;let r;for(const a of e)a.shape.dest&&(r=t.brushes[a.shape.brush],a.shape.modifiers&&(r=al(r,a.shape.modifiers)),o.set(r.key,r));const i=new Set;let s=n.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[a,c]of o.entries())i.has(a)||n.appendChild(rl(c))}(o,l,u),Xc(l.filter((t=>!t.shape.customSvg)),h,(e=>ol(t,e,o.brushes,s,a))),Xc(l.filter((t=>t.shape.customSvg)),p,(e=>ol(t,e,o.brushes,s,a)))}function tl({orig:t,dest:e,brush:n,piece:o,modifiers:r,customSvg:i},s,a,c){return[c.width,c.height,a,t,e,n,e&&(s.get(e)||0)>1,o&&el(o),r&&(l=r,""+(l.lineWidth||"")),i&&nl(i)].filter((t=>t)).join(",");var l}function el(t){return[t.color,t.role,t.scale].filter((t=>t)).join(",")}function nl(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return"custom-"+e.toString()}function ol(t,{shape:e,current:n,hash:o},r,i,s){let a;const c=sl(Or(e.orig),t.orientation);if(e.customSvg)a=function(t,e,n){const[o,r]=dl(e,n),i=il(Qc("g"),{transform:`translate(${o},${r})`}),s=il(Qc("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(s),s.innerHTML=t,i}(e.customSvg,c,s);else if(e.dest){let o=r[e.brush];e.modifiers&&(o=al(o,e.modifiers)),a=function(t,e,n,o,r,i){const s=function(t){return(t?20:10)/64}(r&&!o),a=dl(e,i),c=dl(n,i),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),h=Math.cos(u)*s,p=Math.sin(u)*s;return il(Qc("line"),{stroke:t.color,"stroke-width":cl(t,o),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+t.key+")",opacity:ll(t,o),x1:a[0],y1:a[1],x2:c[0]-h,y2:c[1]-p})}(o,c,sl(Or(e.dest),t.orientation),n,(i.get(e.dest)||0)>1,s)}else a=function(t,e,n,o){const r=dl(e,o),i=[3/64,4/64],s=(o.width+o.height)/(4*Math.max(o.width,o.height));return il(Qc("circle"),{stroke:t.color,"stroke-width":i[n?0:1],fill:"none",opacity:ll(t,n),cx:r[0],cy:r[1],r:s-i[1]/2})}(r[e.brush],c,n,s);return a.setAttribute("cgHash",o),a}function rl(t){const e=il(Qc("marker"),{id:"arrowhead-"+t.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return e.appendChild(il(Qc("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function il(t,e){for(const n in e)t.setAttribute(n,e[n]);return t}function sl(t,e){return"white"===e?t:[7-t[0],7-t[1]]}function al(t,e){return{color:t.color,opacity:Math.round(10*t.opacity)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter((t=>t)).join("")}}function cl(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function ll(t,e){return(t.opacity||1)*(e?.9:1)}function dl(t,e){const n=Math.min(1,e.width/e.height),o=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*o]}function ul(t,e){const n=Kr("coords",e);let o;for(const r of t)o=Kr("coord"),o.textContent=r,n.appendChild(o);return n}function hl(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),t.viewOnly)return;const o=function(t){return e=>{t.draggable.current?pc(t):t.drawable.current?tc(t):e.shiftKey||Ur(e)?t.drawable.enabled&&Ya(t,e):t.viewOnly||(t.dropmode.active?function(t,e){if(!t.dropmode.active)return;$a(t),_a(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const o=Wr(e),r=o&&Ua(o,Ka(t),t.dom.bounds());r&&Ra(t,"a0",r)}t.dom.redraw()}(t,e):cc(t,e))}}(t);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",(t=>t.preventDefault()))}function pl(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function ml(t,e,n){return o=>{t.drawable.current?t.drawable.enabled&&n(t,o):t.viewOnly||e(t,o)}}function fl(t){const e=Ka(t),n=zr(t.dom.bounds()),o=t.dom.elements.board,r=t.pieces,i=t.animation.current,s=i?i.plan.anims:new Map,a=i?i.plan.fadings:new Map,c=t.draggable.current,l=function(t){var e;const n=new Map;if(t.lastMove&&t.highlight.lastMove)for(const i of t.lastMove)Cl(n,i,"last-move");t.check&&t.highlight.check&&Cl(n,t.check,"check");if(t.selected&&(Cl(n,t.selected,"selected"),t.movable.showDests)){const o=null===(e=t.movable.dests)||void 0===e?void 0:e.get(t.selected);if(o)for(const e of o)Cl(n,e,"move-dest"+(t.pieces.has(e)?" oc":""));const r=t.premovable.dests;if(r)for(const e of r)Cl(n,e,"premove-dest"+(t.pieces.has(e)?" oc":""))}const o=t.premovable.current;if(o)for(const i of o)Cl(n,i,"current-premove");else t.predroppable.current&&Cl(n,t.predroppable.current.key,"current-premove");const r=t.exploding;if(r)for(const i of r.keys)Cl(n,i,"exploding"+r.stage);return n}(t),d=new Set,u=new Set,h=new Map,p=new Map;let m,f,g,v,b,y,w,k,C,x;for(f=o.firstChild;f;){if(m=f.cgKey,vl(f))if(g=r.get(m),b=s.get(m),y=a.get(m),v=f.cgPiece,!f.cgDragging||c&&c.orig===m||(f.classList.remove("dragging"),Gr(f,n(Or(m),e)),f.cgDragging=!1),!y&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),g){if(b&&f.cgAnimating&&v===kl(g)){const t=Or(m);t[0]+=b[2],t[1]+=b[3],f.classList.add("anim"),Gr(f,n(t,e))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),Gr(f,n(Or(m),e)),t.addPieceZIndex&&(f.style.zIndex=wl(Or(m),e)));v!==kl(g)||y&&f.cgFading?y&&v===kl(y)?(f.classList.add("fading"),f.cgFading=!0):xl(h,v,f):d.add(m)}else xl(h,v,f);else if(bl(f)){const t=f.className;l.get(m)===t?u.add(m):xl(p,t,f)}f=f.nextSibling}for(const[S,M]of l)if(!u.has(S)){C=p.get(M),x=C&&C.pop();const t=n(Or(S),e);if(x)x.cgKey=S,Gr(x,t);else{const e=Kr("square",M);e.cgKey=S,Gr(e,t),o.insertBefore(e,o.firstChild)}}for(const[S,M]of r)if(b=s.get(S),!d.has(S))if(w=h.get(kl(M)),k=w&&w.pop(),k){k.cgKey=S,k.cgFading&&(k.classList.remove("fading"),k.cgFading=!1);const o=Or(S);t.addPieceZIndex&&(k.style.zIndex=wl(o,e)),b&&(k.cgAnimating=!0,k.classList.add("anim"),o[0]+=b[2],o[1]+=b[3]),Gr(k,n(o,e))}else{const r=kl(M),i=Kr("piece",r),s=Or(S);i.cgPiece=r,i.cgKey=S,b&&(i.cgAnimating=!0,s[0]+=b[2],s[1]+=b[3]),Gr(i,n(s,e)),t.addPieceZIndex&&(i.style.zIndex=wl(s,e)),o.appendChild(i)}for(const S of h.values())yl(t,S);for(const S of p.values())yl(t,S)}function gl(t){const e=t.dom.elements.wrap.getBoundingClientRect(),n=t.dom.elements.container,o=e.height/e.width,r=8*Math.floor(e.width*window.devicePixelRatio/8)/window.devicePixelRatio,i=r*o;n.style.width=r+"px",n.style.height=i+"px",t.dom.bounds.clear(),t.addDimensionsCssVars&&(document.documentElement.style.setProperty("--cg-width",r+"px"),document.documentElement.style.setProperty("--cg-height",i+"px"))}function vl(t){return"PIECE"===t.tagName}function bl(t){return"SQUARE"===t.tagName}function yl(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function wl(t,e){const n=t[1];return`${e?10-n:3+n}`}function kl(t){return`${t.color} ${t.role}`}function Cl(t,e,n){const o=t.get(e);o?t.set(e,`${o} ${n}`):t.set(e,n)}function xl(t,e,n){const o=t.get(e);o?o.push(n):t.set(e,[n])}function Sl(t,e){Xc(t.drawable.autoShapes.filter((t=>t.piece)).map((t=>{return{shape:t,hash:(e=t,[e.orig,null===(n=e.piece)||void 0===n?void 0:n.role,null===(o=e.piece)||void 0===o?void 0:o.color,null===(r=e.piece)||void 0===r?void 0:r.scale].join(",")),current:!1};var e,n,o,r})),e,(e=>function(t,{shape:e,hash:n},o){var r,i,s;const a=e.orig,c=null===(r=e.piece)||void 0===r?void 0:r.role,l=null===(i=e.piece)||void 0===i?void 0:i.color,d=null===(s=e.piece)||void 0===s?void 0:s.scale,u=Kr("piece",`${c} ${l}`);return u.setAttribute("cgHash",n),u.cgKey=a,u.cgScale=d,Vr(u,zr(o)(Or(a),Ka(t)),d),u}(t,e,t.dom.bounds())))}function Ml(t,e){const n={pieces:xa(wa),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,addDimensionsCssVars:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Lr()};function o(){const e="dom"in n?n.dom.unbind:void 0,o=function(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const c of Ir)t.classList.toggle("orientation-"+c,e.orientation===c);t.classList.toggle("manipulable",!e.viewOnly);const n=Kr("cg-container");t.appendChild(n);const o=Kr("cg-board");let r,i,s,a;if(n.appendChild(o),e.drawable.visible&&(r=il(Qc("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(Qc("defs")),r.appendChild(Qc("g")),i=il(Qc("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(Qc("g")),s=Kr("cg-auto-pieces"),n.appendChild(r),n.appendChild(i),n.appendChild(s)),e.coordinates){const t="black"===e.orientation?" black":"",o="left"===e.ranksPosition?" left":"";n.appendChild(ul(_r,"ranks"+t+o)),n.appendChild(ul($r,"files"+t))}return e.draggable.showGhost&&(a=Kr("piece","ghost"),Hr(a,!1),n.appendChild(a)),{board:o,container:n,wrap:t,ghost:a,svg:r,customSvg:i,autoPieces:s}}(t,n),r=function(t){let e;const n=()=>(void 0===e&&(e=t()),e);return n.clear=()=>{e=void 0},n}((()=>o.board.getBoundingClientRect())),i=t=>{fl(a),o.autoPieces&&Sl(a,o.autoPieces),!t&&o.svg&&Zc(a,o.svg,o.customSvg)},s=()=>{gl(a),function(t){const e=Ka(t),n=zr(t.dom.bounds());let o=t.dom.elements.board.firstChild;for(;o;)(vl(o)&&!o.cgAnimating||bl(o))&&Gr(o,n(Or(o.cgKey),e)),o=o.nextSibling}(a),o.autoPieces&&function(t){var e;const n=Ka(t),o=zr(t.dom.bounds());let r=null===(e=t.dom.elements.autoPieces)||void 0===e?void 0:e.firstChild;for(;r;)Vr(r,o(Or(r.cgKey),n),r.cgScale),r=r.nextSibling}(a)},a=n;return a.dom={elements:o,bounds:r,redraw:Pl(i),redrawNow:i,unbind:e},a.drawable.prevSvgHash="",gl(a),i(!1),hl(a,s),e||(a.dom.unbind=function(t,e){const n=[];if("ResizeObserver"in window||n.push(pl(document.body,"chessground.resize",e)),!t.viewOnly){const e=ml(t,uc,Qa),o=ml(t,hc,Za);for(const t of["touchmove","mousemove"])n.push(pl(document,t,e));for(const t of["touchend","mouseup"])n.push(pl(document,t,o));const r=()=>t.dom.bounds.clear();n.push(pl(document,"scroll",r,{capture:!0,passive:!0})),n.push(pl(window,"resize",r,{passive:!0}))}return()=>n.forEach((t=>t()))}(a,s)),a.events.insert&&a.events.insert(o),a}return Wc(n,e||{}),Yc(o(),o)}function Pl(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame((()=>{t(),e=!1})))}}function El(t){var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}function Al(t){return m("div.cg-wrap.cgv"+t.cgVersion.js,{hook:{insert:e=>{t.chessground=Ml(e.elm,function(t){const e=t.data.pref,n=t.makeCgOpts(),o={turnColor:n.turnColor,fen:n.fen,check:n.check,lastMove:n.lastMove,orientation:t.bottomColor(),coordinates:0!==e.coords&&!t.embed,addPieceZIndex:e.is3d,addDimensionsCssVars:!0,viewOnly:!!t.embed,movable:{free:!1,color:n.movable.color,dests:n.movable.dests,showDests:e.destination,rookCastle:e.rookCastle},events:{move:t.userMove,dropNewPiece:t.userNewPiece,insert(e){t.embed||function(t,e,n,o){if(0===e)return;const r=document.createElement("cg-resize");t.container.appendChild(r);const i=t=>{t.preventDefault();const e="touchstart"===t.type?"touchmove":"mousemove",n="touchstart"===t.type?"touchend":"mouseup",o=El(t),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let i=r;const s=U((()=>j(`/pref/zoom?v=${i}`,{method:"post"})),700),a=t=>{const e=El(t),n=e[0]-o[0]+e[1]-o[1];i=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+i),window.dispatchEvent(new Event("resize")),s()};document.body.classList.add("resizing"),document.addEventListener(e,a),document.addEventListener(n,(()=>{document.removeEventListener(e,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",i,{passive:!1}),r.addEventListener("mousedown",i,{passive:!1}),1===e){const t=t=>r.classList.toggle("none",o?!o(t):t>=2);t(n),lichess.pubsub.on("ply",t)}}(e,2,t.node.ply)}},premovable:{enabled:n.premovable.enabled,showDests:e.destination,events:{set:t.onPremoveSet}},draggable:{enabled:0!==e.moveEvent,showGhost:e.highlight},selectable:{enabled:1!==e.moveEvent},drawable:{enabled:!t.embed,eraseOnClick:!t.opts.study||!!t.opts.practice,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:e.highlight,check:e.highlight},animation:{duration:e.animationDuration},disableContextMenu:!0};return t.study&&t.study.mutateCgConfig(o),o}(t)),t.setAutoShapes(),t.node.shapes&&t.chessground.setShapes(t.node.shapes),t.cgVersion.dom=t.cgVersion.js},destroy:e=>t.chessground.destroy()}})}function Tl(t,e,n){return t.best?e.trans.vdom("goodMove"===t.verdict?"anotherWasX":"bestWasX",m("move",{hook:{insert:t=>{const e=t.elm;e.addEventListener("click",n.playCommentBest),e.addEventListener("mouseover",(()=>n.commentShape(!0))),e.addEventListener("mouseout",(()=>n.commentShape(!1)))},destroy:()=>n.commentShape(!1)}},t.best.san)):[]}function Il(t,e){return m("div.player.off",[m("div.icon.off","!"),m("div.instruction",[m("strong",t.trans.noarg("youBrowsedAway")),m("div.choices",[m("a",{hook:S("click",e.resume,e.redraw)},t.trans.noarg("resumePractice"))])])])}function $l(t,e){const n=e.winner||t.turnColor();return m("div.player",[n?m("div.no-square",m("piece.king."+n)):m("div.icon.off","!"),m("div.instruction",[m("strong",t.trans.noarg(e.winner?"checkmate":"draw")),e.winner?m("em",m("color",t.trans.noarg("white"===e.winner?"whiteWinsGame":"blackWinsGame"))):m("em",t.trans.noarg("theGameIsADraw"))])])}function _l(t,e){return m("div.progress",m("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/(e-8)+"%":0}`}}))}function Nl(t,e){const n=e.hinting();return m("div.player.running",[m("div.no-square",m("piece.king."+t.turnColor())),m("div.instruction",(e.isMyTurn()?[m("strong",t.trans.noarg("yourTurn"))]:[m("strong",t.trans.noarg("computerThinking")),_l(e.currentNode(),e.playableDepth())]).concat(m("div.choices",[e.isMyTurn()?m("a",{hook:S("click",(()=>t.practice.hint()),e.redraw)},t.trans.noarg(n?"piece"===n.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function Dl(t){const e=t.practice;if(!e)return;const n=e.comment(),o=e.running(),r=e.currentNode().threefold?{winner:void 0}:t.outcome();return m("div.practice-box.training-box.sub-box."+(n?n.verdict:"no-verdict"),[m("div.title",t.trans.noarg("practiceWithComputer")),m("div.feedback",o?r?$l(t,r):Nl(t,e):Il(t,e)),o?m("div.comment",n?[m("span.verdict",t.trans.noarg(n.verdict))," "].concat(Tl(n,t,e)):[e.isMyTurn()||r?"":m("span.wait",t.trans.noarg("evaluatingYourMove"))]):o?m("div.comment"):null])}function ql(t){return m("div.choices",[m("a",{hook:S("click",t.viewSolution,t.redraw)},t.noarg("viewTheSolution")),m("a",{hook:S("click",t.skip)},t.noarg("skipThisMove"))])}function Ol(t){return m("a.half.continue",{hook:S("click",t.jumpToNext)},[m("i",{attrs:E("")}),t.noarg("next")])}function Rl(t){return m("div.progress",m("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}}))}const Ll={find:t=>[m("div.player",[m("div.no-square",m("piece.king."+t.color)),m("div.instruction",[m("strong",t.trans.vdom("xWasPlayed",m("move",Cr({withDots:!0,showGlyphs:!0,showEval:!1},t.current().fault.node)))),m("em",t.noarg("white"===t.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),ql(t)])])],offTrack:t=>[m("div.player",[m("div.icon.off","!"),m("div.instruction",[m("strong",t.noarg("youBrowsedAway")),m("div.choices.off",[m("a",{hook:S("click",t.jumpToNext)},t.noarg("resumeLearning"))])])])],fail:t=>[m("div.player",[m("div.icon","✗"),m("div.instruction",[m("strong",t.noarg("youCanDoBetter")),m("em",t.noarg("white"===t.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),ql(t)])])],win:t=>[m("div.half.top",m("div.player",[m("div.icon","✓"),m("div.instruction",m("strong",t.noarg("goodMove")))])),Ol(t)],view:t=>[m("div.half.top",m("div.player",[m("div.icon","✓"),m("div.instruction",[m("strong",t.noarg("solution")),m("em",t.trans.vdom("bestWasX",m("strong",Cr({withDots:!0,showEval:!1},t.current().solution.node))))])])),Ol(t)],eval:t=>[m("div.half.top",m("div.player.center",[m("div.instruction",[m("strong",t.noarg("evaluatingYourMove")),Rl(t.node())])]))],end(t,e){if(!e())return[m("div.half.top",m("div.player",[m("div.icon",ye()),m("div.instruction",t.noarg("waitingForAnalysis"))]))];const n=!t.completion()[1];return[m("div.player",[m("div.no-square",m("piece.king."+t.color)),m("div.instruction",[m("em",n?t.noarg("white"===t.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack"):t.noarg("white"===t.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),m("div.choices.end",[n?null:m("a",{hook:S("click",t.reset)},t.noarg("doItAgain")),m("a",{hook:S("click",t.flip)},t.noarg("white"===t.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function Fl(t,e){const n=t.retro,o=n.current();return n.isSolving()&&o&&t.path!==o.prev.path?Ll.offTrack(n):"find"===e?o?Ll.find(n):Ll.end(n,t.hasFullComputerAnalysis):Ll[e](n)}function Bl(t){const e=t.retro;if(!e)return;const n=e.feedback(),o=e.completion();return m("div.retro-box.training-box.sub-box",[m("div.title",[m("span",e.noarg("learnFromYourMistakes")),m("span",`${Math.min(o[0]+1,o[1])} / ${o[1]}`),m("button.fbt",{hook:S("click",t.toggleRetro,t.redraw),attrs:{"data-icon":"","aria-label":"Close learn window"}})]),m("div.feedback."+n,Fl(t,n))])}function jl(t){const e="deviation";return m("div.deviation",[m("div.legend.todo",{class:{done:Vl(t.node,e).length>2}},[Pe(""),m("p","When any other wrong move is played:")]),m("textarea",{attrs:{placeholder:"Explain why all other moves are wrong"},hook:Hl(t,e)})])}function zl(t){return m("div.hint",[m("div.legend",[Pe(""),m("p","Optional, on-demand hint for the player:")]),m("textarea",{attrs:{placeholder:"Give the player a tip so they can find the right move"},hook:Hl(t,"hint")})])}const Gl=Ne(500,((t,e)=>{t.socket.send("setGamebook",{path:t.path,ch:t.study.vm.chapterId,gamebook:e}),t.redraw()}));function Vl(t,e){return t.gamebook&&t.gamebook[e]||""}function Hl(t,e){const n=Vl(t.node,e);return{insert(o){const r=o.elm;r.value=n,r.oninput=()=>{const n=t.node;n.gamebook=n.gamebook||{},n.gamebook[e]=r.value.trim(),Gl(t,n.gamebook)},o.data.path=t.path},postpatch(e,o){e.data.path!==t.path&&(o.elm.value=n),o.data.path=t.path}}}function Wl(t){const e=t.state,n=()=>({attrs:{type:"button"},hook:S("click",t.hint,t.redraw)});return e.showHint?m("button",n(),[m("div.hint",{hook:lt(e.hint)})]):e.hint?m("button.hint",n(),t.trans.noarg("getAHint")):void 0}function Ul(t,e){const n=e.feedback,o=t.root.turnColor();return"bad"===n?m("button.feedback.act.bad"+(e.comment?".com":""),{attrs:{type:"button"},hook:S("click",t.retry)},[Pe(""),m("span",t.trans.noarg("retry"))]):"good"===n&&e.comment?m("button.feedback.act.good.com",{attrs:{type:"button"},hook:S("click",t.next)},[m("span.text",{attrs:E("")},t.trans.noarg("next")),m("kbd","<space>")]):"end"===n?function(t){const e=t.root.study;return m("div.feedback.end",[e.nextChapter()?m("button.next.text",{attrs:{"data-icon":"",type:"button"},hook:S("click",e.goToNextChapter)},e.trans.noarg("nextChapter")):void 0,m("button.retry",{attrs:{"data-icon":"",type:"button"},hook:S("click",(()=>t.root.userJump("")),t.redraw)},e.trans.noarg("playAgain")),m("button.analyse",{attrs:{"data-icon":"",type:"button"},hook:S("click",(()=>e.setGamebookOverride("analyse")),t.redraw)},e.trans.noarg("analysis"))])}(t):m("div.feedback.info."+n+(e.init?".init":""),m("div","play"===n?[m("div.no-square",m("piece.king."+o)),m("div.instruction",[m("strong",t.trans.noarg("yourTurn")),m("em",t.trans.noarg("white"===o?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]:t.trans.noarg("goodMove")))}function Kl(t){const e=t.study;if(!e||t.embed)return;const n=e.data.chapter.tags,o={white:Nn(n,"white"),black:Nn(n,"black")},r=_c(t),i=!_n(e.data.chapter)&&t.turnColor(),s=cd(t);return["white","black"].map((e=>function(t,e,n,o,r,i,s){const a=Nn(t,`${r}title`),c=Nn(t,`${r}elo`),l=function(t,e){switch(Nn(t,"result")){case"1-0":return e?"1":"0";case"0-1":return e?"0":"1";case"1/2-1/2":return"1/2";default:return}}(t,"white"===r);return m("div.study__player.study__player-"+(s?"top":"bot"),{class:{ticking:i}},[m("div.left",[l&&m("span.result",l),m("span.info",[a&&m("span.utitle","BOT"==a?{attrs:{"data-bot":!0}}:{},a+" "),m("span.name",o[r]),c&&m("span.elo",c)])]),n[s?0:1],null==e?void 0:e["white"===r?0:1]])}(n,r,s,o,e,i===e,t.bottomColor()!==e)))}function Jl(t){var e,n;return t.members.canContribute()?m("div.relay-admin",{hook:x((t=>lichess.loadCssPath("analyse.relay-admin")))},[m("h2",[m("span.text",{attrs:E("")},"Broadcast manager"),m("a",{attrs:{href:`/broadcast/round/${t.id}/edit`,"data-icon":""}})]),(null===(e=t.data.sync)||void 0===e?void 0:e.url)||(null===(n=t.data.sync)||void 0===n?void 0:n.ids)?(t.data.sync.ongoing?Ql:Zl)(t):null,Xl(t)]):void 0}function Yl(t){return[t.moves?m("strong",""+t.moves):t.moves," new move"+(t.moves>1?"s":"")]}function Xl(t){var e,n;const o=function(){td||(td=window.Intl&&Intl.DateTimeFormat?new Intl.DateTimeFormat(document.documentElement.lang,{month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format:function(t){return t.toLocaleString()});return td}(),r=null===(e=t.data.sync)||void 0===e?void 0:e.url,i=((null===(n=t.data.sync)||void 0===n?void 0:n.log)||[]).slice(0).reverse().map((t=>{const e=t.error&&m("a",r?{attrs:{href:r,target:"_blank",rel:"noopener nofollow"}}:{},t.error);return m("div"+(e?".err":""),{key:t.at,attrs:E(e?"":"")},[m("div",[...e?[e]:Yl(t),m("time",o(new Date(t.at)))])])}));return t.loading()&&i.unshift(m("div.load",[m("i.ddloader"),"Polling source..."])),m("div.log",i)}function Ql(t){var e,n;const o=null===(e=t.data.sync)||void 0===e?void 0:e.url,r=null===(n=t.data.sync)||void 0===n?void 0:n.ids;return m("div.state.on.clickable",{hook:S("click",(e=>t.setSync(!1))),attrs:E("")},[m("div",o?["Connected to source",m("br"),o.replace(/https?:\/\//,"")]:r?["Connected to",m("br"),r.length," game(s)"]:[])])}function Zl(t){return m("div.state.off.clickable",{hook:S("click",(e=>t.setSync(!0))),attrs:E("")},[m("div.fat","Click to connect")])}let td;function ed(t,e){return m("div.analyse__moves.areplay",[t.embed&&t.study?m("div.chapter-name",t.study.currentChapter().name):null,cs(t,e)].concat(function(t){const e=(t,e)=>[m("div.result",t),m("div.status",e)];if(t.data.game.status.id>=30){let n;switch(t.data.game.winner){case"white":n="1-0";break;case"black":n="0-1";break;default:n="½-½"}const o=Ft(t.data,t.data.game.winner);return e(n,[Pc(t),o?" • "+t.trans("white"==o.color?"whiteIsVictorious":"blackIsVictorious"):null])}if(t.study){const n=Nn(t.study.data.chapter.tags,"result");return n&&"*"!==n?"1-0"===n?e(n,[t.trans.noarg("whiteIsVictorious")]):"0-1"===n?e(n,[t.trans.noarg("blackIsVictorious")]):e("½-½",[t.trans.noarg("draw")]):[]}return[]}(t)))}function nd(t){if(!t.ongoing&&t.data.userAnalysis)return t.redirecting?ye():m("div.copyables",[m("div.pair",[m("label.name","FEN"),m("input.copyable.autoselect.analyse__underboard__fen",{attrs:{spellCheck:!1},hook:{insert:e=>{const n=e.elm;n.value=I(t.fenInput)?t.fenInput:t.node.fen,n.addEventListener("change",(e=>{n.value!==t.node.fen&&n.reportValidity()&&t.changeFen(n.value.trim())})),n.addEventListener("input",(e=>{t.fenInput=n.value,n.setCustomValidity(yn(n.value.trim()).isOk?"":"Invalid FEN")}))},postpatch:(e,n)=>{const o=n.elm;I(t.fenInput)?o.value!=t.fenInput&&(o.value=t.fenInput):(o.value=t.node.fen,o.setCustomValidity(""))}}})]),m("div.pgn",[m("div.pair",[m("label.name","PGN"),m("textarea.copyable.autoselect",{attrs:{spellCheck:!1},hook:{...x((e=>{e.value=I(t.pgnInput)?t.pgnInput:yi(t),e.addEventListener("input",(e=>t.pgnInput=e.target.value))})),postpatch:(e,n)=>{n.elm.value=I(t.pgnInput)?t.pgnInput:yi(t)}}}),m("button.button.button-thin.action.text",{attrs:E(""),hook:S("click",(e=>{const n=$(".copyables .pgn textarea").val();n!==yi(t)&&t.changePgn(n)}),t.redraw)},t.trans.noarg("importPgn"))])])])}function od(t,e,n){return m("button.fbt",{class:{disabled:!n},attrs:{"data-act":e,"data-icon":t}})}function rd(t){const e=""!==t.path,n=!!t.node.children[0],o=t.actionMenu.open,r=t.trans.noarg;return m("div.analyse__controls.analyse-controls",{hook:x((e=>{!function(t,e,n){for(const o of["touchstart","mousedown"])t.addEventListener(o,(t=>{e(t),t.preventDefault(),n&&n()}),{passive:!1})}(e,(e=>{const n=function(t){const e=t.target;return e.getAttribute("data-act")||e.parentNode.getAttribute("data-act")}(e);"prev"===n||"next"===n?function(t,e,n){const o=function(){he[e](t),t.redraw(),r=Math.max(100,r-r/15),i=setTimeout(o,r)};let r=350,i=setTimeout(o,500);he[e](t);const s="touchstart"==n.type?"touchend":"mouseup";document.addEventListener(s,(()=>clearTimeout(i)),{once:!0})}(t,n,e):"first"===n?le(t):"last"===n?ce(t):"explorer"===n?t.toggleExplorer():"practice"===n?t.togglePractice():"menu"===n&&t.actionMenu.toggle()}),t.redraw)}))},[t.embed?null:m("div.features",t.studyPractice?[m("a.fbt",{attrs:{title:r("analysis"),target:"_blank",rel:"noopener",href:t.studyPractice.analysisUrl(),"data-icon":""}})]:[m("button.fbt",{attrs:{title:r("openingExplorerAndTablebase"),"data-act":"explorer","data-icon":""},class:{hidden:o||!t.explorer.allowed()||!!t.retro,active:t.explorer.enabled()}}),t.ceval.possible&&t.ceval.allowed()&&!t.isGamebook()?m("button.fbt",{attrs:{title:r("practiceWithComputer"),"data-act":"practice","data-icon":""},class:{hidden:o||!!t.retro,active:!!t.practice}}):null]),m("div.jumps",[od("","first",e),od("","prev",e),od("","next",n),od("","last",n)]),t.studyPractice?m("div.noop"):m("button.fbt",{class:{active:o},attrs:{title:r("menu"),"data-act":"menu","data-icon":""}})])}function id(t,e){2===t.data.pref.coords&&$("body").toggleClass("coords-in",e).toggleClass("coords-out",!e)}function sd(t,e){return e+(t&&t.data.chapter?"."+t.data.chapter.id:"")}function ad(t){if(t.ceval.possible&&t.ceval.allowed())return m("div.comp-off__hint",[m("span",t.trans.noarg("computerAnalysisDisabled")),m("button",{hook:S("click",t.toggleComputer,t.redraw),attrs:{type:"button"}},t.trans.noarg("enable"))])}function cd(t){var e;const n=null===(e=t.chessground)||void 0===e?void 0:e.state,o=n?n.pieces:xa(t.node.fen);return Sc(!!t.data.pref.showCaptured,t.bottomColor(),o,!(!t.data.player.checks&&!t.data.opponent.checks),t.nodeList,t.node.ply)}function ld(t,e,n){return m("div.analyse__player_strip."+t,[e,n])}function dd(t){if(t.nvui)return t.nvui.render(t);const e=function(t){const e=t.study&&void 0!==t.study.data.chapter.conceal?{owner:t.study.isChapterOwner(),ply:t.study.data.chapter.conceal}:null;if(e)return n=>(o,r)=>!e||n&&e.ply>=r.ply||Gt(t.path,o)?null:e.owner?"conceal":"hide"}(t),n=t.study,o=!(t.retro&&t.retro.isSolving()||t.practice),r=t.actionMenu.open,i=t.gamebookPlay(),s=i&&function(t){const e=t.state;return m("div.gamebook",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.play")}},[e.comment||"play"==e.feedback||"end"==e.feedback?m("div.comment",{class:{hinted:e.showHint}},[e.comment?m("div.content",{hook:lt(e.comment)}):m("div.content","play"==e.feedback?t.trans("whatWouldYouPlay"):"end"==e.feedback?t.trans("youCompletedThisLesson"):void 0),Wl(t)]):void 0,m("div.floor",[Ul(t,e),m("img.mascot",{attrs:{width:120,height:120,src:lichess.assetUrl("images/mascot/octopus.svg")}})])])}(i),a=function(t){return!!t.study&&t.study.data.chapter.gamebook&&!t.gamebookPlay()&&"analyse"!==t.study.vm.gamebookOverride}(t)?function(t){const e=t.study,n=t.turnColor()===t.data.orientation,o=!!(t.node.comments||[]).find((t=>t.text.length>2)),r=t.tree.parentNode(t.path).children.length>1;let i;const s=S("click",(()=>{e.commentForm.start(e.vm.chapterId,t.path,t.node),e.vm.toolTab("comments"),lichess.requestIdleCallback((()=>$("#comment-text").each((function(){this.focus()}))),500)}),t.redraw);return i=t.path?t.onMainline?n?[m("div.legend.todo.clickable",{hook:s,class:{done:o}},[Pe(""),m("p","Explain the opponent move, and help the player find the next move, with a comment.")]),zl(t)]:[m("div.legend.clickable",{hook:s},[Pe(""),m("p","You may reflect on the player's correct move, with a comment; or leave empty to jump immediately to the next move.")]),r?null:m("div.legend.clickable",{hook:S("click",(()=>ae(t)),t.redraw)},[Pe(""),m("p","Add variation moves to explain why specific other moves are wrong.")]),jl(t)]:[m("div.legend.todo.clickable",{hook:s,class:{done:o}},[Pe(""),m("p","Explain why this move is wrong in a comment")]),m("div.legend",[m("p","Or promote it as the mainline if it is the right move.")])]:n?[m("div.legend.todo.clickable",{hook:s,class:{done:o}},[Pe(""),m("p","Help the player find the initial move, with a comment.")]),zl(t)]:[m("div.legend.clickable",{hook:s},[Pe(""),m("p","Introduce the gamebook with a comment")]),m("div.legend.todo",{class:{done:!!t.node.children[0]}},[Pe(""),m("p","Put the opponent's first move on the board.")])],m("div.gamebook-edit",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.edit")}},i)}(t):void 0,c=Kl(t),l=!c&&function(t){if(t.embed)return;const e=_c(t),n=t.bottomIsWhite(),o=cd(t);return[ld("top",o[0],null==e?void 0:e[n?1:0]),ld("bottom",o[1],null==e?void 0:e[n?0:1])]}(t),d=t.showEvalGauge(),u=!!d||!!c,h=function(t){const e=t.study,n=null==e?void 0:e.relay;if(e&&(null==n?void 0:n.tourShow.active)){const o=null==n?void 0:n.currentRound();return m("div.relay-tour",[m("div.relay-tour__text",[m("h1",n.data.tour.name),m("div.relay-tour__round",[m("strong",o.name)," ",o.ongoing?t.trans.noarg("playingRightNow"):o.startsAt?m("time.timeago",{hook:{insert(t){t.elm.setAttribute("datetime",""+o.startsAt)}}},lichess.timeago(o.startsAt)):null]),n.data.tour.markup?m("div",{hook:st(n.data.tour.markup,(()=>n.data.tour.markup))}):m("div",n.data.tour.description),Vi(n)]),e.looksNew()?null:ii(e.multiBoard,e)])}}(t);return m("main.analyse.variant-"+t.data.game.variant.key,{hook:{insert:e=>{id(t,u),!!c!=$("body").hasClass("header-margin")&&requestAnimationFrame((()=>{$("body").toggleClass("header-margin",!!c),t.redraw()})),Vc(e.elm)},update(e,n){id(t,u)},postpatch(t,e){t.data.gaugeOn!==d&&document.body.dispatchEvent(new Event("chessground.resize")),e.data.gaugeOn=d}},class:{"comp-off":!t.showComputer(),"gauge-on":d,"has-players":!!c,"gamebook-play":!!s,"has-relay-tour":!!h,"analyse-hunter":t.opts.hunter,"analyse--wiki":!!t.wiki&&!t.study}},[t.keyboardHelp?ke(t):null,n?Yi(n):null,h||m(sd(n,"div.analyse__board.main-board"),{hook:"ontouchstart"in window||"0"==lichess.storage.get("scrollMoves")?void 0:M("wheel",(e=>function(t,e){if(t.gamebookPlay())return;const n=e.target;return"PIECE"===n.tagName||"SQUARE"===n.tagName||"CG-BOARD"===n.tagName?(e.preventDefault(),e.deltaY>0?se(t):e.deltaY<0&&ae(t),t.redraw(),!1):void 0}(t,e)))},[...l||[],c?c[t.bottomIsWhite()?1:0]:null,Al(t),c?c[t.bottomIsWhite()?0:1]:null,t.promotion.view("antichess"===t.data.game.variant.key)]),d&&!h?cr(t):null,r||h?null:Rc(t,t.topColor(),"top"),s||(h?null:m(sd(n,"div.analyse__tools"),[...r?[Ii(t)]:[t.showComputer()?lr(t):ad(t),o?mr(t):null,ed(t,e),a||Cs(t,e),Bl(t)||Dl(t)||pa(t)]])),r||h?null:Rc(t,t.bottomColor(),"bottom"),s||h?null:rd(t),t.embed||h?null:m("div.analyse__underboard",{hook:t.synthetic||Ot(t.data)?void 0:x((e=>function(t,e){$(t).replaceWith(e.opts.$underboard),$("#adv-chart").attr("id","acpl-chart");const n=e.data,o=$(".analyse__underboard__panels > div"),r=$(".analyse__underboard__menu"),i=$("#movetimes-chart"),s=document.querySelector(".analyse__underboard__fen"),a=t=>t.getSelectedPoints().forEach((t=>t.select(!1)));let c;function l(){return`<div id="acpl-chart-loader"><span>Stockfish 14.1<br>server analysis</span>${lichess.spinnerHtml}</div>`}function d(){if(lichess.advantageChart||lichess.AnalyseNVUI)return;const t=!n.treeParts[0].eval||!Object.keys(n.treeParts[0].eval).length,r=o.filter(".computer-analysis");$("#acpl-chart").length?t&&!$("#acpl-chart-loader").length&&r.append(l()):r.html('<div id="acpl-chart"></div>'+(t?l():"")),lichess.loadScript("javascripts/chart/acpl.js").then((function(){lichess.advantageChart(n,e.trans,$("#acpl-chart")[0])}))}lichess.AnalyseNVUI||(lichess.pubsub.on("analysis.comp.toggle",(t=>{setTimeout((function(){(t?r.find('[data-panel="computer-analysis"]'):r.find("span:eq(1)")).trigger("mousedown")}),50),t&&$("#acpl-chart").each(((t,e)=>e.highcharts.reflow()))})),lichess.pubsub.on("analysis.change",((t,e,n)=>{const o=$("#acpl-chart");if(t&&t!==c&&(s.value=t,c=t),o.length){const t=o[0].highcharts;t&&(n!=t.lastPly&&(!1===n?a(t):t.selectPly(n)),t.lastPly=n)}if(i.length){const t=i[0].highcharts;t&&(n!=t.lastPly&&(!1===n?a(t):t.selectPly(n)),t.lastPly=n)}})),lichess.pubsub.on("analysis.server.progress",(t=>{lichess.advantageChart?lichess.advantageChart.update&&lichess.advantageChart.update(t):d(),t.analysis&&!t.analysis.partial&&$("#acpl-chart-loader").remove()})));const u=lichess.storage.make("analysis.panel"),h=function(t){r.children(".active").removeClass("active"),r.find(`[data-panel="${t}"]`).addClass("active"),o.removeClass("active").filter("."+t).addClass("active"),"move-times"!=t&&!e.opts.hunter||lichess.movetimeChart||lichess.loadScript("javascripts/chart/movetime.js").then((()=>lichess.movetimeChart(n,e.trans,e.opts.hunter))),("computer-analysis"==t||e.opts.hunter)&&$("#acpl-chart").length&&setTimeout(d,200)};r.on("mousedown","span",(function(){const t=$(this).data("panel");u.set(t),h(t)}));const p=u.get();if(p&&r.children(`[data-panel="${p}"]`).filter((function(){const t=window.getComputedStyle(this).display;return!!t&&"none"!=t})).length)h(p);else{const t=r.children('[data-panel="ctable"]');(t.length?t:r.children(":first-child")).trigger("mousedown")}n.analysis||o.find("form.future-game-analysis").on("submit",(function(){return $(this).hasClass("must-login")?(confirm(e.trans("youNeedAnAccountToDoThat"))&&(location.href="/signup"),!1):(z(this.action,{method:this.method}).then((t=>{t.ok?d():t.text().then((t=>{t&&!t.startsWith("<!DOCTYPE html>")&&alert(t),lichess.reload()}))})),!1)})),o.on("click",".pgn",(function(){const t=window.getSelection(),e=document.createRange();e.selectNodeContents(this),t.removeAllRanges(),t.addRange(e)})),o.on("click",".embed-howto",(function(){const t=`<iframe src="${Ie()}/embed/${n.game.id}${location.hash}?theme=auto&bg=auto"\nwidth=600 height=397 frameborder=0></iframe>`;pe({content:$('<div><strong style="font-size:1.5em">'+$(this).html()+"</strong><br /><br /><pre>"+lichess.escapeHtml(t)+"</pre><br />"+t+'<br /><br /><a class="text" data-icon="" href="/developers#embed-game">Read more about embedding games</a></div>')})}))}(e,t)))},n?Xi(t):[nd(t)]),h?null:$c(t),t.embed?null:t.studyPractice?ji(n):m("aside.analyse__side",{hook:x((e=>{t.opts.$side&&t.opts.$side.length&&$(e).replaceWith(t.opts.$side),$(e).append($(".context-streamers").clone().removeClass("none"))}))},t.studyPractice?[ji(n)]:n?[Ji(n)]:[t.forecast?Bc(t,t.forecast):null,!t.synthetic&&Ot(t.data)?m("div.back-to-game",m("a.button.button-empty.text",{attrs:{href:fi(t.data,t.data.player.color),"data-icon":""}},t.trans.noarg("backToGame"))):null]),n&&n.relay&&Jl(n.relay),t.opts.chat&&m("section.mchat",{hook:x((e=>{var n;const o=t.opts.chat;null===(n=o.instance)||void 0===n||n.then((t=>t.destroy())),o.parseMoves=!0,o.instance=lichess.makeChat(o)}))}),t.embed?null:m("div.chat__members.none",{hook:x(lichess.watchers)})])}const ud=h([C,w]);function hd(t){t.element=document.querySelector("main.analyse"),t.trans=lichess.trans(t.i18n);const e=lichess.analysis=new yc(t,(function(){o=ud(o,dd(e))})),n=dd(e);t.element.innerHTML="";let o=ud(t.element,n);return function(){if("ontouchstart"in window)return;let t,e;const n=n=>{t=n.pageX,e=n.pageY};let o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),i=()=>r.toggleClass("hover"),s=()=>{Math.sqrt((o.pX-t)*(o.pX-t)+(o.pY-e)*(o.pY-e))<8?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,i()):(o.pX=t,o.pY=e,o.timeoutId=setTimeout(s,200))},a=function(t){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));const e=o.event="mousemove";if("mouseover"==t.type){if(o.isActive||t.buttons)return;o.pX=t.pageX,o.pY=t.pageY,r.off(e,n).on(e,n),o.timeoutId=setTimeout(s,200)}else{if(!o.isActive)return;r.off(e,n),o={},i()}};r.on("mouseover",a).on("mouseleave",a)}))}(),{socketReceive:e.socket.receive,path:()=>e.path,setChapter(t){e.study&&e.study.setChapter(t)}}}return window.Chessground=Ml,window.LichessChat=function(t,e){const n=h([C,w]),o=et(e,(function(){i=n(i,At(o))})),r=At(o);t.innerHTML="";let i=n(t,r);return o},t.boot=function(t){lichess.socket=new lichess.StrongSocket(t.data.url.socket,t.data.player.version,{params:{userTv:t.data.userTv&&t.data.userTv.id},receive(t,n){e.socketReceive(t,n)}}),t.$side=$(".analyse__side").clone(),t.$underboard=$(".analyse__underboard").clone(),t.socketSend=lichess.socket.send;const e=hd(t)},t.patch=ud,t.start=hd,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
